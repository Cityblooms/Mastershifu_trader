<!DOCTYPE html><html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forex & Synthetic Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{--bg:#0a0e17;--card:#131a2a;--accent:#3a86ff;--accent-hover:#2a76ef;--buy:#10b981;--sell:#ef4444;--text:#e2e8f0;--text-muted:#94a3b8;--border:#1e293b}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',system-ui,Segoe,Arial,sans-serif}
        body{background:var(--bg);color:var(--text);line-height:1.6}
        .container{max-width:1400px;margin:0 auto;padding:20px}
        header{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid var(--border);margin-bottom:20px;flex-wrap:wrap;gap:15px}
        .logo{display:flex;align-items:center;gap:10px}
        .logo h1{font-size:24px;font-weight:700}
        .logo span{color:var(--accent)}
        .controls{display:flex;gap:15px;align-items:center;flex-wrap:wrap}
        .btn{background:var(--card);border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;transition:all .2s;border:none}
        .btn:hover{background:var(--accent);color:white}
        .btn-primary{background:var(--accent);color:white}
        .btn-primary:hover{background:var(--accent-hover)}
        .status-indicator{display:flex;align-items:center;gap:8px;font-size:14px}
        .status-dot{width:10px;height:10px;border-radius:50%;background:var(--sell)}
        .status-dot.connected{background:var(--buy)}
        .dashboard{display:grid;grid-template-columns:1fr 320px;gap:20px}
        .main-panel{display:flex;flex-direction:column;gap:20px}
        .chart-container{background:var(--card);border-radius:10px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.12)}
        .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px}
        .chart-title{font-size:18px;font-weight:600}
        .timeframe-selector{display:flex;background:var(--bg);border-radius:6px;overflow:hidden}
        .timeframe{padding:6px 12px;font-size:13px;cursor:pointer}
        .timeframe.active{background:var(--accent)}
        .signals-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px}
        .signal-card{background:var(--card);border-radius:10px;padding:15px;border:1px solid var(--border)}
        .signal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .symbol{font-weight:700;font-size:16px}
        .direction{padding:4px 10px;border-radius:4px;font-size:12px;font-weight:600}
        .direction.buy{background:rgba(16,185,129,.12);color:var(--buy);border:1px solid rgba(16,185,129,.2)}
        .direction.sell{background:rgba(239,68,68,.12);color:var(--sell);border:1px solid rgba(239,68,68,.2)}
        .signal-meta{display:flex;justify-content:space-between;margin-bottom:10px;font-size:13px;color:var(--text-muted)}
        .strength-bar{height:6px;width:90px;background:var(--border);border-radius:4px;overflow:hidden}
        .strength-fill{height:100%;border-radius:4px}
        .strength-fill.high{background:var(--buy);width:85%}
        .strength-fill.medium{background:#f59e0b;width:60%}
        .strength-fill.low{background:var(--sell);width:35%}
        .sidebar{display:flex;flex-direction:column;gap:20px}
        .panel{background:var(--card);border-radius:10px;padding:20px;border:1px solid var(--border)}
        .panel-title{font-size:16px;font-weight:600;margin-bottom:12px}
        .symbols-list{max-height:340px;overflow-y:auto}
        .symbol-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
        .price-change.positive{color:var(--buy)}
        .price-change.negative{color:var(--sell)}
        .stat-card{background:var(--bg);border-radius:8px;padding:12px;text-align:center;border:1px solid var(--border)}
        .watchlist-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)}
        .alerts-list{display:flex;flex-direction:column;gap:10px}
        .alert-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)}
        .alert-icon{width:8px;height:8px;border-radius:50%;background:var(--accent)}
        .no-data{text-align:center;padding:18px;color:var(--text-muted);font-style:italic}
        @media(max-width:1024px){.dashboard{grid-template-columns:1fr}}@media(max-width:768px){header{flex-direction:column} .controls{width:100%;justify-content:space-between} .signals-grid{grid-template-columns:1fr} .chart-header{flex-direction:column;align-items:flex-start}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>Forex & <span>Synthetic</span> Dashboard</h1>
                <div class="api-status" id="apiStatus">AI: Online</div>
            </div>
            <div class="controls">
                <div class="status-indicator"><div class="status-dot connected" id="feedDot"></div><span id="feedText">Live (simulated)</span></div>
                <button class="btn" id="refreshBtn">üîÑ Refresh</button>
                <button class="btn btn-primary" id="subscribeBtn">üìä Subscribe All</button>
                <select class="btn" id="timeframeSelect">
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m" selected>15 Minutes</option>
                    <option value="1h">1 Hour</option>
                </select>
            </div>
        </header><div class="dashboard">
        <div class="main-panel">
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title" id="chartTitle">EUR/USD - 15 Minute Chart</div>
                    <div class="timeframe-selector">
                        <div class="timeframe active">Line</div>
                        <div class="timeframe">Candles</div>
                        <div class="timeframe">Area</div>
                    </div>
                </div>
                <canvas id="priceChart" height="320"></canvas>
            </div>

            <div class="panel">
                <div class="panel-title">üéØ Trading Signals (Crossover + RSI + AI)</div>
                <div class="signals-grid" id="signalsGrid">
                    <div class="no-data">Generating trading signals...</div>
                </div>
            </div>
        </div>

        <aside class="sidebar">
            <div class="panel">
                <div class="panel-title">üìà Symbols</div>
                <div class="symbols-list" id="symbolsList"></div>
            </div>

            <div class="panel">
                <div class="panel-title">üìä Performance</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value positive">72%</div></div>
                    <div class="stat-card"><div class="stat-label">Avg Return</div><div class="stat-value positive">2.4%</div></div>
                    <div class="stat-card"><div class="stat-label">Signals Today</div><div class="stat-value" id="signalsCount">0</div></div>
                    <div class="stat-card"><div class="stat-label">Active Trades</div><div class="stat-value">7</div></div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">‚≠ê Watchlist</div>
                <div class="watchlist" id="watchlist"></div>
            </div>

            <div class="panel">
                <div class="panel-title">üîî Recent Alerts</div>
                <div class="alerts-list" id="alertsList"><div class="no-data">No alerts yet</div></div>
            </div>
        </aside>
    </div>
</div>

<script>
// ----------------------
// CONFIG & DEFAULTS
// ----------------------
const CONFIG = {
    PRICE_HISTORY_LEN: 200,
    EMA_FAST: 9,
    EMA_SLOW: 21,
    RSI_PERIOD: 14,
    RSI_CONFIRM: true, // you confirmed: keep RSI confirmation
    RSI_BUY_THRESHOLD: 30,
    RSI_SELL_THRESHOLD: 70,
    STABILITY: 2,
    CACHE_KEY: 'forex_dashboard_v5',
    MAX_SIGNALS: 20,
    WEBSOCKET_SIM: true
};

// Default pairs (you asked for default list) ‚Äî mix of Forex, Metals, Crypto, Synthetic
const symbols = [
    { name: 'EUR/USD', type: 'Forex', price: 1.08542 },
    { name: 'GBP/USD', type: 'Forex', price: 1.26789 },
    { name: 'XAU/USD', type: 'Metal', price: 1975.23 },
    { name: 'VOLATILITY 75', type: 'Synthetic', price: 275.12 },
    { name: 'BTC/USD', type: 'Crypto', price: 46200.5 }
];

// state
let minuteCandles = {};
let signals = [];
let shownKeys = new Set();
let lastDirHistory = {};
let priceChart = null;

// ----------------------
// Initialize
// ----------------------
document.addEventListener('DOMContentLoaded', ()=>{
    initializeChart();
    initializePriceData();
    populateSymbolsList();
    populateWatchlist();
    setupEventListeners();
    loadCachedSignals();
    startSignalGeneration();
    startPriceUpdates();
    if (CONFIG.WEBSOCKET_SIM) startSimulatedWebsocket();
});

// ----------------------
// Chart
// ----------------------
function initializeChart(){
    const ctx = document.getElementById('priceChart').getContext('2d');
    const data = Array.from({length:60},(_,i)=>1.085 + (Math.random()-0.5)*0.002);
    priceChart = new Chart(ctx,{
        type:'line',data:{labels:data.map(()=>''),datasets:[{label:'price',data:data,borderColor:'#3a86ff',backgroundColor:'rgba(58,134,255,0.08)',fill:true,tension:0.3,borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}}
    });
}

// ----------------------
// Price Data (history)
// ----------------------
function initializePriceData(){
    symbols.forEach(sym=>{
        minuteCandles[sym.name]=[];
        let base = sym.price;
        for(let i=0;i<CONFIG.PRICE_HISTORY_LEN;i++){
            const vol=(Math.random()-0.5)*0.002; base = base*(1+vol);
            minuteCandles[sym.name].push({open:base,high:base*(1+Math.random()*0.001),low:base*(1-Math.random()*0.001),close:base,ts:Date.now()- (CONFIG.PRICE_HISTORY_LEN-i)*60000});
        }
    });
}

function addMinuteTick(symbol,price,ts=Date.now()){
    if(!minuteCandles[symbol]) minuteCandles[symbol]=[];
    const mins=minuteCandles[symbol];
    const minuteKey=Math.floor(ts/60000)*60000; const last=mins[mins.length-1];
    if(!last||last.ts!==minuteKey) mins.push({open:price,high:price,low:price,close:price,ts:minuteKey}); else { last.high=Math.max(last.high,price); last.low=Math.min(last.low,price); last.close=price; }
    if(mins.length>CONFIG.PRICE_HISTORY_LEN) mins.shift();
}

// ----------------------
// Indicators
// ----------------------
function calculateEMAArray(values,period){
    if(!values||values.length<period) return null;
    const k=2/(period+1);
    const out=[]; let ema=values.slice(0,period).reduce((a,b)=>a+b,0)/period; out[period-1]=ema;
    for(let i=period;i<values.length;i++){ ema = values[i]*k + ema*(1-k); out[i]=ema; }
    return out;
}

function calcRSI(values,period=CONFIG.RSI_PERIOD){
    if(!values||values.length<period+1) return 50;
    let gains=0,losses=0;
    for(let i=1;i<=period;i++){const d=values[i]-values[i-1]; if(d>0) gains+=d; else losses-=d;}
    let avgG=gains/period, avgL=losses/period;
    for(let i=period+1;i<values.length;i++){const d=values[i]-values[i-1]; avgG=(avgG*(period-1)+Math.max(0,d))/period; avgL=(avgL*(period-1)+Math.max(0,-d))/period;}
    if(avgL===0) return 100; const rs=avgG/avgL; return 100 - (100/(1+rs));
}

// ----------------------
// Crossover logic + multi-TF analysis
// ----------------------
function analyzeMultiTF(symbol){
    const mins=minuteCandles[symbol]; if(!mins||mins.length<CONFIG.EMA_SLOW+5) return null;
    const closes=mins.map(m=>m.close);
    const emaFastArr = calculateEMAArray(closes, CONFIG.EMA_FAST);
    const emaSlowArr = calculateEMAArray(closes, CONFIG.EMA_SLOW);
    if(!emaFastArr||!emaSlowArr) return null;
    const lastIdx = closes.length-1; const prevIdx = lastIdx-1;
    const prevFast = emaFastArr[prevIdx]||emaFastArr[prevIdx-1]; const prevSlow = emaSlowArr[prevIdx]||emaSlowArr[prevIdx-1];
    const currFast = emaFastArr[lastIdx]; const currSlow = emaSlowArr[lastIdx];
    let crossover = 'WAIT';
    if(prevFast < prevSlow && currFast > currSlow) crossover = 'BUY';
    if(prevFast > prevSlow && currFast < currSlow) crossover = 'SELL';

    const rsi = Math.round(calcRSI(closes)*10)/10;
    const currentPrice = closes[lastIdx];
    const emaDistance = Math.abs(currFast - currSlow) / currentPrice;
    const baseStrength = 50 + (emaDistance * 15000);
    const rsiBonus = (!CONFIG.RSI_CONFIRM) ? 10 : ((crossover==='BUY' && rsi < CONFIG.RSI_BUY_THRESHOLD) || (crossover==='SELL' && rsi > CONFIG.RSI_SELL_THRESHOLD) ? 20 : 0);
    const signalStrength = Math.min(95, Math.round(baseStrength + rsiBonus));

    return { symbol, direction: crossover, rsi, currentPrice, signalStrength, timestamp: new Date().toLocaleString(), id:`${symbol}_${Date.now()}` };
}

async function dualAIConfirm(signal){
    // Simulated AI confirmation - keep for UI and confidence metric
    await new Promise(r=>setTimeout(r, 200 + Math.random()*300));
    let c1 = 60 + signal.signalStrength*0.2 + (signal.direction==='BUY' ? (signal.rsi<CONFIG.RSI_BUY_THRESHOLD?10:0) : (signal.rsi>CONFIG.RSI_SELL_THRESHOLD?10:0));
    let c2 = 62 + signal.signalStrength*0.18 + (signal.direction==='BUY' ? (signal.rsi<CONFIG.RSI_BUY_THRESHOLD?12:0) : (signal.rsi>CONFIG.RSI_SELL_THRESHOLD?12:0));
    c1 = Math.min(98, Math.round(c1)); c2 = Math.min(98, Math.round(c2));
    const approved = c1 >= 70 && c2 >= 70 && signal.direction !== 'WAIT';
    return { approved, avgConfidence: Math.round((c1+c2)/2), chatGPT:{valid:c1>=70,confidence:c1,reason:c1>=70?`Crossover ${signal.direction} + RSI ${signal.rsi}`:'Weak setup'}, deepSeek:{valid:c2>=70,confidence:c2}};
}

async function processSymbolCandidate(symbol){
    try{
        const s = analyzeMultiTF(symbol); if(!s) return;
        if(s.direction==='WAIT') return;
        lastDirHistory[symbol]=lastDirHistory[symbol]||[]; lastDirHistory[symbol].push(s.direction); if(lastDirHistory[symbol].length>CONFIG.STABILITY) lastDirHistory[symbol].shift();
        const stable = lastDirHistory[symbol].length>=CONFIG.STABILITY && lastDirHistory[symbol].every(d=>d===s.direction);
        if(!stable) return;
        const key = `${s.symbol}_${s.direction}_${Math.round(s.currentPrice*1000)}`; if(shownKeys.has(key)) return;
        const ai = await dualAIConfirm(s);
        if(ai.approved){ s.aiValidated=true; s.aiValidation=ai; s.aiConfidence=ai.avgConfidence; shownKeys.add(key); signals.unshift(s); renderSignals(); addAlert(s.direction,s.symbol,`AI approved ${s.direction} (${ai.avgConfidence}%)`); updateSignalsCount(); }
    }catch(e){console.error(e)}
}

function startSignalGeneration(){
    // initial pass
    setTimeout(()=>{ symbols.forEach(sym=>{ if(Math.random()>0.3) processSymbolCandidate(sym.name); }); },1200);
    // continuous
    setInterval(()=>{ const r=symbols[Math.floor(Math.random()*symbols.length)]; processSymbolCandidate(r.name); },4000);
}

// ----------------------
// Prices updater & UI
// ----------------------
function startPriceUpdates(){ setInterval(()=>{ updateAllPrices(); updateChart(); }, 2500); }

function updateAllPrices(){
    symbols.forEach(sym=>{
        const c = minuteCandles[sym.name]; if(!c||c.length===0) return; const last = c[c.length-1]; const vol = (Math.random()-0.5)*0.003; const newPrice = last.close*(1+vol);
        addMinuteTick(sym.name,newPrice,Date.now()); sym.price=newPrice; sym.change = newPrice - last.close; sym.changePercent = (sym.change / newPrice) * 100;
    });
    populateSymbolsList(); populateWatchlist();
}

function updateChart(){ if(!priceChart) return; const ds = priceChart.data.datasets[0]; const last = ds.data[ds.data.length-1]; const next = last*(1+(Math.random()-0.5)*0.001); ds.data.push(next); ds.data.shift(); priceChart.update('none'); }

// ----------------------
// UI rendering
// ----------------------
function renderSignals(){ const grid=document.getElementById('signalsGrid'); if(!signals||signals.length===0){ grid.innerHTML='<div class="no-data">No trading signals at the moment</div>'; return; } const display=signals.slice(0,8);
    grid.innerHTML = display.map(s=>`<div class="signal-card"><div class="signal-header"><div class="symbol">${s.symbol}</div><div class="direction ${s.direction.toLowerCase()}">${s.direction}</div></div><div class="signal-meta"><div>Price: ${formatNumber(s.currentPrice)}</div><div>RSI: ${s.rsi}</div></div><div style="display:flex;align-items:center;gap:8px;margin-bottom:10px"><div class="strength-bar"><div class="strength-fill ${getStrengthClass(s.signalStrength)}" style="width:${Math.min(100,s.signalStrength)}%"></div></div><div>${s.signalStrength}%</div></div><div style="font-size:13px;color:var(--text-muted);margin-bottom:10px"><strong>AI:</strong> ${s.aiConfidence||'‚Äì'}% ¬∑ <strong>Time:</strong> ${s.timestamp}</div><div style="font-size:12px;color:var(--text-muted)">${s.aiValidation?.chatGPT?.reason||''}</div></div>`).join(''); }
function getStrengthClass(v){ if(v>=75) return 'high'; if(v>=60) return 'medium'; return 'low'; }
function formatNumber(n){ if(!isFinite(n)) return n; if(Math.abs(n)>=1000) return n.toFixed(2); return n.toFixed(5); }
function updateSignalsCount(){ document.getElementById('signalsCount').textContent = signals.length; }

function addAlert(type,symbol,message){ const list=document.getElementById('alertsList'); const now=new Date(); const time = now.getHours()+':'+now.getMinutes().toString().padStart(2,'0'); const no=list.querySelector('.no-data'); if(no) no.remove(); const el=document.createElement('div'); el.className='alert-item alert-'+type.toLowerCase(); el.innerHTML=`<div class="alert-icon"></div><div style="flex:1"><strong>${symbol}</strong>: ${message}</div><div style="font-size:12px;color:var(--text-muted)">${time}</div>`; list.insertBefore(el,list.firstChild); while(list.children.length>6) list.removeChild(list.lastChild); }

function populateSymbolsList(){ const el=document.getElementById('symbolsList'); el.innerHTML = symbols.map(s=>{ const ch = s.change>=0? 'positive':'negative'; const sign = s.change>=0?'+':''; return `<div class="symbol-item"><div><div class="symbol">${s.name}</div><div style="font-size:11px;color:var(--text-muted)">${s.type}</div></div><div class="price-change ${ch}">${sign}${formatNumber(s.change||0)}<br><small>(${sign}${(s.changePercent||0).toFixed(2)}%)</small></div></div>` }).join(''); }
function populateWatchlist(){ const w=document.getElementById('watchlist'); const list = symbols.slice(0,4); w.innerHTML = list.map(s=>`<div class="watchlist-item"><div>${s.name}</div><div>${formatNumber(s.price)}</div><div style="font-size:12px;color:var(--text-muted)">${(s.change||0).toFixed(4)}</div></div>`).join(''); }

// ----------------------
// Caching
// ----------------------
function loadCachedSignals(){ try{ const c=localStorage.getItem(CONFIG.CACHE_KEY); if(c){ signals = JSON.parse(c).slice(0,CONFIG.MAX_SIGNALS); renderSignals(); updateSignalsCount(); } }catch(e){console.error(e)} }
function saveSignalsToCache(){ try{ localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify(signals.slice(0,CONFIG.MAX_SIGNALS))); }catch(e){console.error(e)} }

// ----------------------
// Events
// ----------------------
function setupEventListeners(){
    document.getElementById('refreshBtn').addEventListener('click',function(){ this.classList.add('loading'); this.textContent='üîÑ Refreshing...'; setTimeout(()=>{ updateAllPrices(); this.classList.remove('loading'); this.textContent='üîÑ Refresh'; addAlert('info','System','Data refreshed'); },900); });
    document.getElementById('subscribeBtn').addEventListener('click',function(){ addAlert('info','System','Subscribed to symbols'); this.textContent='‚úÖ Subscribed'; setTimeout(()=>this.textContent='üìä Subscribe All',2000); });
    document.getElementById('timeframeSelect').addEventListener('change',function(){ const txt=this.options[this.selectedIndex].text; document.getElementById('chartTitle').textContent = `EUR/USD - ${txt} Chart`; addAlert('info','Chart',`Timeframe ${txt}`); });
    const tfs = document.querySelectorAll('.timeframe'); tfs.forEach(tf=>tf.addEventListener('click',function(){ tfs.forEach(x=>x.classList.remove('active')); this.classList.add('active'); }));
    setInterval(saveSignalsToCache,10000);
}

// ----------------------
// Simulated websocket / incoming alerts
// ----------------------
function startSimulatedWebsocket(){
    setInterval(()=>{
        const s = symbols[Math.floor(Math.random()*symbols.length)]; const last = minuteCandles[s.name][minuteCandles[s.name].length-1]; const tick = last.close*(1+(Math.random()-0.5)*0.0015);
        addMinuteTick(s.name,tick,Date.now()); s.price = tick; s.change = tick - last.close; s.changePercent = (s.change/tick)*100; populateSymbolsList(); populateWatchlist();
        if(Math.random()>0.86) simulateIncomingAlert({symbol:s.name,price:tick,source:'sim'});
    },1200);
}

function simulateIncomingAlert(payload){ addAlert('info',payload.symbol,`Incoming ${payload.source}`); processSymbolCandidate(payload.symbol); }

// public hook for real webhooks forwarded via server or websocket
window.receiveWebhook = function(payload){ simulateIncomingAlert(payload); };

// ----------------------
// Export CSV helper
// ----------------------
function downloadSignalsCSV(){ if(!signals.length){ alert('No signals'); return; } const header='symbol,direction,price,rsi,strength,aiConfidence,timestamp'; const rows = signals.map(s=>`${s.symbol},${s.direction},${s.currentPrice},${s.rsi},${s.signalStrength},${s.aiConfidence||''},${s.timestamp}`); const csv=[header].concat(rows).join('

'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='signals.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); } window.downloadSignalsCSV = downloadSignalsCSV; </script>

</body>
</html>
