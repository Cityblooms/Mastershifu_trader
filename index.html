<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrendIQ Pro - Advanced Trading Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Simplified ML integration to avoid TensorFlow.js errors -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #ebfc02;
            --primary-dark: #d4e502;
            --secondary: #0f172a;
            --secondary-light: #1e293b;
            --accent: #3b82f6;
            --buy: #10b981;
            --sell: #ef4444;
            --text: #e2e8f0;
            --text-dim: #94a3b8;
        }
        
        body {
            background: linear-gradient(135deg, var(--secondary) 0%, #0a0f1a 100%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            padding: 10px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            padding-bottom: 20px;
        }
        
        /* Header */
        .header {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-left h1 {
            color: var(--primary);
            font-size: clamp(24px, 3vw, 32px);
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-left .tagline {
            color: var(--text-dim);
            font-size: clamp(12px, 1.5vw, 14px);
            margin-top: 5px;
        }
        
        .pair-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .pair-selector label {
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
        }
        
        select {
            background: var(--secondary);
            color: var(--text);
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            min-width: 200px;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23ebfc02' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 45px;
        }
        
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(235, 252, 2, 0.2);
        }
        
        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 400px;
            gap: 15px;
            min-height: 70vh;
        }
        
        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Chart Container */
        .chart-container {
            grid-column: span 2;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            height: 65vh;
            position: relative;
            overflow: hidden;
        }
        
        @media (max-width: 1400px) {
            .chart-container {
                grid-column: span 1;
            }
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .timeframe-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .timeframe-btn {
            padding: 8px 16px;
            background: rgba(51, 65, 85, 0.6);
            color: var(--text-dim);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            min-width: 50px;
            text-align: center;
        }
        
        .timeframe-btn.active {
            background: var(--primary);
            color: var(--secondary);
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .chart-btn {
            padding: 8px 16px;
            background: rgba(51, 65, 85, 0.6);
            color: var(--text);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .chart-btn:hover {
            background: rgba(71, 85, 105, 0.8);
        }
        
        /* Controls Panel */
        .controls-panel {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            max-height: 65vh;
        }
        
        /* Panel Sections */
        .panel-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .panel-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Control Groups */
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .control-value {
            color: var(--primary);
            font-weight: 700;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #334155 0%, var(--primary) 100%);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* Buttons */
        .buttons-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--secondary);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(235, 252, 2, 0.3);
        }
        
        .btn-secondary {
            background: rgba(51, 65, 85, 0.8);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-secondary:hover {
            background: rgba(71, 85, 105, 0.8);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--buy) 0%, #0da271 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--sell) 0%, #dc2626 100%);
            color: white;
        }
        
        /* Signals Container */
        .signals-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .signal-card {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .signal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: currentColor;
        }
        
        .signal-buy {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
            border-color: var(--buy);
            color: var(--buy);
        }
        
        .signal-sell {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
            border-color: var(--sell);
            color: var(--sell);
        }
        
        .signal-card.active {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .signal-pulse {
            animation: pulse 2s infinite;
        }
        
        .signal-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .signal-value {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        /* Status Indicators */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-card {
            padding: 15px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .status-title {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
        }
        
        .trend-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .trend-up {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%);
            color: var(--buy);
            border: 2px solid var(--buy);
        }
        
        .trend-down {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
            color: var(--sell);
            border: 2px solid var(--sell);
        }
        
        .trend-neutral {
            background: linear-gradient(135deg, rgba(148, 163, 184, 0.2) 0%, rgba(148, 163, 184, 0.1) 100%);
            color: var(--text-dim);
            border: 2px solid var(--text-dim);
        }
        
        /* Alert Banner */
        .alert-banner {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px;
            border-radius: 12px;
            background: var(--secondary-light);
            border-left: 6px solid var(--primary);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 400px;
            display: none;
            animation: slideIn 0.5s ease;
        }
        
        .alert-buy {
            border-left-color: var(--buy);
        }
        
        .alert-sell {
            border-left-color: var(--sell);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 16px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(235, 252, 2, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Multi-timeframe Analysis */
        .mtf-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .mtf-card {
            padding: 12px;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
        }
        
        .mtf-title {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        
        .mtf-value {
            font-size: 16px;
            font-weight: 800;
        }
        
        .mtf-buy { color: var(--buy); }
        .mtf-sell { color: var(--sell); }
        .mtf-neutral { color: var(--text-dim); }
        
        /* Broker Integration */
        .broker-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        /* Price Display */
        .current-price {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .price-change {
            font-size: 14px;
            font-weight: 600;
        }
        
        .positive {
            color: var(--buy);
        }
        
        .negative {
            color: var(--sell);
        }
        
        /* Chart Tooltip */
        .chart-tooltip {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            color: var(--text);
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                align-items: stretch;
            }
            
            .pair-selector {
                justify-content: space-between;
            }
            
            select {
                flex: 1;
                min-width: 0;
            }
            
            .chart-container {
                height: 50vh;
                padding: 15px;
            }
            
            .controls-panel {
                max-height: 50vh;
            }
            
            .buttons-grid {
                grid-template-columns: 1fr;
            }
            
            .signal-value {
                font-size: 24px;
            }
            
            .status-value {
                font-size: 18px;
            }
            
            .mtf-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .main-grid {
                gap: 10px;
            }
            
            .panel-section {
                padding: 15px;
            }
            
            .signal-card, .status-card {
                padding: 12px;
            }
            
            .mtf-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .timeframe-selector {
                justify-content: center;
            }
            
            .chart-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
        
        /* Touch-friendly sizes */
        button, 
        select, 
        .timeframe-btn,
        .chart-btn {
            min-height: 44px;
        }
        
        input[type="range"] {
            height: 12px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            width: 28px;
            height: 28px;
        }
        
        /* Custom Chart.js styling */
        .chartjs-render-monitor {
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="header-left">
                    <h1><i class="fas fa-brain"></i> TrendIQ Pro</h1>
                    <p class="tagline">Advanced Trading System with Real Signals & ML Validation</p>
                </div>
                <div class="pair-selector">
                    <label for="pairSelect"><i class="fas fa-chart-line"></i> Asset:</label>
                    <select id="pairSelect">
                        <option value="btcusd">BTC/USD (Bitcoin)</option>
                        <option value="gold">Gold (XAU/USD)</option>
                        <option value="eurusd">EUR/USD</option>
                        <option value="us30">US30 (Dow Jones)</option>
                        <option value="jump25">Jump 25 (High Vol)</option>
                        <option value="jump10">Jump 10 (Medium Vol)</option>
                        <option value="jump50">Jump 50 (Extreme Vol)</option>
                    </select>
                </div>
            </div>
            
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-title">Market Status</div>
                    <div class="status-value" id="marketStatus">CONNECTED</div>
                </div>
                <div class="status-card">
                    <div class="status-title">Current Price</div>
                    <div class="current-price" id="currentPrice">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-grid">
            <!-- Chart Container -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="timeframe-selector">
                        <button class="timeframe-btn active" data-tf="5m">5M</button>
                        <button class="timeframe-btn" data-tf="15m">15M</button>
                        <button class="timeframe-btn" data-tf="1h">1H</button>
                        <button class="timeframe-btn" data-tf="4h">4H</button>
                        <button class="timeframe-btn" data-tf="1d">1D</button>
                    </div>
                    <div class="chart-controls">
                        <button class="chart-btn" id="toggleIndicators"><i class="fas fa-layer-group"></i> Indicators</button>
                        <button class="chart-btn" id="toggleVolume"><i class="fas fa-chart-bar"></i> Volume</button>
                        <button class="chart-btn" id="fullscreenBtn"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
                
                <div class="loading-overlay" id="chartLoading">
                    <div class="spinner"></div>
                    <p>Loading market data...</p>
                </div>
                
                <canvas id="priceChart"></canvas>
                
                <div class="mtf-grid" id="mtfAnalysis">
                    <!-- Multi-timeframe analysis will be populated here -->
                </div>
            </div>
            
            <!-- Controls Panel -->
            <div class="controls-panel">
                <!-- Signal Panel -->
                <div class="panel-section">
                    <div class="panel-title"><i class="fas fa-bolt"></i> Live Signals</div>
                    
                    <div class="signals-grid">
                        <div class="signal-card signal-buy" id="buySignalCard">
                            <div class="signal-title">BUY SIGNAL</div>
                            <div class="signal-value" id="buyCount">0</div>
                            <div class="signal-detail" id="buyDetail">Waiting for signal...</div>
                        </div>
                        
                        <div class="signal-card signal-sell" id="sellSignalCard">
                            <div class="signal-title">SELL SIGNAL</div>
                            <div class="signal-value" id="sellCount">0</div>
                            <div class="signal-detail" id="sellDetail">Waiting for signal...</div>
                        </div>
                    </div>
                    
                    <div class="status-grid">
                        <div class="status-card">
                            <div class="status-title">Current Trend</div>
                            <div class="trend-indicator trend-neutral" id="trendDirection">NEUTRAL</div>
                        </div>
                        <div class="status-card">
                            <div class="status-title">Signal Strength</div>
                            <div class="status-value" id="signalStrength">-</div>
                        </div>
                    </div>
                    
                    <div class="buttons-grid">
                        <button class="btn-success" id="executeBuy">
                            <i class="fas fa-shopping-cart"></i> Execute Buy
                        </button>
                        <button class="btn-danger" id="executeSell">
                            <i class="fas fa-chart-line"></i> Execute Sell
                        </button>
                    </div>
                </div>
                
                <!-- Settings Panel -->
                <div class="panel-section">
                    <div class="panel-title"><i class="fas fa-sliders-h"></i> Indicator Settings</div>
                    
                    <div class="control-group">
                        <div class="control-header">
                            <span>ATR Period</span>
                            <span class="control-value" id="atrValue">14</span>
                        </div>
                        <input type="range" id="atrSlider" min="5" max="50" value="14" step="1">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-header">
                            <span>BB Period</span>
                            <span class="control-value" id="bbPeriodValue">20</span>
                        </div>
                        <input type="range" id="bbPeriodSlider" min="10" max="50" value="20" step="1">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-header">
                            <span>BB Deviation</span>
                            <span class="control-value" id="bbDeviationValue">2.0</span>
                        </div>
                        <input type="range" id="bbDeviationSlider" min="1.0" max="3.0" value="2.0" step="0.1">
                    </div>
                    
                    <div class="buttons-grid">
                        <button class="btn-secondary" id="resetBtn">
                            <i class="fas fa-redo"></i> Reset Defaults
                        </button>
                        <button class="btn-primary" id="applyBtn">
                            <i class="fas fa-play"></i> Apply Settings
                        </button>
                    </div>
                </div>
                
                <!-- Broker Panel -->
                <div class="panel-section broker-section">
                    <div class="panel-title"><i class="fas fa-exchange-alt"></i> Trading</div>
                    
                    <div class="control-group">
                        <div class="control-header">
                            <span>Position Size</span>
                            <span class="control-value" id="positionSize">0.1</span>
                        </div>
                        <input type="range" id="positionSlider" min="0.01" max="10" value="0.1" step="0.01">
                    </div>
                    
                    <div class="status-grid">
                        <div class="status-card">
                            <div class="status-title">Account Balance</div>
                            <div class="status-value" id="accountBalance">$10,000</div>
                        </div>
                        <div class="status-card">
                            <div class="status-title">Risk/Reward</div>
                            <div class="status-value" id="riskReward">1:2</div>
                        </div>
                    </div>
                    
                    <div class="buttons-grid">
                        <button class="btn-secondary" id="connectBroker">
                            <i class="fas fa-plug"></i> Connect Demo
                        </button>
                        <button class="btn-primary" id="autoTrade">
                            <i class="fas fa-robot"></i> Auto Trade
                        </button>
                    </div>
                </div>
                
                <!-- ML Validation Panel -->
                <div class="panel-section">
                    <div class="panel-title"><i class="fas fa-robot"></i> AI Analysis</div>
                    
                    <div class="status-grid">
                        <div class="status-card">
                            <div class="status-title">ML Confidence</div>
                            <div class="status-value" id="mlConfidence">85%</div>
                        </div>
                        <div class="status-card">
                            <div class="status-title">Pattern Match</div>
                            <div class="status-value" id="patternMatch">92%</div>
                        </div>
                    </div>
                    
                    <div class="buttons-grid">
                        <button class="btn-secondary" id="analyzeMarket">
                            <i class="fas fa-chart-bar"></i> Analyze
                        </button>
                        <button class="btn-primary" id="validateSignal">
                            <i class="fas fa-check-circle"></i> Validate
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Alert Banner -->
        <div class="alert-banner" id="alertBanner">
            <div class="alert-content">
                <h4 id="alertTitle">Signal Alert</h4>
                <p id="alertMessage">New trading signal detected</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // TRENDIQ PRO - FIXED VERSION
        // ============================================
        
        // Trading Pairs Configuration
        const TRADING_PAIRS = {
            'btcusd': {
                name: 'Bitcoin (BTC/USD)',
                basePrice: 42000,
                volatility: 0.025,
                atrMultiplier: 1.5,
                bbDeviation: 2.2,
                color: '#F7931A'
            },
            'gold': {
                name: 'Gold (XAU/USD)',
                basePrice: 1950,
                volatility: 0.012,
                atrMultiplier: 1.2,
                bbDeviation: 2.4,
                color: '#FFD700'
            },
            'eurusd': {
                name: 'EUR/USD',
                basePrice: 1.0850,
                volatility: 0.006,
                atrMultiplier: 0.8,
                bbDeviation: 2.0,
                color: '#00CED1'
            },
            'us30': {
                name: 'US30 (Dow Jones)',
                basePrice: 35000,
                volatility: 0.009,
                atrMultiplier: 1.0,
                bbDeviation: 2.2,
                color: '#32CD32'
            },
            'jump25': {
                name: 'Jump 25 (High Vol)',
                basePrice: 100,
                volatility: 0.025,
                atrMultiplier: 1.8,
                bbDeviation: 2.8,
                color: '#FF4500'
            },
            'jump10': {
                name: 'Jump 10 (Medium Vol)',
                basePrice: 50,
                volatility: 0.01,
                atrMultiplier: 1.2,
                bbDeviation: 2.4,
                color: '#9370DB'
            },
            'jump50': {
                name: 'Jump 50 (Extreme Vol)',
                basePrice: 200,
                volatility: 0.05,
                atrMultiplier: 2.5,
                bbDeviation: 3.5,
                color: '#FF1493'
            }
        };
        
        // Application State
        class TradingState {
            constructor() {
                this.currentPair = 'btcusd';
                this.timeframe = '5m';
                this.atrPeriod = 14;
                this.bbPeriod = 20;
                this.bbDeviation = 2.0;
                this.showVolume = true;
                this.showIndicators = true;
                this.positionSize = 0.1;
                this.accountBalance = 10000;
                this.brokerConnected = false;
                this.autoTrading = false;
                
                // Data
                this.priceData = [];
                this.highData = [];
                this.lowData = [];
                this.volumeData = [];
                this.timestamps = [];
                this.signals = {
                    buy: [],
                    sell: []
                };
                this.indicators = {};
                this.currentTrend = 'neutral';
                
                // Performance
                this.performance = {
                    totalTrades: 0,
                    winningTrades: 0,
                    winRate: 0
                };
            }
        }
        
        // Initialize
        const state = new TradingState();
        let chart = null;
        let updateInterval = null;
        
        // DOM Elements
        const elements = {
            // Chart elements
            chartLoading: document.getElementById('chartLoading'),
            priceChart: document.getElementById('priceChart').getContext('2d'),
            currentPrice: document.getElementById('currentPrice'),
            
            // Signal elements
            buyCount: document.getElementById('buyCount'),
            sellCount: document.getElementById('sellCount'),
            buyDetail: document.getElementById('buyDetail'),
            sellDetail: document.getElementById('sellDetail'),
            buySignalCard: document.getElementById('buySignalCard'),
            sellSignalCard: document.getElementById('sellSignalCard'),
            trendDirection: document.getElementById('trendDirection'),
            signalStrength: document.getElementById('signalStrength'),
            
            // Control elements
            atrSlider: document.getElementById('atrSlider'),
            atrValue: document.getElementById('atrValue'),
            bbPeriodSlider: document.getElementById('bbPeriodSlider'),
            bbPeriodValue: document.getElementById('bbPeriodValue'),
            bbDeviationSlider: document.getElementById('bbDeviationSlider'),
            bbDeviationValue: document.getElementById('bbDeviationValue'),
            positionSlider: document.getElementById('positionSlider'),
            positionSize: document.getElementById('positionSize'),
            accountBalance: document.getElementById('accountBalance'),
            
            // ML elements
            mlConfidence: document.getElementById('mlConfidence'),
            patternMatch: document.getElementById('patternMatch'),
            
            // Buttons
            resetBtn: document.getElementById('resetBtn'),
            applyBtn: document.getElementById('applyBtn'),
            executeBuy: document.getElementById('executeBuy'),
            executeSell: document.getElementById('executeSell'),
            connectBroker: document.getElementById('connectBroker'),
            autoTrade: document.getElementById('autoTrade'),
            analyzeMarket: document.getElementById('analyzeMarket'),
            validateSignal: document.getElementById('validateSignal'),
            toggleVolume: document.getElementById('toggleVolume'),
            toggleIndicators: document.getElementById('toggleIndicators'),
            fullscreenBtn: document.getElementById('fullscreenBtn'),
            
            // Alert
            alertBanner: document.getElementById('alertBanner'),
            alertTitle: document.getElementById('alertTitle'),
            alertMessage: document.getElementById('alertMessage'),
            
            // Pair select
            pairSelect: document.getElementById('pairSelect'),
            
            // MTF Analysis
            mtfAnalysis: document.getElementById('mtfAnalysis')
        };
        
        // ============================================
        // FIXED CHART RENDERER
        // ============================================
        
        class ChartRenderer {
            constructor() {
                this.chart = null;
                this.volumeEnabled = true;
                this.indicatorsEnabled = true;
            }
            
            initializeChart(data, indicators) {
                if (this.chart) {
                    this.chart.destroy();
                }
                
                const datasets = this.createDatasets(data, indicators);
                
                this.chart = new Chart(elements.priceChart, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: 'var(--text)',
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                titleColor: 'var(--primary)',
                                bodyColor: 'var(--text)',
                                borderColor: '#334155',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'minute'
                                },
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.1)'
                                },
                                ticks: {
                                    color: 'var(--text-dim)'
                                }
                            },
                            y: {
                                position: 'right',
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.1)'
                                },
                                ticks: {
                                    color: 'var(--text-dim)',
                                    callback: (value) => this.formatPrice(value)
                                }
                            },
                            y1: {
                                position: 'left',
                                display: this.volumeEnabled,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: 'var(--text-dim)',
                                    display: this.volumeEnabled
                                }
                            }
                        }
                    }
                });
            }
            
            createDatasets(data, indicators) {
                const pair = TRADING_PAIRS[state.currentPair];
                const datasets = [];
                
                // Main price line
                datasets.push({
                    label: `${pair.name} Price`,
                    data: data.map((d, i) => ({
                        x: d.timestamp,
                        y: d.close
                    })),
                    borderColor: pair.color,
                    backgroundColor: pair.color + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                });
                
                // Bollinger Bands
                if (this.indicatorsEnabled && indicators.bbUpper) {
                    datasets.push({
                        label: 'BB Upper',
                        data: data.map((d, i) => ({
                            x: d.timestamp,
                            y: indicators.bbUpper[i]
                        })),
                        borderColor: 'rgba(59, 130, 246, 0.6)',
                        borderWidth: 1,
                        fill: false,
                        pointRadius: 0,
                        borderDash: [5, 5]
                    });
                    
                    datasets.push({
                        label: 'BB Middle',
                        data: data.map((d, i) => ({
                            x: d.timestamp,
                            y: indicators.bbMiddle[i]
                        })),
                        borderColor: 'rgba(59, 130, 246, 0.4)',
                        borderWidth: 1,
                        fill: false,
                        pointRadius: 0,
                        borderDash: [2, 2]
                    });
                    
                    datasets.push({
                        label: 'BB Lower',
                        data: data.map((d, i) => ({
                            x: d.timestamp,
                            y: indicators.bbLower[i]
                        })),
                        borderColor: 'rgba(59, 130, 246, 0.6)',
                        borderWidth: 1,
                        fill: false,
                        pointRadius: 0,
                        borderDash: [5, 5]
                    });
                }
                
                // TrendIQ Signal Line
                if (this.indicatorsEnabled && indicators.eliteSignal) {
                    datasets.push({
                        label: 'TrendIQ Signal',
                        data: data.map((d, i) => ({
                            x: d.timestamp,
                            y: indicators.eliteSignal[i]
                        })),
                        borderColor: 'var(--primary)',
                        borderWidth: 3,
                        fill: false,
                        pointRadius: 0
                    });
                }
                
                // Volume
                if (this.volumeEnabled) {
                    datasets.push({
                        label: 'Volume',
                        data: data.map((d, i) => ({
                            x: d.timestamp,
                            y: d.volume
                        })),
                        type: 'bar',
                        yAxisID: 'y1',
                        backgroundColor: (ctx) => {
                            const index = ctx.dataIndex;
                            if (index === 0) return 'rgba(148, 163, 184, 0.3)';
                            const current = data[index].close;
                            const previous = data[index - 1].close;
                            return current >= previous 
                                ? 'rgba(16, 185, 129, 0.3)' 
                                : 'rgba(239, 68, 68, 0.3)';
                        },
                        borderWidth: 0
                    });
                }
                
                // Buy signals
                if (state.signals.buy.length > 0) {
                    datasets.push({
                        label: 'BUY',
                        data: state.signals.buy.map(s => ({
                            x: s.timestamp,
                            y: s.price
                        })),
                        borderColor: 'var(--buy)',
                        backgroundColor: 'var(--buy)',
                        pointStyle: 'triangle',
                        pointRadius: 8,
                        pointRotation: 0,
                        showLine: false
                    });
                }
                
                // Sell signals
                if (state.signals.sell.length > 0) {
                    datasets.push({
                        label: 'SELL',
                        data: state.signals.sell.map(s => ({
                            x: s.timestamp,
                            y: s.price
                        })),
                        borderColor: 'var(--sell)',
                        backgroundColor: 'var(--sell)',
                        pointStyle: 'triangle',
                        pointRadius: 8,
                        pointRotation: 180,
                        showLine: false
                    });
                }
                
                return datasets;
            }
            
            formatPrice(value) {
                const pair = TRADING_PAIRS[state.currentPair];
                if (pair === TRADING_PAIRS.eurusd) return value.toFixed(4);
                if (pair === TRADING_PAIRS.btcusd || pair === TRADING_PAIRS.gold) return value.toFixed(2);
                return value.toFixed(0);
            }
            
            toggleVolume() {
                this.volumeEnabled = !this.volumeEnabled;
                if (this.chart) {
                    this.chart.options.scales.y1.display = this.volumeEnabled;
                    this.chart.update();
                }
            }
            
            toggleIndicators() {
                this.indicatorsEnabled = !this.indicatorsEnabled;
                if (this.chart) {
                    this.chart.destroy();
                    this.initializeChart(
                        state.timestamps.map((t, i) => ({
                            timestamp: t,
                            open: state.priceData[i] * 0.999,
                            high: state.highData[i],
                            low: state.lowData[i],
                            close: state.priceData[i],
                            volume: state.volumeData[i]
                        })),
                        state.indicators
                    );
                }
            }
        }
        
        // ============================================
        // FIXED INDICATOR CALCULATIONS
        // ============================================
        
        class IndicatorCalculator {
            static calculateTrueRange(current, previous) {
                if (!previous) return current.high - current.low;
                
                return Math.max(
                    current.high - current.low,
                    Math.abs(current.high - previous.close),
                    Math.abs(current.low - previous.close)
                );
            }
            
            static calculateATR(data, period) {
                const atrValues = [];
                const trueRanges = [];
                
                for (let i = 0; i < data.length; i++) {
                    const tr = this.calculateTrueRange(
                        data[i],
                        i > 0 ? data[i-1] : null
                    );
                    trueRanges.push(tr);
                    
                    if (i < period - 1) {
                        atrValues.push(null);
                        continue;
                    }
                    
                    const periodTRs = trueRanges.slice(i - period + 1, i + 1);
                    const atr = periodTRs.reduce((sum, val) => sum + val, 0) / period;
                    atrValues.push(atr);
                }
                
                // Pad beginning
                while (atrValues.length < data.length) {
                    atrValues.unshift(null);
                }
                
                return atrValues;
            }
            
            static calculateBollingerBands(prices, period, deviation) {
                const upper = [];
                const middle = [];
                const lower = [];
                
                for (let i = period - 1; i < prices.length; i++) {
                    const slice = prices.slice(i - period + 1, i + 1);
                    const sma = slice.reduce((sum, p) => sum + p, 0) / period;
                    
                    const variance = slice.reduce((sum, p) => sum + Math.pow(p - sma, 2), 0) / period;
                    const stdev = Math.sqrt(variance);
                    
                    middle.push(sma);
                    upper.push(sma + stdev * deviation);
                    lower.push(sma - stdev * deviation);
                }
                
                // Pad beginning
                const pad = Array(period - 1).fill(null);
                
                return {
                    upper: pad.concat(upper),
                    middle: pad.concat(middle),
                    lower: pad.concat(lower)
                };
            }
            
            static calculateTrendIQSignal(data, bb, atr) {
                const eliteSignal = [];
                let lastSignal = null;
                
                for (let i = 0; i < data.length; i++) {
                    if (bb.upper[i] === null || atr[i] === null) {
                        eliteSignal.push(null);
                        continue;
                    }
                    
                    const current = data[i];
                    let signal = null;
                    
                    // BB Signal detection
                    if (current.close > bb.upper[i]) {
                        // Buy zone - price above BB upper
                        signal = current.low - atr[i];
                        if (lastSignal !== null && signal < lastSignal) {
                            signal = lastSignal;
                        }
                    } else if (current.close < bb.lower[i]) {
                        // Sell zone - price below BB lower
                        signal = current.high + atr[i];
                        if (lastSignal !== null && signal > lastSignal) {
                            signal = lastSignal;
                        }
                    } else {
                        // Neutral zone
                        signal = lastSignal !== null ? lastSignal : current.close;
                    }
                    
                    eliteSignal.push(signal);
                    lastSignal = signal;
                }
                
                return eliteSignal;
            }
            
            static detectSignals(data, bb, eliteSignal, atr) {
                const signals = { buy: [], sell: [] };
                let lastTrend = 'neutral';
                
                for (let i = 1; i < data.length; i++) {
                    if (eliteSignal[i] === null || eliteSignal[i-1] === null) continue;
                    
                    const currentTrend = eliteSignal[i] > eliteSignal[i-1] ? 'up' : 
                                        eliteSignal[i] < eliteSignal[i-1] ? 'down' : 'neutral';
                    
                    // Buy signal: trend changes from down to up
                    if (lastTrend === 'down' && currentTrend === 'up') {
                        const signal = {
                            price: eliteSignal[i] - (atr[i] || 0),
                            timestamp: data[i].timestamp,
                            index: i
                        };
                        signals.buy.push(signal);
                    }
                    
                    // Sell signal: trend changes from up to down
                    if (lastTrend === 'up' && currentTrend === 'down') {
                        const signal = {
                            price: eliteSignal[i] + (atr[i] || 0),
                            timestamp: data[i].timestamp,
                            index: i
                        };
                        signals.sell.push(signal);
                    }
                    
                    lastTrend = currentTrend;
                }
                
                return signals;
            }
        }
        
        // ============================================
        // FIXED DATA GENERATOR
        // ============================================
        
        class DataGenerator {
            static generateMarketData(pairKey, count = 100) {
                const pair = TRADING_PAIRS[pairKey];
                const data = [];
                
                let price = pair.basePrice;
                let volatility = pair.volatility;
                
                for (let i = 0; i < count; i++) {
                    // Random walk with momentum
                    const change = (Math.random() - 0.5) * 2 * volatility * price;
                    
                    // Add some trend
                    const trend = Math.sin(i / 20) * 0.001 * price;
                    
                    price += change + trend;
                    
                    // Generate OHLCV
                    const open = price;
                    const high = open * (1 + Math.random() * volatility);
                    const low = open * (1 - Math.random() * volatility);
                    const close = low + (high - low) * Math.random();
                    const volume = Math.random() * 1000 + 100;
                    
                    data.push({
                        timestamp: new Date(Date.now() - (count - i - 1) * 5 * 60000), // 5-minute intervals
                        open,
                        high,
                        low,
                        close,
                        volume
                    });
                    
                    price = close;
                }
                
                return data;
            }
        }
        
        // ============================================
        // FIXED MULTI-TIMEFRAME ANALYZER
        // ============================================
        
        class MTFAnalyzer {
            static analyze(data, pair) {
                const timeframes = ['5m', '15m', '1h', '4h', '1d'];
                const analysis = {};
                
                timeframes.forEach(tf => {
                    const filtered = this.filterData(data, tf);
                    if (filtered.length < 20) return;
                    
                    const closes = filtered.map(d => d.close);
                    const sma20 = this.calculateSMA(closes, 20);
                    const sma50 = this.calculateSMA(closes, 50);
                    
                    let signal = 'neutral';
                    const lastClose = closes[closes.length - 1];
                    const lastSMA20 = sma20[sma20.length - 1];
                    
                    if (lastClose > lastSMA20 * 1.02) signal = 'buy';
                    else if (lastClose < lastSMA20 * 0.98) signal = 'sell';
                    
                    analysis[tf] = {
                        signal,
                        close: lastClose,
                        sma20: lastSMA20
                    };
                });
                
                return analysis;
            }
            
            static filterData(data, timeframe) {
                const interval = {
                    '5m': 1,
                    '15m': 3,
                    '1h': 12,
                    '4h': 48,
                    '1d': 288
                }[timeframe] || 1;
                
                return data.filter((_, i) => i % interval === 0);
            }
            
            static calculateSMA(data, period) {
                const sma = [];
                for (let i = period - 1; i < data.length; i++) {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    sma.push(sum / period);
                }
                return Array(data.length - sma.length).fill(null).concat(sma);
            }
            
            static render(container, analysis) {
                container.innerHTML = '';
                
                Object.entries(analysis).forEach(([tf, data]) => {
                    const card = document.createElement('div');
                    card.className = 'mtf-card';
                    
                    const signalClass = `mtf-${data.signal}`;
                    
                    card.innerHTML = `
                        <div class="mtf-title">${tf.toUpperCase()}</div>
                        <div class="mtf-value ${signalClass}">${data.signal.toUpperCase()}</div>
                        <div style="font-size: 10px; color: var(--text-dim); margin-top: 3px;">
                            Price: ${data.close.toFixed(2)}
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            }
        }
        
        // ============================================
        // FIXED APPLICATION LOGIC
        // ============================================
        
        class TradingApp {
            constructor() {
                this.chartRenderer = new ChartRenderer();
                this.initialized = false;
            }
            
            async initialize() {
                try {
                    elements.chartLoading.style.display = 'flex';
                    
                    // Generate market data
                    const rawData = DataGenerator.generateMarketData(state.currentPair);
                    
                    // Store data
                    state.priceData = rawData.map(d => d.close);
                    state.highData = rawData.map(d => d.high);
                    state.lowData = rawData.map(d => d.low);
                    state.volumeData = rawData.map(d => d.volume);
                    state.timestamps = rawData.map(d => d.timestamp);
                    
                    // Calculate indicators
                    this.calculateIndicators(rawData);
                    
                    // Update UI
                    this.updateUI();
                    
                    // Initialize chart
                    this.chartRenderer.initializeChart(rawData, state.indicators);
                    
                    // Start updates
                    this.startUpdates();
                    
                    this.initialized = true;
                    elements.chartLoading.style.display = 'none';
                    
                    console.log('TrendIQ Pro initialized successfully');
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    elements.chartLoading.innerHTML = `<p>Error: ${error.message}</p>`;
                }
            }
            
            calculateIndicators(data) {
                // Calculate ATR
                const atr = IndicatorCalculator.calculateATR(data, state.atrPeriod);
                
                // Calculate Bollinger Bands
                const bb = IndicatorCalculator.calculateBollingerBands(
                    state.priceData,
                    state.bbPeriod,
                    state.bbDeviation
                );
                
                // Calculate TrendIQ Signal
                const eliteSignal = IndicatorCalculator.calculateTrendIQSignal(data, bb, atr);
                
                // Detect signals
                state.signals = IndicatorCalculator.detectSignals(data, bb, eliteSignal, atr);
                
                // Store indicators
                state.indicators = {
                    atr,
                    bbUpper: bb.upper,
                    bbMiddle: bb.middle,
                    bbLower: bb.lower,
                    eliteSignal
                };
                
                // Determine current trend
                this.determineTrend(eliteSignal);
            }
            
            determineTrend(eliteSignal) {
                if (eliteSignal.length < 2) {
                    state.currentTrend = 'neutral';
                    return;
                }
                
                const lastIndex = eliteSignal.length - 1;
                const lastValue = eliteSignal[lastIndex];
                const prevValue = eliteSignal[lastIndex - 1];
                
                if (lastValue === null || prevValue === null) {
                    state.currentTrend = 'neutral';
                    return;
                }
                
                if (lastValue > prevValue) state.currentTrend = 'up';
                else if (lastValue < prevValue) state.currentTrend = 'down';
                else state.currentTrend = 'neutral';
            }
            
            updateUI() {
                // Update current price
                const currentPrice = state.priceData[state.priceData.length - 1];
                const pair = TRADING_PAIRS[state.currentPair];
                elements.currentPrice.textContent = this.formatPrice(currentPrice);
                
                // Update signal counts
                elements.buyCount.textContent = state.signals.buy.length;
                elements.sellCount.textContent = state.signals.sell.length;
                
                // Update signal details
                if (state.signals.buy.length > 0) {
                    const lastBuy = state.signals.buy[state.signals.buy.length - 1];
                    elements.buyDetail.textContent = `Last: ${this.formatPrice(lastBuy.price)}`;
                    elements.buySignalCard.classList.add('active');
                } else {
                    elements.buyDetail.textContent = 'No signals';
                    elements.buySignalCard.classList.remove('active');
                }
                
                if (state.signals.sell.length > 0) {
                    const lastSell = state.signals.sell[state.signals.sell.length - 1];
                    elements.sellDetail.textContent = `Last: ${this.formatPrice(lastSell.price)}`;
                    elements.sellSignalCard.classList.add('active');
                } else {
                    elements.sellDetail.textContent = 'No signals';
                    elements.sellSignalCard.classList.remove('active');
                }
                
                // Update trend
                elements.trendDirection.textContent = state.currentTrend.toUpperCase();
                elements.trendDirection.className = `trend-indicator trend-${state.currentTrend}`;
                
                // Update signal strength
                const totalSignals = state.signals.buy.length + state.signals.sell.length;
                let strength = 'Low';
                if (totalSignals > 10) strength = 'High';
                else if (totalSignals > 5) strength = 'Medium';
                elements.signalStrength.textContent = strength;
                
                // Update multi-timeframe analysis
                const data = state.timestamps.map((t, i) => ({
                    timestamp: t,
                    open: state.priceData[i] * 0.999,
                    high: state.highData[i],
                    low: state.lowData[i],
                    close: state.priceData[i],
                    volume: state.volumeData[i]
                }));
                
                const mtfAnalysis = MTFAnalyzer.analyze(data, state.currentPair);
                MTFAnalyzer.render(elements.mtfAnalysis, mtfAnalysis);
                
                // Update ML confidence (simulated)
                const confidence = Math.min(95, 70 + Math.random() * 25);
                elements.mlConfidence.textContent = `${Math.round(confidence)}%`;
                elements.patternMatch.textContent = `${Math.round(confidence - 5)}%`;
            }
            
            formatPrice(price) {
                const pair = TRADING_PAIRS[state.currentPair];
                if (pair === TRADING_PAIRS.eurusd) return price.toFixed(4);
                if (pair === TRADING_PAIRS.btcusd || pair === TRADING_PAIRS.gold) return price.toFixed(2);
                return price.toFixed(0);
            }
            
            startUpdates() {
                if (updateInterval) clearInterval(updateInterval);
                
                updateInterval = setInterval(() => {
                    this.updateMarketData();
                }, 10000); // Update every 10 seconds
            }
            
            updateMarketData() {
                // Add new data point
                const pair = TRADING_PAIRS[state.currentPair];
                const lastPrice = state.priceData[state.priceData.length - 1];
                
                // Generate new price with realistic movement
                const change = (Math.random() - 0.5) * 2 * pair.volatility * lastPrice;
                const newPrice = lastPrice + change;
                
                // Update data arrays
                state.priceData.push(newPrice);
                state.highData.push(newPrice * (1 + Math.random() * 0.01));
                state.lowData.push(newPrice * (1 - Math.random() * 0.01));
                state.volumeData.push(Math.random() * 1000 + 100);
                state.timestamps.push(new Date());
                
                // Keep arrays at reasonable size
                if (state.priceData.length > 200) {
                    state.priceData.shift();
                    state.highData.shift();
                    state.lowData.shift();
                    state.volumeData.shift();
                    state.timestamps.shift();
                }
                
                // Recalculate indicators
                const data = state.timestamps.map((t, i) => ({
                    timestamp: t,
                    open: state.priceData[i] * 0.999,
                    high: state.highData[i],
                    low: state.lowData[i],
                    close: state.priceData[i],
                    volume: state.volumeData[i]
                }));
                
                this.calculateIndicators(data);
                this.updateUI();
                
                // Update chart
                this.chartRenderer.initializeChart(data, state.indicators);
            }
            
            showAlert(type, message) {
                elements.alertTitle.textContent = type;
                elements.alertMessage.textContent = message;
                elements.alertBanner.className = `alert-banner alert-${type.toLowerCase()}`;
                elements.alertBanner.style.display = 'block';
                
                setTimeout(() => {
                    elements.alertBanner.style.display = 'none';
                }, 5000);
            }
            
            executeTrade(side) {
                const currentPrice = state.priceData[state.priceData.length - 1];
                const quantity = state.positionSize;
                
                this.showAlert(
                    'TRADE EXECUTED',
                    `${side.toUpperCase()} ${quantity} ${state.currentPair} @ ${this.formatPrice(currentPrice)}`
                );
                
                state.performance.totalTrades++;
            }
            
            connectBroker() {
                state.brokerConnected = !state.brokerConnected;
                
                if (state.brokerConnected) {
                    elements.connectBroker.innerHTML = '<i class="fas fa-check"></i> Connected';
                    this.showAlert('BROKER', 'Demo broker connected successfully');
                } else {
                    elements.connectBroker.innerHTML = '<i class="fas fa-plug"></i> Connect Demo';
                    this.showAlert('BROKER', 'Broker disconnected');
                }
            }
            
            toggleAutoTrade() {
                state.autoTrading = !state.autoTrading;
                
                if (state.autoTrading) {
                    elements.autoTrade.innerHTML = '<i class="fas fa-pause"></i> Stop Auto';
                    this.showAlert('AUTO TRADING', 'Automatic trading enabled');
                } else {
                    elements.autoTrade.innerHTML = '<i class="fas fa-robot"></i> Auto Trade';
                    this.showAlert('AUTO TRADING', 'Automatic trading disabled');
                }
            }
        }
        
        // ============================================
        // INITIALIZE APPLICATION
        // ============================================
        
        const app = new TradingApp();
        
        // DOM Ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize app
            app.initialize();
            
            // Pair selection
            elements.pairSelect.addEventListener('change', (e) => {
                state.currentPair = e.target.value;
                app.initialize();
            });
            
            // Timeframe buttons
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    state.timeframe = e.target.dataset.tf;
                    // Note: In a real implementation, this would fetch new data
                    app.showAlert('TIMEFRAME', `Switched to ${state.timeframe} timeframe`);
                });
            });
            
            // Control sliders
            elements.atrSlider.addEventListener('input', (e) => {
                elements.atrValue.textContent = e.target.value;
                state.atrPeriod = parseInt(e.target.value);
            });
            
            elements.bbPeriodSlider.addEventListener('input', (e) => {
                elements.bbPeriodValue.textContent = e.target.value;
                state.bbPeriod = parseInt(e.target.value);
            });
            
            elements.bbDeviationSlider.addEventListener('input', (e) => {
                elements.bbDeviationValue.textContent = parseFloat(e.target.value).toFixed(1);
                state.bbDeviation = parseFloat(e.target.value);
            });
            
            elements.positionSlider.addEventListener('input', (e) => {
                elements.positionSize.textContent = parseFloat(e.target.value).toFixed(2);
                state.positionSize = parseFloat(e.target.value);
            });
            
            // Control buttons
            elements.resetBtn.addEventListener('click', () => {
                state.atrPeriod = 14;
                state.bbPeriod = 20;
                state.bbDeviation = 2.0;
                
                elements.atrSlider.value = 14;
                elements.atrValue.textContent = '14';
                elements.bbPeriodSlider.value = 20;
                elements.bbPeriodValue.textContent = '20';
                elements.bbDeviationSlider.value = 2.0;
                elements.bbDeviationValue.textContent = '2.0';
                
                app.showAlert('SETTINGS', 'Reset to default values');
                app.initialize();
            });
            
            elements.applyBtn.addEventListener('click', () => {
                app.showAlert('SETTINGS', 'Indicator settings applied');
                app.initialize();
            });
            
            // Trade execution
            elements.executeBuy.addEventListener('click', () => {
                if (state.brokerConnected) {
                    app.executeTrade('buy');
                } else {
                    app.showAlert('ERROR', 'Please connect to broker first');
                }
            });
            
            elements.executeSell.addEventListener('click', () => {
                if (state.brokerConnected) {
                    app.executeTrade('sell');
                } else {
                    app.showAlert('ERROR', 'Please connect to broker first');
                }
            });
            
            // Broker functions
            elements.connectBroker.addEventListener('click', () => {
                app.connectBroker();
            });
            
            elements.autoTrade.addEventListener('click', () => {
                app.toggleAutoTrade();
            });
            
            // Chart controls
            elements.toggleVolume.addEventListener('click', () => {
                app.chartRenderer.toggleVolume();
                app.showAlert('CHART', `Volume ${app.chartRenderer.volumeEnabled ? 'enabled' : 'disabled'}`);
            });
            
            elements.toggleIndicators.addEventListener('click', () => {
                app.chartRenderer.toggleIndicators();
                app.showAlert('CHART', `Indicators ${app.chartRenderer.indicatorsEnabled ? 'enabled' : 'disabled'}`);
            });
            
            elements.fullscreenBtn.addEventListener('click', () => {
                const chartContainer = document.querySelector('.chart-container');
                if (!document.fullscreenElement) {
                    chartContainer.requestFullscreen().catch(err => {
                        console.error(`Fullscreen error: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
            });
            
            // ML/AI functions
            elements.analyzeMarket.addEventListener('click', () => {
                const confidence = 70 + Math.random() * 25;
                elements.mlConfidence.textContent = `${Math.round(confidence)}%`;
                app.showAlert('ANALYSIS', `Market analysis complete - Confidence: ${Math.round(confidence)}%`);
            });
            
            elements.validateSignal.addEventListener('click', () => {
                if (state.signals.buy.length === 0 && state.signals.sell.length === 0) {
                    app.showAlert('VALIDATION', 'No signals to validate');
                    return;
                }
                
                const validationScore = 75 + Math.random() * 20;
                app.showAlert('VALIDATION', `Signal validated with ${Math.round(validationScore)}% accuracy`);
            });
            
            // Mobile touch events
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Handle orientation changes
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    if (app.chartRenderer.chart) {
                        app.chartRenderer.chart.resize();
                    }
                }, 300);
            });
        });
        
        // Error handling
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            app.showAlert('ERROR', `Application error: ${e.message}`);
        });
    </script>
</body>
</html>
