<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MasterShifu V2 - Deriv Trading Dashboard</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --purple: #8b5cf6;
            --dark: #0f172a;
            --darker: #020617;
            --card: #1e293b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--darker);
            color: white;
            min-height: 100vh;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.7;
            font-size: 1rem;
        }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .status-item {
            padding: 8px 16px;
            border-radius: 8px;
            background: var(--card);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .price-ticker {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
            max-height: 120px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
        }
        
        .price-item {
            background: var(--card);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            min-width: 90px;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .price-item:hover {
            transform: translateY(-2px);
        }
        
        .price-up { color: var(--success); }
        .price-down { color: var(--danger); }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .signal {
            background: rgba(255, 255, 255, 0.03);
            border-left: 4px solid;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .signal:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .STRONG_BUY { border-color: var(--success); }
        .BUY { border-color: #22c55e; }
        .NEUTRAL { border-color: var(--warning); }
        .SELL { border-color: #ef4444; }
        .STRONG_SELL { border-color: #dc2626; }
        
        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .symbol {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .direction {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }
        
        .STRONG_BUY .direction { background: var(--success); }
        .BUY .direction { background: #22c55e; }
        .NEUTRAL .direction { background: var(--warning); }
        .SELL .direction { background: #ef4444; }
        .STRONG_SELL .direction { background: #dc2626; }
        
        .signal-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        @media (max-width: 480px) {
            .signal-details {
                grid-template-columns: 1fr;
            }
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }
        
        .patterns {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .pattern-tag {
            background: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
        }
        
        .timestamp {
            font-size: 0.8rem;
            opacity: 0.6;
            text-align: right;
        }
        
        .chart-container {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--dark);
            position: relative;
        }
        
        .no-signals {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.6;
        }
        
        .confidence {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .live-price {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .market-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .market-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: var(--card);
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .market-btn.active {
            background: var(--primary);
        }
        
        .refresh-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .refresh-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid var(--success);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .signal-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .signal-type {
            display: flex;
            gap: 10px;
        }
        
        .signal-type-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .signal-type-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .market-highlights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .highlight-card {
            background: var(--card);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .highlight-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 5px 0;
        }
        
        .volatility .highlight-value { color: var(--purple); }
        .synthetic .highlight-value { color: var(--warning); }
        .commodity .highlight-value { color: var(--success); }
        .forex .highlight-value { color: var(--primary); }
        
        .last-updated {
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.6;
            margin-top: 10px;
        }
        
        .pulse {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MasterShifu V2</h1>
            <p>Deriv Trading System - Volatility, Crash/Boom, Jump Indices & Forex Commodities</p>
            
            <div class="market-selector">
                <button class="market-btn active" data-market="volatility">Volatility</button>
                <button class="market-btn" data-market="synthetic">Crash/Boom</button>
                <button class="market-btn" data-market="jump">Jump Indices</button>
                <button class="market-btn" data-market="forex">Forex</button>
                <button class="market-btn" data-market="commodities">Commodities</button>
            </div>
            
            <div class="market-highlights">
                <div class="highlight-card volatility">
                    <div>Volatility Indices</div>
                    <div class="highlight-value" id="volatilityCount">8</div>
                    <div>Active Signals</div>
                </div>
                <div class="highlight-card synthetic">
                    <div>Crash/Boom</div>
                    <div class="highlight-value" id="syntheticCount">6</div>
                    <div>Active Signals</div>
                </div>
                <div class="highlight-card commodity">
                    <div>Commodities</div>
                    <div class="highlight-value" id="commodityCount">5</div>
                    <div>Active Signals</div>
                </div>
                <div class="highlight-card forex">
                    <div>Forex</div>
                    <div class="highlight-value" id="forexCount">7</div>
                    <div>Active Signals</div>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="status-item"><span class="pulse"></span>Signals: <span id="signalsCount">0</span></div>
                <div class="status-item">Next: <span id="nextUpdate" class="refresh-indicator"><span class="refresh-spinner"></span>60s</span></div>
                <div class="status-item" id="connectionStatus" style="color: var(--success)">● Live</div>
                <div class="status-item">Market: <span id="activeMarket">Volatility</span></div>
            </div>
            
            <div class="price-ticker" id="priceTicker">
                <!-- Real-time prices will appear here -->
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <h2>📊 Market Analysis</h2>
                <div class="chart-container" id="chartContainer">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; opacity: 0.7;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; margin-bottom: 10px;">Live Market Dashboard</div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">Active: <span id="activeMarketChart">Volatility Indices</span></div>
                            <div style="font-size: 0.8rem; opacity: 0.6; margin-top: 20px;">Signals auto-refresh every 60 seconds</div>
                        </div>
                    </div>
                </div>
                <div class="last-updated" id="lastUpdated">
                    Last updated: <span id="updateTime">Just now</span>
                </div>
            </div>
            
            <div class="card">
                <div class="signal-stats">
                    <div>🎯 Latest Trading Signals</div>
                    <div class="signal-type">
                        <div class="signal-type-item">
                            <div class="signal-type-color" style="background: var(--success);"></div>
                            <span>Buy</span>
                        </div>
                        <div class="signal-type-item">
                            <div class="signal-type-color" style="background: var(--danger);"></div>
                            <span>Sell</span>
                        </div>
                    </div>
                </div>
                <div id="signalsContainer">
                    <div class="no-signals">
                        Initializing signal engine...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Price Manager with All Deriv Commodities
        class PriceManager {
            constructor() {
                this.markets = {
                    volatility: [
                        'Volatility 10 Index', 'Volatility 25 Index', 'Volatility 50 Index', 
                        'Volatility 75 Index', 'Volatility 100 Index', 'Volatility 10 (1s) Index',
                        'Volatility 25 (1s) Index', 'Volatility 50 (1s) Index', 'Volatility 75 (1s) Index', 
                        'Volatility 100 (1s) Index'
                    ],
                    synthetic: [
                        'Boom 300 Index', 'Boom 500 Index', 'Boom 1000 Index',
                        'Crash 300 Index', 'Crash 500 Index', 'Crash 1000 Index'
                    ],
                    jump: [
                        'Jump 10 Index', 'Jump 25 Index', 'Jump 50 Index', 
                        'Jump 75 Index', 'Jump 100 Index'
                    ],
                    forex: [
                        'EUR/USD', 'GBP/USD', 'USD/JPY', 'AUD/USD', 'USD/CAD', 
                        'USD/CHF', 'NZD/USD'
                    ],
                    commodities: [
                        'Gold/USD', 'Silver/USD', 'Palladium/USD', 'Platinum/USD', 
                        'Brent Oil', 'WTI Oil', 'Natural Gas', 'BTC/USD'
                    ]
                };
                
                this.currentMarket = 'volatility';
                this.prices = {};
                this.initializeAllPrices();
            }

            initializeAllPrices() {
                // Base prices for all Deriv instruments
                const basePrices = {
                    // Volatility Indices
                    'Volatility 10 Index': 12345.67, 'Volatility 25 Index': 23456.78, 
                    'Volatility 50 Index': 34567.89, 'Volatility 75 Index': 45678.90,
                    'Volatility 100 Index': 56789.01, 'Volatility 10 (1s) Index': 1234.56,
                    'Volatility 25 (1s) Index': 2345.67, 'Volatility 50 (1s) Index': 3456.78,
                    'Volatility 75 (1s) Index': 4567.89, 'Volatility 100 (1s) Index': 5678.90,
                    
                    // Synthetic Indices (Boom/Crash)
                    'Boom 300 Index': 300.50, 'Boom 500 Index': 500.75, 'Boom 1000 Index': 1000.25,
                    'Crash 300 Index': 300.25, 'Crash 500 Index': 500.50, 'Crash 1000 Index': 1000.75,
                    
                    // Jump Indices
                    'Jump 10 Index': 123.45, 'Jump 25 Index': 234.56, 'Jump 50 Index': 345.67,
                    'Jump 75 Index': 456.78, 'Jump 100 Index': 567.89,
                    
                    // Forex
                    'EUR/USD': 1.0850, 'GBP/USD': 1.2650, 'USD/JPY': 148.20,
                    'AUD/USD': 0.6520, 'USD/CAD': 1.3520, 'USD/CHF': 0.8820,
                    'NZD/USD': 0.6120,
                    
                    // Commodities
                    'Gold/USD': 2025.50, 'Silver/USD': 22.85, 'Palladium/USD': 980.00,
                    'Platinum/USD': 920.00, 'Brent Oil': 75.80, 'WTI Oil': 75.50,
                    'Natural Gas': 2.85, 'BTC/USD': 43250.00
                };
                
                // Initialize all prices
                Object.values(this.markets).flat().forEach(symbol => {
                    if (basePrices[symbol]) {
                        this.prices[symbol] = {
                            price: basePrices[symbol],
                            change: 0,
                            changePercent: 0,
                            volatility: this.calculateVolatility(symbol),
                            history: [basePrices[symbol]]
                        };
                    }
                });
            }

            calculateVolatility(symbol) {
                // Different volatility profiles for different asset classes
                if (this.markets.volatility.includes(symbol)) {
                    return 0.02; // High volatility for volatility indices
                } else if (this.markets.synthetic.includes(symbol)) {
                    return symbol.includes('Boom') || symbol.includes('Crash') ? 0.03 : 0.025;
                } else if (this.markets.jump.includes(symbol)) {
                    return 0.015;
                } else if (this.markets.forex.includes(symbol)) {
                    return symbol.includes('JPY') ? 0.0012 : 0.0008;
                } else if (this.markets.commodities.includes(symbol)) {
                    if (symbol.includes('Gold') || symbol.includes('Silver')) {
                        return 0.005;
                    } else if (symbol.includes('Oil')) {
                        return 0.008;
                    } else if (symbol.includes('BTC')) {
                        return 0.015;
                    } else {
                        return 0.006;
                    }
                } else {
                    return 0.006;
                }
            }

            startPriceUpdates() {
                setInterval(() => {
                    const symbols = this.markets[this.currentMarket];
                    symbols.forEach(symbol => {
                        if (this.prices[symbol]) {
                            const currentPrice = this.prices[symbol].price;
                            const volatility = this.prices[symbol].volatility;
                            
                            // More realistic price movements based on asset class
                            let change;
                            if (this.markets.synthetic.includes(symbol)) {
                                // Boom/Crash indices have more dramatic movements
                                change = (Math.random() - 0.5) * 4 * volatility;
                            } else if (this.markets.volatility.includes(symbol)) {
                                // Volatility indices are, well, volatile
                                change = (Math.random() - 0.5) * 3 * volatility;
                            } else {
                                change = (Math.random() - 0.5) * 2 * volatility;
                            }
                            
                            const newPrice = Math.max(0.0001, currentPrice * (1 + change));
                            const changePercent = ((newPrice - currentPrice) / currentPrice) * 100;
                            
                            // Update price history (keep last 20 prices)
                            this.prices[symbol].history.push(newPrice);
                            if (this.prices[symbol].history.length > 20) {
                                this.prices[symbol].history.shift();
                            }
                            
                            this.prices[symbol] = {
                                ...this.prices[symbol],
                                price: newPrice,
                                change: newPrice - currentPrice,
                                changePercent: changePercent
                            };
                            
                            this.updatePriceDisplay(symbol);
                        }
                    });
                    
                    // Update last updated time
                    document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
                }, 2000);
            }

            updatePriceDisplay(symbol) {
                const priceData = this.prices[symbol];
                const priceElement = document.getElementById(`price-${symbol}`);
                
                if (priceElement) {
                    const changeClass = priceData.change >= 0 ? 'price-up' : 'price-down';
                    const changeSign = priceData.change >= 0 ? '+' : '';
                    
                    priceElement.innerHTML = `
                        <div>${symbol}</div>
                        <div class="live-price ${changeClass}">
                            ${this.formatPrice(priceData.price, symbol)}
                        </div>
                        <div class="${changeClass}" style="font-size: 0.7rem;">
                            ${changeSign}${this.formatPrice(priceData.change, symbol, true)} (${changeSign}${priceData.changePercent.toFixed(2)}%)
                        </div>
                    `;
                }
            }

            formatPrice(price, symbol, isChange = false) {
                if (this.markets.volatility.includes(symbol)) {
                    return price.toFixed(2);
                } else if (this.markets.synthetic.includes(symbol)) {
                    return price.toFixed(2);
                } else if (this.markets.jump.includes(symbol)) {
                    return price.toFixed(2);
                } else if (this.markets.forex.includes(symbol)) {
                    return symbol.includes('JPY') ? price.toFixed(2) : price.toFixed(4);
                } else if (this.markets.commodities.includes(symbol)) {
                    if (symbol.includes('Gold') || symbol.includes('Silver') || symbol.includes('Oil')) {
                        return '$' + price.toFixed(2);
                    } else if (symbol.includes('BTC')) {
                        return '$' + price.toFixed(2);
                    } else {
                        return price.toFixed(2);
                    }
                } else {
                    return price.toFixed(2);
                }
            }

            initializePriceTicker() {
                this.updatePriceTicker();
            }

            updatePriceTicker() {
                const ticker = document.getElementById('priceTicker');
                const symbols = this.markets[this.currentMarket];
                
                ticker.innerHTML = symbols.map(symbol => {
                    const priceData = this.prices[symbol] || { price: 0, change: 0, changePercent: 0 };
                    return `
                        <div class="price-item" id="price-${symbol}">
                            <div>${symbol}</div>
                            <div class="live-price">${this.formatPrice(priceData.price, symbol)}</div>
                            <div style="font-size: 0.7rem; opacity: 0.7;">0.00 (0.00%)</div>
                        </div>
                    `;
                }).join('');
            }

            setMarket(market) {
                if (this.markets[market]) {
                    this.currentMarket = market;
                    this.updatePriceTicker();
                    document.getElementById('activeMarket').textContent = 
                        market.charAt(0).toUpperCase() + market.slice(1);
                    document.getElementById('activeMarketChart').textContent = 
                        this.getMarketDisplayName(market);
                    return this.markets[market];
                }
                return this.markets.volatility;
            }

            getMarketDisplayName(market) {
                const names = {
                    volatility: 'Volatility Indices',
                    synthetic: 'Crash/Boom Indices',
                    jump: 'Jump Indices',
                    forex: 'Forex Pairs',
                    commodities: 'Commodities'
                };
                return names[market] || market;
            }
        }

        // Enhanced Signal Engine for Deriv Instruments
        class SignalEngine {
            constructor(priceManager) {
                this.priceManager = priceManager;
                this.activeSignals = new Set();
                this.signalHistory = [];
                this.marketSignals = {
                    volatility: 0,
                    synthetic: 0,
                    jump: 0,
                    forex: 0,
                    commodities: 0
                };
            }

            getCurrentSymbols() {
                return this.priceManager.markets[this.priceManager.currentMarket];
            }

            getCurrentPrice(symbol) {
                return this.priceManager.prices[symbol]?.price || 1;
            }

            generateSignal() {
                const symbols = this.getCurrentSymbols();
                if (!symbols || symbols.length === 0) return null;

                const symbol = symbols[Math.floor(Math.random() * symbols.length)];
                const currentPrice = this.getCurrentPrice(symbol);
                const priceData = this.priceManager.prices[symbol];
                
                // Enhanced technical analysis for different asset classes
                const rsi = 20 + Math.random() * 60; // 20-80 range
                const trend = (priceData?.changePercent || 0) / 5;
                const volatility = priceData?.volatility || 0.01;
                
                let direction, confidence;

                // Market-specific signal logic
                if (this.priceManager.currentMarket === 'volatility') {
                    if (rsi < 25 && trend > 0.05) {
                        direction = Math.random() > 0.4 ? 'STRONG_BUY' : 'BUY';
                    } else if (rsi > 75 && trend < -0.05) {
                        direction = Math.random() > 0.4 ? 'STRONG_SELL' : 'SELL';
                    } else if (Math.abs(trend) > 0.04) {
                        direction = trend > 0 ? 'BUY' : 'SELL';
                    }
                } else if (this.priceManager.currentMarket === 'synthetic') {
                    // Boom/Crash indices have more extreme signals
                    if (rsi < 20 && trend > 0.1) {
                        direction = 'STRONG_BUY';
                    } else if (rsi > 80 && trend < -0.1) {
                        direction = 'STRONG_SELL';
                    } else if (Math.abs(trend) > 0.06) {
                        direction = trend > 0 ? 'BUY' : 'SELL';
                    }
                } else if (this.priceManager.currentMarket === 'jump') {
                    if (rsi < 30 && trend > 0.03) {
                        direction = Math.random() > 0.3 ? 'STRONG_BUY' : 'BUY';
                    } else if (rsi > 70 && trend < -0.03) {
                        direction = Math.random() > 0.3 ? 'STRONG_SELL' : 'SELL';
                    }
                } else if (this.priceManager.currentMarket === 'forex') {
                    if (rsi < 30 && trend > 0.01) {
                        direction = Math.random() > 0.4 ? 'STRONG_BUY' : 'BUY';
                    } else if (rsi > 70 && trend < -0.01) {
                        direction = Math.random() > 0.4 ? 'STRONG_SELL' : 'SELL';
                    } else if (Math.abs(trend) > 0.02) {
                        direction = trend > 0 ? 'BUY' : 'SELL';
                    }
                } else if (this.priceManager.currentMarket === 'commodities') {
                    if (rsi < 25 && trend > 0.05) {
                        direction = symbol.includes('BTC') ? 'STRONG_BUY' : 'BUY';
                    } else if (rsi > 75 && trend < -0.05) {
                        direction = symbol.includes('BTC') ? 'STRONG_SELL' : 'SELL';
                    } else if (Math.abs(trend) > 0.03) {
                        direction = trend > 0 ? 'BUY' : 'SELL';
                    }
                }

                if (!direction) {
                    if (Math.random() > 0.6) {
                        direction = Math.random() > 0.5 ? 'BUY' : 'SELL';
                    } else {
                        return null;
                    }
                }

                // Confidence calculation
                if (direction.includes('STRONG')) {
                    confidence = 0.80 + Math.random() * 0.15;
                } else {
                    confidence = 0.65 + Math.random() * 0.20;
                }

                // Position sizing based on volatility
                const riskMultiplier = 1.5 + (volatility * 100);
                let stopLoss, takeProfit;

                if (direction.includes('BUY')) {
                    stopLoss = currentPrice * (1 - volatility * riskMultiplier);
                    takeProfit = currentPrice * (1 + volatility * riskMultiplier * 1.5);
                } else {
                    stopLoss = currentPrice * (1 + volatility * riskMultiplier);
                    takeProfit = currentPrice * (1 - volatility * riskMultiplier * 1.5);
                }

                stopLoss = Math.max(0.0001, stopLoss);
                takeProfit = Math.max(0.0001, takeProfit);

                const patterns = this.generatePatterns(direction, rsi, trend, symbol);

                const signal = {
                    symbol: symbol,
                    direction: direction,
                    confidence: Math.round(confidence * 100) / 100,
                    entry_price: this.formatSignalPrice(currentPrice, symbol),
                    stop_loss: this.formatSignalPrice(stopLoss, symbol),
                    take_profit: this.formatSignalPrice(takeProfit, symbol),
                    rsi: rsi.toFixed(1),
                    patterns: patterns,
                    timestamp: new Date().toISOString(),
                    current_change: (priceData?.changePercent || 0).toFixed(2),
                    market: this.priceManager.currentMarket
                };
                
                // Store in history (keep last 100 signals)
                this.signalHistory.unshift(signal);
                if (this.signalHistory.length > 100) {
                    this.signalHistory.pop();
                }
                
                return signal;
            }

            formatSignalPrice(price, symbol) {
                if (this.priceManager.markets.volatility.includes(symbol)) {
                    return price.toFixed(2);
                } else if (this.priceManager.markets.synthetic.includes(symbol)) {
                    return price.toFixed(2);
                } else if (this.priceManager.markets.jump.includes(symbol)) {
                    return price.toFixed(2);
                } else if (this.priceManager.markets.forex.includes(symbol)) {
                    return symbol.includes('JPY') ? price.toFixed(2) : price.toFixed(4);
                } else if (this.priceManager.markets.commodities.includes(symbol)) {
                    return price.toFixed(2);
                } else {
                    return price.toFixed(2);
                }
            }

            generatePatterns(direction, rsi, trend, symbol) {
                const patterns = [];
                
                // RSI patterns
                if (rsi < 25) patterns.push('RSI Oversold');
                else if (rsi > 75) patterns.push('RSI Overbought');
                else if (rsi > 55) patterns.push('RSI Bullish');
                else if (rsi < 45) patterns.push('RSI Bearish');
                
                // Trend patterns
                if (Math.abs(trend) > 0.03) patterns.push('Strong Trend');
                else if (Math.abs(trend) > 0.01) patterns.push('Trending');
                else patterns.push('Range Bound');
                
                // Asset-specific patterns
                if (this.priceManager.markets.volatility.includes(symbol)) {
                    patterns.push('Volatility Index');
                } else if (this.priceManager.markets.synthetic.includes(symbol)) {
                    patterns.push(symbol.includes('Boom') ? 'Boom Index' : 'Crash Index');
                } else if (this.priceManager.markets.jump.includes(symbol)) {
                    patterns.push('Jump Index');
                } else if (this.priceManager.markets.forex.includes(symbol)) {
                    patterns.push('Forex Pair');
                } else if (this.priceManager.markets.commodities.includes(symbol)) {
                    patterns.push(symbol.includes('Gold') ? 'Gold' : 
                                 symbol.includes('Silver') ? 'Silver' : 
                                 symbol.includes('Oil') ? 'Oil' : 
                                 symbol.includes('BTC') ? 'Bitcoin' : 'Commodity');
                }
                
                // Direction patterns
                if (direction.includes('STRONG')) {
                    patterns.push('High Momentum');
                }
                
                return patterns.slice(0, 4);
            }

            async generateSignals() {
                const signals = [];
                const attempts = this.getCurrentSymbols().length * 3;
                let generated = 0;
                
                while (signals.length < 4 && generated < attempts) {
                    const signal = this.generateSignal();
                    if (signal && !this.activeSignals.has(signal.symbol)) {
                        signals.push(signal);
                        this.activeSignals.add(signal.symbol);
                    }
                    generated++;
                }
                
                // Update market signal counts
                this.marketSignals[this.priceManager.currentMarket] = signals.length;
                this.updateMarketHighlights();
                
                // Auto-clear signals after 2 minutes
                setTimeout(() => {
                    signals.forEach(signal => {
                        this.activeSignals.delete(signal.symbol);
                    });
                }, 120000);
                
                return signals;
            }

            updateMarketHighlights() {
                document.getElementById('volatilityCount').textContent = this.marketSignals.volatility;
                document.getElementById('syntheticCount').textContent = this.marketSignals.synthetic;
                document.getElementById('commodityCount').textContent = this.marketSignals.commodities;
                document.getElementById('forexCount').textContent = this.marketSignals.forex;
            }
        }

        // Dashboard Controller with Auto-Refresh
        let currentSignals = [];
        let countdown = 60;
        let priceManager, engine;
        let refreshInterval;

        function initializeDashboard() {
            try {
                priceManager = new PriceManager();
                engine = new SignalEngine(priceManager);
                
                priceManager.initializePriceTicker();
                priceManager.startPriceUpdates();
                
                setupMarketSelector();
                updateDashboard();
                
                // Set up auto-refresh every 60 seconds
                refreshInterval = setInterval(updateDashboard, 1000);
                
                console.log('✅ Dashboard initialized successfully');
                
            } catch (error) {
                console.error('❌ Dashboard initialization failed:', error);
                document.getElementById('signalsContainer').innerHTML = 
                    '<div class="no-signals">System initialization failed. Please refresh.</div>';
            }
        }

        function setupMarketSelector() {
            const buttons = document.querySelectorAll('.market-btn');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    buttons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const market = this.dataset.market;
                    const symbols = priceManager.setMarket(market);
                    
                    // Clear current signals when changing market
                    currentSignals = [];
                    document.getElementById('signalsCount').textContent = '0';
                    document.getElementById('signalsContainer').innerHTML = 
                        '<div class="no-signals">Generating signals for ' + market + '...</div>';
                });
            });
        }

        function updateCountdown() {
            countdown--;
            if (countdown <= 0) {
                countdown = 60;
                // Trigger signal generation when countdown resets
                generateNewSignals();
            }
            document.getElementById('nextUpdate').innerHTML = `<span class="refresh-spinner"></span>${countdown}s`;
        }

        async function generateNewSignals() {
            try {
                const newSignals = await engine.generateSignals();
                currentSignals = newSignals;
                document.getElementById('signalsCount').textContent = currentSignals.length;
                displaySignals(currentSignals);
            } catch (error) {
                console.error('Signal generation error:', error);
            }
        }

        async function updateDashboard() {
            try {
                updateCountdown();
            } catch (error) {
                console.error('Dashboard update error:', error);
            }
        }

        function displaySignals(signals) {
            const container = document.getElementById('signalsContainer');
            
            if (!signals || signals.length === 0) {
                container.innerHTML = `
                    <div class="no-signals">
                        <div>No strong signals detected</div>
                        <div style="font-size: 0.8rem; margin-top: 10px; opacity: 0.7;">
                            Analyzing ${priceManager.currentMarket} market conditions...
                        </div>
                    </div>
                `;
                return;
            }

            try {
                container.innerHTML = signals.map(signal => {
                    const priceChange = parseFloat(signal.current_change || 0);
                    const changeClass = priceChange >= 0 ? 'price-up' : 'price-down';
                    const changeSign = priceChange >= 0 ? '+' : '';
                    
                    return `
                    <div class="signal ${signal.direction}">
                        <div class="signal-header">
                            <span class="symbol">${signal.symbol}</span>
                            <span class="direction">${signal.direction.replace('_', ' ')}</span>
                            <span class="confidence">${Math.round((signal.confidence || 0.7) * 100)}%</span>
                        </div>
                        
                        <div class="signal-details">
                            <div class="detail-item">
                                <span>Entry</span>
                                <span>${signal.entry_price}</span>
                            </div>
                            <div class="detail-item">
                                <span>Stop</span>
                                <span style="color: var(--danger)">${signal.stop_loss}</span>
                            </div>
                            <div class="detail-item">
                                <span>Target</span>
                                <span style="color: var(--success)">${signal.take_profit}</span>
                            </div>
                            <div class="detail-item">
                                <span>RSI</span>
                                <span>${signal.rsi}</span>
                            </div>
                        </div>
                        
                        <div class="patterns">
                            ${(signal.patterns || []).map(pattern => 
                                `<span class="pattern-tag">${pattern}</span>`
                            ).join('')}
                            <span class="pattern-tag ${changeClass}">
                                ${changeSign}${priceChange.toFixed(2)}%
                            </span>
                        </div>
                        
                        <div class="timestamp">
                            ${new Date(signal.timestamp).toLocaleTimeString()}
                        </div>
                    </div>
                `}).join('');
            } catch (error) {
                console.error('Error displaying signals:', error);
                container.innerHTML = '<div class="no-signals">Error displaying signals</div>';
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Starting MasterShifu V2 Dashboard...');
            initializeDashboard();
        });

        // Handle page errors gracefully
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });
    </script>
</body>
</html>
