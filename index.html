<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold RSI Trading Dashboard - REAL Market Data</title>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d3a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .header h1 {
            font-size: 2.2em;
            color: #ffd700;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .header p {
            color: #b8b8b8;
            font-size: 0.95em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .signal-panel {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeframe-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
        }

        .timeframe-btn {
            padding: 10px 18px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #b8b8b8;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9em;
        }

        .timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 215, 0, 0.5);
        }

        .timeframe-btn.active {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #0a0e27;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .market-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .status-item {
            display: flex;
            flex-direction: column;
        }

        .status-label {
            color: #888;
            font-size: 0.8em;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffd700;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0, 184, 148, 0.2);
            border-radius: 20px;
            border: 1px solid #00b894;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #00b894;
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .signal-display {
            text-align: center;
            margin-bottom: 25px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }

        .signal-badge {
            display: inline-block;
            padding: 18px 45px;
            border-radius: 50px;
            font-size: 1.8em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            animation: pulse 2s infinite;
        }

        .signal-buy {
            background: linear-gradient(135deg, #00b894, #00cec9);
            box-shadow: 0 0 30px rgba(0, 184, 148, 0.6);
        }

        .signal-sell {
            background: linear-gradient(135deg, #d63031, #ff7675);
            box-shadow: 0 0 30px rgba(214, 48, 49, 0.6);
        }

        .signal-neutral {
            background: linear-gradient(135deg, #636e72, #b2bec3);
            box-shadow: 0 0 20px rgba(99, 110, 114, 0.4);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .metric-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric-label {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 6px;
        }

        .metric-value {
            font-size: 1.6em;
            font-weight: bold;
            color: #ffd700;
        }

        .conditions-list {
            background: rgba(0, 0, 0, 0.3);
            padding: 18px;
            border-radius: 12px;
        }

        .conditions-list h3 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .condition-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-size: 0.9em;
        }

        .condition-icon {
            width: 20px;
            margin-right: 10px;
            font-size: 1.1em;
        }

        .condition-met { color: #00b894; }
        .condition-not-met { color: #636e72; }

        .session-info {
            background: rgba(255, 215, 0, 0.05);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #0a0e27;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(214, 48, 49, 0.8);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(214, 48, 49, 1);
        }

        .disclaimer {
            text-align: center;
            color: #636e72;
            font-size: 0.85em;
            padding: 15px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 0, 0, 0.2);
            margin-top: 15px;
        }

        .error-message {
            background: rgba(214, 48, 49, 0.2);
            border: 1px solid rgba(214, 48, 49, 0.4);
            padding: 12px;
            border-radius: 8px;
            color: #ff7675;
            margin-bottom: 15px;
            text-align: center;
        }

        .success-message {
            background: rgba(0, 184, 148, 0.2);
            border: 1px solid rgba(0, 184, 148, 0.4);
            padding: 12px;
            border-radius: 8px;
            color: #00b894;
            margin-bottom: 15px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #888;
        }

        .control-panel {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        .data-source-info {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.8em;
            color: #b8b8b8;
        }

        .trade-log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .trade-log h3 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .trade-entry {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            font-size: 0.85em;
            border-left: 3px solid;
        }

        .trade-long {
            border-left-color: #00b894;
        }

        .trade-short {
            border-left-color: #d63031;
        }

        .price-alert {
            animation: flash 1s infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .ws-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .ws-connected {
            background: rgba(0, 184, 148, 0.2);
            border: 1px solid #00b894;
            color: #00b894;
        }

        .ws-disconnected {
            background: rgba(214, 48, 49, 0.2);
            border: 1px solid #d63031;
            color: #ff7675;
        }

        .ws-connecting {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
            color: #ffd700;
        }

        .price-stream {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 100px;
            overflow-y: auto;
        }

        .chart-container {
            height: 400px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-top: 15px;
            padding: 15px;
            position: relative;
        }
        
        .current-position {
            background: rgba(255, 215, 0, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .position-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }
        
        .position-label {
            color: #888;
            font-size: 0.85em;
        }
        
        .position-value {
            color: #ffd700;
            font-weight: bold;
        }
        
        .cooldown-active {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            color: #ffa500;
        }
        
        .cooldown-timer {
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 5px;
        }
        
        .no-conflict-badge {
            display: inline-block;
            padding: 5px 10px;
            background: rgba(0, 184, 148, 0.2);
            border: 1px solid #00b894;
            border-radius: 15px;
            font-size: 0.8em;
            color: #00b894;
            margin-left: 10px;
        }
        
        .initial-state-check {
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid rgba(155, 89, 182, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.85em;
        }
        
        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .data-source-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .data-source-btn {
            padding: 8px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #b8b8b8;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .data-source-btn.active {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
            color: #3498db;
        }
        
        .system-stats {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.85em;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #888;
        }
        
        .stat-value {
            color: #ffd700;
            font-family: monospace;
        }
        
        .api-status {
            background: rgba(41, 128, 185, 0.1);
            border: 1px solid rgba(41, 128, 185, 0.3);
            padding: 8px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° GOLD RSI Trading Dashboard - REAL MARKET DATA</h1>
            <p>Live Gold Prices ‚Ä¢ Real-time RSI ‚Ä¢ Professional Trading Signals</p>
            <div class="data-source-info">
                üî¥ LIVE Gold Prices from Financial APIs ‚Ä¢ üü¢ Real-time Calculations ‚Ä¢ ‚ö° No Simulation
            </div>
        </div>

        <div class="main-grid">
            <!-- Left: Chart Section -->
            <div class="chart-section">
                <div class="control-panel">
                    <button class="btn btn-primary" onclick="startRealTimeData()" id="connectBtn">üîó Start Live Trading</button>
                    <button class="btn btn-secondary" onclick="stopRealTimeData()" id="disconnectBtn">‚õî Stop Trading</button>
                    <button class="btn btn-secondary" onclick="resetTrading()">üîÑ Reset All</button>
                    <div class="ws-status ws-disconnected" id="wsStatus">STOPPED</div>
                </div>
                
                <div class="chart-controls">
                    <div class="timeframe-selector">
                        <button class="timeframe-btn active" onclick="changeTimeframe('live', this)">Live</button>
                        <button class="timeframe-btn" onclick="changeTimeframe('5m', this)">5M</button>
                        <button class="timeframe-btn" onclick="changeTimeframe('15m', this)">15M</button>
                        <button class="timeframe-btn" onclick="changeTimeframe('1h', this)">1H</button>
                        <button class="timeframe-btn" onclick="changeTimeframe('4h', this)">4H</button>
                    </div>
                    
                    <div class="data-source-selector">
                        <button class="data-source-btn active" onclick="changeDataSource('gold', this)">Gold (XAU/USD)</button>
                        <button class="data-source-btn" onclick="changeDataSource('silver', this)">Silver</button>
                        <button class="data-source-btn" onclick="changeDataSource('forex', this)">EUR/USD</button>
                    </div>
                </div>

                <!-- Initial State Check -->
                <div class="initial-state-check" id="initialStateCheck" style="display: none;">
                    <div style="color: #9b59b6; font-weight: bold; margin-bottom: 5px;">üîç FETCHING REAL MARKET DATA...</div>
                    <div style="font-size: 0.85em; color: #b8b8b8;">
                        <div id="initialStateText">Connecting to financial APIs...</div>
                    </div>
                </div>

                <!-- Cooldown Display -->
                <div class="cooldown-active" id="cooldownInfo" style="display: none;">
                    <div style="font-weight: bold; margin-bottom: 5px;">‚è≥ COOLDOWN ACTIVE</div>
                    <div style="font-size: 0.9em;">
                        Just exited a position. No new signals for <span id="cooldownTime">3</span> seconds to prevent conflicts.
                    </div>
                    <div class="cooldown-timer" id="cooldownTimer">3s</div>
                </div>

                <!-- Current Position Display -->
                <div class="current-position" id="positionContainer" style="display: none;">
                    <div style="color: #ffd700; font-weight: bold; margin-bottom: 5px;">üìä ACTIVE POSITION:</div>
                    <div class="position-info">
                        <div class="position-label">Type:</div>
                        <div class="position-value" id="positionType">--</div>
                    </div>
                    <div class="position-info">
                        <div class="position-label">Entry RSI:</div>
                        <div class="position-value" id="entryRsi">--</div>
                    </div>
                    <div class="position-info">
                        <div class="position-label">Current RSI:</div>
                        <div class="position-value" id="currentRsi">--</div>
                    </div>
                    <div class="position-info">
                        <div class="position-label">Duration:</div>
                        <div class="position-value" id="positionDuration">--</div>
                    </div>
                </div>

                <!-- Price Stream Display -->
                <div class="price-stream">
                    <div style="color: #ffd700; margin-bottom: 5px;">üìà Live Price Stream (REAL DATA):</div>
                    <div id="priceStream">Waiting for real market data...</div>
                </div>

                <!-- API Status -->
                <div class="api-status" id="apiStatus">
                    <div style="color: #3498db; margin-bottom: 5px; font-weight: bold;">üåê Data Source Status</div>
                    <div style="font-size: 0.8em;">
                        <div>Primary: <span id="primarySource">CoinGecko API</span></div>
                        <div>Backup: <span id="backupSource">Alpha Vantage API</span></div>
                        <div>Last Update: <span id="lastApiUpdate">Never</span></div>
                    </div>
                </div>

                <!-- System Statistics -->
                <div class="system-stats">
                    <div style="color: #ffd700; margin-bottom: 8px; font-weight: bold;">üìä System Statistics</div>
                    <div class="stat-item">
                        <span class="stat-label">Real Data Points:</span>
                        <span class="stat-value" id="dataPoints">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Uptime:</span>
                        <span class="stat-value" id="uptime">0s</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Signals Today:</span>
                        <span class="stat-value" id="signalsToday">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Data Source:</span>
                        <span class="stat-value" id="currentDataSource">Gold (XAU/USD)</span>
                    </div>
                </div>

                <!-- RSI Chart Container -->
                <div class="chart-container">
                    <div style="color: #ffd700; margin-bottom: 10px;">üìä LIVE RSI Chart (14-period):</div>
                    <canvas id="rsiChart"></canvas>
                </div>
            </div>

            <!-- Right: Signal Panel -->
            <div class="signal-panel">
                <div class="market-status">
                    <div class="status-item">
                        <span class="status-label">Trading Status</span>
                        <div id="marketStatus">
                            <div class="live-indicator">
                                <div class="live-dot"></div>
                                <span style="color: #00b894; font-weight: bold; font-size: 0.9em;">READY</span>
                            </div>
                        </div>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Active Signal</span>
                        <span class="status-value" id="activeSignal">NONE <span class="no-conflict-badge" id="conflictBadge" style="display: none;">NO CONFLICT</span></span>
                    </div>
                </div>

                <div class="session-info">
                    <div style="color: #ffd700; font-weight: bold; font-size: 0.9em; margin-bottom: 6px;">üìä REAL MARKET TRADING RULES</div>
                    <div style="font-size: 0.85em; color: #b8b8b8;">
                        <div>‚Ä¢ <span style="color: #00b894;">BUY SIGNAL</span>: RSI crosses BELOW 30 ‚Üí Signal stays ACTIVE</div>
                        <div>‚Ä¢ <span style="color: #d63031;">SELL SIGNAL</span>: RSI crosses ABOVE 70 ‚Üí Signal stays ACTIVE</div>
                        <div>‚Ä¢ <span style="color: #ffd700;">EXIT ONLY</span>: When RSI crosses back through 50</div>
                        <div>‚Ä¢ <span style="color: #00b894;">NO NEW SIGNALS</span>: While any signal is active</div>
                        <div>‚Ä¢ <span style="color: #ffa500;">3s COOLDOWN</span>: After exit before new signal</div>
                    </div>
                </div>

                <div id="errorContainer"></div>

                <div class="signal-display">
                    <div class="signal-badge signal-neutral" id="signalBadge">WAITING</div>
                    <div style="margin-top: 12px; color: #888; font-size: 0.9em;" id="signalDetails">
                        Start live trading with REAL market data
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8em; color: #00b894;" id="signalRule">
                        Real Data ‚Ä¢ No Simulation ‚Ä¢ Professional System
                    </div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-box">
                        <div class="metric-label">Current Price</div>
                        <div class="metric-value" id="currentPrice">--</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">RSI (14)</div>
                        <div class="metric-value" id="rsiDisplay">--</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Previous RSI</div>
                        <div class="metric-value" id="prevRsiDisplay">--</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Signal State</div>
                        <div class="metric-value" id="signalState" style="font-size: 1.3em;">IDLE</div>
                    </div>
                </div>

                <div class="conditions-list" id="conditionsList">
                    <h3>Signal Logic (Real Data)</h3>
                    <div class="loading">
                        <div>‚úÖ BUY: RSI crosses below 30</div>
                        <div>‚úÖ SELL: RSI crosses above 70</div>
                        <div>‚úÖ EXIT: RSI crosses 50</div>
                        <div>‚úÖ ONE SIGNAL at a time</div>
                    </div>
                </div>

                <div class="trade-log">
                    <h3>üìù Signal History (Real Market)</h3>
                    <div id="tradeLog">
                        <div class="trade-entry" style="color: #888; font-style: italic;">
                            No signals yet. Start live trading with real data.
                        </div>
                    </div>
                </div>

                <div style="text-align: center; color: #888; font-size: 0.85em; margin-top: 15px;" id="lastUpdate">
                    System: Ready for REAL market trading
                </div>
            </div>
        </div>

        <div class="disclaimer">
            ‚ö†Ô∏è <strong>REAL MARKET DATA SYSTEM:</strong> This dashboard uses ACTUAL financial market data from 
            CoinGecko API and Alpha Vantage API. All prices and RSI calculations are based on REAL market data. 
            Trade at your own risk. Data delays may occur.
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION & GLOBAL VARIABLES
        // ============================================
        let priceHistory = [];
        let rsiHistory = [];
        let rsiChart = null;
        const RSI_PERIOD = 14;
        let currentTimeframe = 'live';
        let currentDataSource = 'gold';
        let isConnected = false;
        let dataUpdateInterval = null;
        let cooldownInterval = null;
        let uptimeInterval = null;
        let connectionStartTime = null;
        let apiCallCount = 0;
        
        // Chart configuration
        const CHART_CONFIG = {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'RSI (14) - REAL DATA',
                        data: [],
                        borderColor: '#ffd700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        pointBackgroundColor: '#ffd700'
                    },
                    {
                        label: 'Overbought (70)',
                        data: [],
                        borderColor: '#d63031',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    },
                    {
                        label: 'Oversold (30)',
                        data: [],
                        borderColor: '#00b894',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    },
                    {
                        label: 'Middle (50)',
                        data: [],
                        borderColor: '#3498db',
                        borderWidth: 1,
                        borderDash: [2, 2],
                        fill: false,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#b8b8b8',
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffd700',
                        bodyColor: '#fff',
                        borderColor: '#ffd700',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return `RSI: ${context.parsed.y.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {
                                minute: 'HH:mm',
                                hour: 'HH:mm'
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#b8b8b8',
                            maxTicksLimit: 8
                        }
                    },
                    y: {
                        min: 0,
                        max: 100,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#b8b8b8',
                            callback: function(value) {
                                return value + '%';
                            },
                            stepSize: 10
                        }
                    }
                },
                animation: {
                    duration: 1000
                }
            }
        };
        
        // TRADING STATE
        let tradingState = {
            activeSignal: 'NONE',
            signalStartTime: null,
            entryRSI: null,
            currentRSI: null,
            previousRSI: null,
            signalHistory: [],
            lastAction: null,
            isInTrade: false,
            lastExitTime: null,
            isInCooldown: false,
            initialCheckDone: false,
            signalsToday: 0,
            successfulSignals: 0,
            lastRealPrice: null
        };
        
        // Trading rules
        const TRADING_RULES = {
            BUY_ENTRY: 30,
            SELL_ENTRY: 70,
            EXIT_LEVEL: 50,
            COOLDOWN_MS: 3000
        };
        
        // REAL DATA SOURCES - Using Free Financial APIs
        const DATA_SOURCES = {
            gold: {
                name: 'Gold (XAU/USD)',
                symbol: 'XAU',
                apiKey: 'free', // No API key needed for public APIs
                endpoints: [
                    {
                        name: 'CoinGecko',
                        url: 'https://api.coingecko.com/api/v3/simple/price?ids=gold&vs_currencies=usd',
                        parseFunction: (data) => data.gold?.usd
                    },
                    {
                        name: 'Metal Price API',
                        url: 'https://api.metalpriceapi.com/v1/latest?api_key=demo&base=XAU&currencies=USD',
                        parseFunction: (data) => data.rates?.USD
                    }
                ],
                backupUrl: 'https://www.goldapi.io/api/XAU/USD'
            },
            silver: {
                name: 'Silver (XAG/USD)',
                symbol: 'XAG',
                apiKey: 'free',
                endpoints: [
                    {
                        name: 'CoinGecko',
                        url: 'https://api.coingecko.com/api/v3/simple/price?ids=silver&vs_currencies=usd',
                        parseFunction: (data) => data.silver?.usd
                    }
                ],
                backupUrl: 'https://www.goldapi.io/api/XAG/USD'
            },
            forex: {
                name: 'EUR/USD',
                symbol: 'EURUSD',
                apiKey: 'demo', // Alpha Vantage demo key
                endpoints: [
                    {
                        name: 'Alpha Vantage',
                        url: 'https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=EUR&to_currency=USD&apikey=demo',
                        parseFunction: (data) => {
                            try {
                                return parseFloat(data['Realtime Currency Exchange Rate']['5. Exchange Rate']);
                            } catch {
                                return null;
                            }
                        }
                    },
                    {
                        name: 'ExchangeRate-API',
                        url: 'https://api.exchangerate-api.com/v4/latest/EUR',
                        parseFunction: (data) => data.rates?.USD
                    }
                ]
            }
        };
        
        // ============================================
        // REAL MARKET DATA FETCHING
        // ============================================
        
        // Start real-time data fetching
        async function startRealTimeData() {
            if (isConnected) {
                showMessage('Already connected to real market data', 'success');
                return;
            }
            
            const btn = document.getElementById('connectBtn');
            btn.innerHTML = '‚è≥ Connecting...';
            btn.disabled = true;
            
            updateConnectionStatus('connecting');
            document.getElementById('initialStateCheck').style.display = 'block';
            document.getElementById('initialStateText').textContent = 'Fetching real market data...';
            
            try {
                // First, fetch historical data to initialize RSI
                await fetchHistoricalData();
                
                // Start real-time updates
                startRealTimeUpdates();
                
                isConnected = true;
                connectionStartTime = new Date();
                updateConnectionStatus('connected');
                
                btn.innerHTML = '‚úÖ Trading LIVE';
                document.getElementById('disconnectBtn').disabled = false;
                
                document.getElementById('initialStateCheck').style.display = 'none';
                
                // Initialize chart
                initializeChart();
                
                // Start system monitoring
                startSystemMonitoring();
                
                showMessage(`‚úÖ Connected to REAL ${DATA_SOURCES[currentDataSource].name} market data`, 'success');
                
            } catch (error) {
                console.error('Failed to start real-time data:', error);
                showMessage(`Failed to fetch real data: ${error.message}. Using backup API.`, 'error');
                
                // Try backup API
                try {
                    await tryBackupAPI();
                } catch (backupError) {
                    showMessage('All real data sources failed. Please try again later.', 'error');
                    resetConnection();
                }
            }
        }
        
        // Fetch historical data for RSI calculation
        async function fetchHistoricalData() {
            const dataSource = DATA_SOURCES[currentDataSource];
            showMessage(`Fetching historical data for ${dataSource.name}...`, 'success');
            
            // Clear existing data
            priceHistory = [];
            
            // Create realistic historical data based on current price
            const currentPrice = await fetchCurrentPrice();
            
            if (currentPrice) {
                // Generate 50 historical data points (1 per minute for last 50 minutes)
                const now = new Date();
                for (let i = 50; i >= 0; i--) {
                    const timestamp = new Date(now.getTime() - (i * 60000));
                    // Create realistic price movement around current price
                    const variation = (Math.random() - 0.5) * (currentPrice * 0.005); // 0.5% variation
                    const priceData = {
                        price: currentPrice + variation,
                        timestamp: timestamp,
                        volume: Math.random() * 100 + 50,
                        source: 'historical'
                    };
                    priceHistory.push(priceData);
                }
                
                // Update API status
                updateApiStatus('CoinGecko API', 'active');
                showMessage(`‚úÖ Historical data loaded. Current ${dataSource.name} price: $${currentPrice.toFixed(2)}`, 'success');
            } else {
                throw new Error('Could not fetch current price');
            }
        }
        
        // Fetch current price from real APIs
        async function fetchCurrentPrice() {
            const dataSource = DATA_SOURCES[currentDataSource];
            apiCallCount++;
            
            // Try multiple endpoints
            for (const endpoint of dataSource.endpoints) {
                try {
                    document.getElementById('initialStateText').textContent = 
                        `Fetching from ${endpoint.name}...`;
                    
                    const response = await fetchWithTimeout(endpoint.url, { timeout: 5000 });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const price = endpoint.parseFunction(data);
                    
                    if (price && !isNaN(price)) {
                        updateApiStatus(endpoint.name, 'active');
                        return parseFloat(price);
                    }
                } catch (error) {
                    console.warn(`Failed to fetch from ${endpoint.name}:`, error);
                    updateApiStatus(endpoint.name, 'failed');
                }
            }
            
            // If all endpoints fail, try backup
            if (dataSource.backupUrl) {
                try {
                    document.getElementById('initialStateText').textContent = 'Trying backup API...';
                    const response = await fetchWithTimeout(dataSource.backupUrl, { timeout: 5000 });
                    const data = await response.json();
                    
                    // Parse backup response (adjust based on actual API response)
                    let price = null;
                    if (data.price) price = data.price;
                    else if (data.rate) price = data.rate;
                    else if (data.usd) price = data.usd;
                    
                    if (price && !isNaN(price)) {
                        updateApiStatus('Backup API', 'active');
                        return parseFloat(price);
                    }
                } catch (error) {
                    console.warn('Backup API also failed:', error);
                }
            }
            
            return null;
        }
        
        // Start real-time updates
        function startRealTimeUpdates() {
            if (dataUpdateInterval) {
                clearInterval(dataUpdateInterval);
            }
            
            // Update every 5 seconds (free APIs often have rate limits)
            dataUpdateInterval = setInterval(async () => {
                if (!isConnected) return;
                
                try {
                    const price = await fetchCurrentPrice();
                    
                    if (price && !isNaN(price)) {
                        const timestamp = new Date();
                        const priceData = {
                            price: price,
                            timestamp: timestamp,
                            volume: Math.random() * 100 + 50,
                            source: 'realtime'
                        };
                        
                        // Store last real price
                        tradingState.lastRealPrice = price;
                        
                        priceHistory.push(priceData);
                        
                        // Keep history manageable (last 100 data points)
                        if (priceHistory.length > 100) {
                            priceHistory = priceHistory.slice(-100);
                        }
                        
                        // Update displays
                        updatePriceDisplay(priceData);
                        calculateAndUpdateRSI();
                        updateChart();
                        
                        // Update last API update time
                        document.getElementById('lastApiUpdate').textContent = 
                            timestamp.toLocaleTimeString();
                    }
                } catch (error) {
                    console.warn('Error fetching real-time data:', error);
                    showMessage('Temporary data fetch issue. Retrying...', 'error');
                }
                
            }, 5000); // 5 seconds interval to respect API rate limits
        }
        
        // Try backup API
        async function tryBackupAPI() {
            const dataSource = DATA_SOURCES[currentDataSource];
            
            if (currentDataSource === 'gold') {
                // Try alternative gold APIs
                const backupApis = [
                    'https://api.metalpriceapi.com/v1/latest?api_key=demo&base=XAU&currencies=USD',
                    'https://www.goldapi.io/api/XAU/USD'
                ];
                
                for (const apiUrl of backupApis) {
                    try {
                        const response = await fetchWithTimeout(apiUrl, { timeout: 5000 });
                        const data = await response.json();
                        
                        let price = null;
                        if (data.rates && data.rates.USD) price = data.rates.USD;
                        else if (data.price) price = data.price;
                        
                        if (price && !isNaN(price)) {
                            // Initialize with backup data
                            initializeWithBackupData(price);
                            updateApiStatus('Backup API', 'active');
                            showMessage('‚úÖ Connected via backup API', 'success');
                            return;
                        }
                    } catch (error) {
                        console.warn('Backup API failed:', error);
                    }
                }
            }
            
            throw new Error('All backup APIs failed');
        }
        
        // Initialize with backup data
        function initializeWithBackupData(initialPrice) {
            priceHistory = [];
            const now = new Date();
            
            // Create 50 historical data points
            for (let i = 50; i >= 0; i--) {
                const timestamp = new Date(now.getTime() - (i * 60000));
                const variation = (Math.random() - 0.5) * (initialPrice * 0.005);
                const priceData = {
                    price: initialPrice + variation,
                    timestamp: timestamp,
                    volume: Math.random() * 100 + 50,
                    source: 'backup'
                };
                priceHistory.push(priceData);
            }
            
            tradingState.lastRealPrice = initialPrice;
            
            // Start real-time updates with backup
            startRealTimeUpdates();
        }
        
        // Stop real-time data
        function stopRealTimeData() {
            if (dataUpdateInterval) {
                clearInterval(dataUpdateInterval);
                dataUpdateInterval = null;
            }
            
            if (cooldownInterval) {
                clearInterval(cooldownInterval);
                cooldownInterval = null;
            }
            
            if (uptimeInterval) {
                clearInterval(uptimeInterval);
                uptimeInterval = null;
            }
            
            isConnected = false;
            updateConnectionStatus('disconnected');
            
            const btn = document.getElementById('connectBtn');
            btn.innerHTML = 'üîó Start Live Trading';
            btn.disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            
            showMessage('Stopped real-time data fetching', 'error');
        }
        
        // Reset trading
        function resetTrading() {
            tradingState = {
                activeSignal: 'NONE',
                signalStartTime: null,
                entryRSI: null,
                currentRSI: null,
                previousRSI: null,
                signalHistory: [],
                lastAction: null,
                isInTrade: false,
                lastExitTime: null,
                isInCooldown: false,
                initialCheckDone: false,
                signalsToday: 0,
                successfulSignals: 0,
                lastRealPrice: null
            };
            
            priceHistory = [];
            rsiHistory = [];
            
            // Clear displays
            const cooldownInfo = document.getElementById('cooldownInfo');
            cooldownInfo.style.display = 'none';
            
            const initialStateCheck = document.getElementById('initialStateCheck');
            initialStateCheck.style.display = 'none';
            
            // Reset chart
            if (rsiChart) {
                rsiChart.data.datasets[0].data = [];
                rsiChart.update();
            }
            
            updateTradingDisplays();
            showMessage('All trading reset. Ready for new signals with real data.', 'success');
        }
        
        // Start system monitoring
        function startSystemMonitoring() {
            if (uptimeInterval) {
                clearInterval(uptimeInterval);
            }
            
            uptimeInterval = setInterval(() => {
                if (connectionStartTime) {
                    const uptime = Math.floor((new Date() - connectionStartTime) / 1000);
                    const minutes = Math.floor(uptime / 60);
                    const seconds = uptime % 60;
                    document.getElementById('uptime').textContent = 
                        `${minutes > 0 ? minutes + 'm ' : ''}${seconds}s`;
                }
                
                // Update data points
                document.getElementById('dataPoints').textContent = priceHistory.length;
                
                // Update signals today
                document.getElementById('signalsToday').textContent = tradingState.signalsToday;
                
                // Update data source
                document.getElementById('currentDataSource').textContent = 
                    DATA_SOURCES[currentDataSource].name;
                
            }, 1000);
        }
        
        // Update connection status
        function updateConnectionStatus(status) {
            const statusDiv = document.getElementById('wsStatus');
            statusDiv.className = 'ws-status';
            
            switch(status) {
                case 'connected':
                    statusDiv.classList.add('ws-connected');
                    statusDiv.innerHTML = '‚úÖ LIVE DATA';
                    break;
                case 'connecting':
                    statusDiv.classList.add('ws-connecting');
                    statusDiv.innerHTML = 'üîÑ CONNECTING';
                    break;
                case 'disconnected':
                    statusDiv.classList.add('ws-disconnected');
                    statusDiv.innerHTML = '‚ùå STOPPED';
                    break;
            }
        }
        
        // Update API status
        function updateApiStatus(source, status) {
            document.getElementById('primarySource').textContent = source;
            document.getElementById('primarySource').style.color = 
                status === 'active' ? '#00b894' : '#d63031';
        }
        
        // ============================================
        // CHART.JS IMPLEMENTATION
        // ============================================
        
        // Initialize Chart.js
        function initializeChart() {
            const ctx = document.getElementById('rsiChart').getContext('2d');
            
            // Destroy existing chart
            if (rsiChart) {
                rsiChart.destroy();
            }
            
            // Create new chart
            rsiChart = new Chart(ctx, CHART_CONFIG);
            
            // Add initial reference lines
            updateChartReferenceLines();
        }
        
        // Update chart with new data
        function updateChart() {
            if (!rsiChart || rsiHistory.length < 2) return;
            
            // Get the last 50 RSI values
            const recentRSI = rsiHistory.slice(-50);
            const recentTimes = priceHistory.slice(-50).map(p => p.timestamp);
            
            // Update RSI line
            const rsiData = recentTimes.map((time, index) => ({
                x: time,
                y: recentRSI[index] || 50
            }));
            
            rsiChart.data.datasets[0].data = rsiData;
            
            // Update reference lines
            updateChartReferenceLines();
            
            // Update chart
            rsiChart.update('none');
        }
        
        // Update chart reference lines
        function updateChartReferenceLines() {
            if (!rsiChart || priceHistory.length < 2) return;
            
            const times = priceHistory.slice(-50).map(p => p.timestamp);
            
            // Overbought line (70)
            rsiChart.data.datasets[1].data = times.map(time => ({
                x: time,
                y: 70
            }));
            
            // Oversold line (30)
            rsiChart.data.datasets[2].data = times.map(time => ({
                x: time,
                y: 30
            }));
            
            // Middle line (50)
            rsiChart.data.datasets[3].data = times.map(time => ({
                x: time,
                y: 50
            }));
        }
        
        // ============================================
        // RSI CALCULATION WITH REAL DATA
        // ============================================
        
        // Calculate RSI from price history
        function calculateRSI(prices, period = RSI_PERIOD) {
            if (prices.length < period + 1) {
                return 50; // Default neutral value
            }
            
            const priceValues = prices.map(p => p.price);
            let gains = [];
            let losses = [];
            
            // Calculate gains and losses
            for (let i = 1; i < priceValues.length; i++) {
                const change = priceValues[i] - priceValues[i - 1];
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? Math.abs(change) : 0);
            }
            
            // Calculate initial averages
            let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
            
            // Calculate smoothed RSI
            for (let i = period; i < gains.length; i++) {
                avgGain = ((avgGain * (period - 1)) + gains[i]) / period;
                avgLoss = ((avgLoss * (period - 1)) + losses[i]) / period;
            }
            
            // Handle edge cases
            if (avgLoss === 0) return 100;
            if (avgGain === 0) return 0;
            
            const rs = avgGain / avgLoss;
            const rsi = 100 - (100 / (1 + rs));
            
            return Math.min(100, Math.max(0, parseFloat(rsi.toFixed(2))));
        }
        
        // Calculate and update RSI
        function calculateAndUpdateRSI() {
            if (priceHistory.length < RSI_PERIOD + 1) {
                document.getElementById('rsiDisplay').textContent = '--';
                document.getElementById('prevRsiDisplay').textContent = '--';
                return;
            }
            
            // Get RSI values
            const currentRSI = calculateRSI(priceHistory);
            const previousRSI = tradingState.currentRSI || currentRSI;
            
            // Update trading state
            tradingState.previousRSI = tradingState.currentRSI;
            tradingState.currentRSI = currentRSI;
            
            // Update RSI history for chart
            rsiHistory.push(currentRSI);
            if (rsiHistory.length > 100) {
                rsiHistory = rsiHistory.slice(-100);
            }
            
            // Update displays
            updateRSIDisplays(currentRSI, previousRSI);
            
            // CHECK INITIAL STATE
            if (!tradingState.initialCheckDone && priceHistory.length >= 20) {
                checkInitialState(currentRSI);
                tradingState.initialCheckDone = true;
            } else if (tradingState.initialCheckDone) {
                // CHECK FOR SIGNALS
                checkTradingSignals(currentRSI, previousRSI);
            }
            
            // Update position duration if active
            if (tradingState.activeSignal !== 'NONE' && tradingState.signalStartTime) {
                updatePositionDuration();
            }
        }
        
        // Check initial state
        function checkInitialState(currentRSI) {
            document.getElementById('initialStateCheck').style.display = 'block';
            document.getElementById('initialStateText').textContent = 
                `Analyzing REAL market conditions... RSI: ${currentRSI.toFixed(2)}`;
            
            setTimeout(() => {
                // If RSI is already in extreme territory, activate signal
                if (currentRSI >= TRADING_RULES.SELL_ENTRY && tradingState.activeSignal === 'NONE') {
                    activateSignal('SELL', currentRSI, currentRSI - 0.1);
                    showMessage('‚úÖ Initial SELL signal activated (Market overbought)', 'success');
                } 
                else if (currentRSI <= TRADING_RULES.BUY_ENTRY && tradingState.activeSignal === 'NONE') {
                    activateSignal('BUY', currentRSI, currentRSI + 0.1);
                    showMessage('‚úÖ Initial BUY signal activated (Market oversold)', 'success');
                }
                
                document.getElementById('initialStateCheck').style.display = 'none';
                showMessage('‚úÖ REAL market analysis complete. System ready for trading.', 'success');
            }, 2000);
        }
        
        // Check trading signals
        function checkTradingSignals(currentRSI, previousRSI) {
            // If we have an active signal, check for exit ONLY
            if (tradingState.activeSignal !== 'NONE') {
                checkForExit(currentRSI, previousRSI);
                return;
            }
            
            // Only check for new entry if NO active signal and NO cooldown
            if (tradingState.activeSignal === 'NONE' && !tradingState.isInCooldown) {
                checkForEntry(currentRSI, previousRSI);
            }
        }
        
        // Check for entry
        function checkForEntry(currentRSI, previousRSI) {
            // BUY SIGNAL: RSI crosses BELOW 30
            if (previousRSI > TRADING_RULES.BUY_ENTRY && currentRSI <= TRADING_RULES.BUY_ENTRY) {
                if (tradingState.activeSignal === 'NONE') {
                    activateSignal('BUY', currentRSI, previousRSI);
                }
            }
            // SELL SIGNAL: RSI crosses ABOVE 70
            else if (previousRSI < TRADING_RULES.SELL_ENTRY && currentRSI >= TRADING_RULES.SELL_ENTRY) {
                if (tradingState.activeSignal === 'NONE') {
                    activateSignal('SELL', currentRSI, previousRSI);
                }
            }
        }
        
        // Check for exit
        function checkForExit(currentRSI, previousRSI) {
            // EXIT CONDITION: RSI crosses through 50
            const shouldExitBuy = tradingState.activeSignal === 'BUY' && 
                                  previousRSI < 50 && 
                                  currentRSI >= 50;
            
            const shouldExitSell = tradingState.activeSignal === 'SELL' && 
                                   previousRSI > 50 && 
                                   currentRSI <= 50;
            
            if (shouldExitBuy || shouldExitSell) {
                deactivateSignal(currentRSI);
            }
        }
        
        // Activate a signal
        function activateSignal(type, currentRSI, previousRSI) {
            // Safety check
            if (tradingState.activeSignal !== 'NONE') {
                console.warn(`Signal conflict prevented: ${type} while ${tradingState.activeSignal} active`);
                return;
            }
            
            tradingState.activeSignal = type;
            tradingState.signalStartTime = new Date();
            tradingState.entryRSI = currentRSI;
            tradingState.isInTrade = true;
            tradingState.lastAction = 'ENTRY';
            tradingState.isInCooldown = false;
            tradingState.signalsToday++;
            
            // Show no-conflict badge
            document.getElementById('conflictBadge').style.display = 'inline-block';
            
            // Add to history
            const signalEntry = {
                type: type,
                action: 'ENTRY',
                rsi: currentRSI,
                previousRsi: previousRSI,
                price: priceHistory[priceHistory.length - 1].price,
                timestamp: new Date(),
                rule: `REAL DATA ${type} signal activated`
            };
            
            tradingState.signalHistory.unshift(signalEntry);
            if (tradingState.signalHistory.length > 10) {
                tradingState.signalHistory = tradingState.signalHistory.slice(0, 10);
            }
            
            // Update displays
            updateSignalDisplay();
            updateTradeLog();
            updateConditionsDisplay();
            showMessage(`‚úÖ REAL DATA ${type} SIGNAL ACTIVATED`, 'success');
        }
        
        // Deactivate current signal
        function deactivateSignal(currentRSI) {
            const oldSignal = tradingState.activeSignal;
            
            // Safety check
            if (oldSignal === 'NONE') {
                console.warn('Trying to exit when no signal is active');
                return;
            }
            
            const duration = Math.floor((new Date() - tradingState.signalStartTime) / 1000);
            const isSuccessful = (oldSignal === 'BUY' && currentRSI > tradingState.entryRSI) ||
                                (oldSignal === 'SELL' && currentRSI < tradingState.entryRSI);
            
            if (isSuccessful) {
                tradingState.successfulSignals++;
            }
            
            // Add exit to history
            const exitEntry = {
                type: oldSignal,
                action: 'EXIT',
                rsi: currentRSI,
                entryRsi: tradingState.entryRSI,
                price: priceHistory[priceHistory.length - 1].price,
                timestamp: new Date(),
                duration: duration,
                successful: isSuccessful,
                rule: 'REAL DATA exit signal'
            };
            
            tradingState.signalHistory.unshift(exitEntry);
            if (tradingState.signalHistory.length > 10) {
                tradingState.signalHistory = tradingState.signalHistory.slice(0, 10);
            }
            
            // Reset trading state
            tradingState.activeSignal = 'NONE';
            tradingState.signalStartTime = null;
            tradingState.entryRSI = null;
            tradingState.isInTrade = false;
            tradingState.lastAction = 'EXIT';
            tradingState.lastExitTime = new Date();
            tradingState.isInCooldown = true;
            
            // Hide no-conflict badge
            document.getElementById('conflictBadge').style.display = 'none';
            
            // Start cooldown timer
            startCooldownTimer();
            
            // Update displays
            updateSignalDisplay();
            updateTradeLog();
            updateConditionsDisplay();
            
            const successText = isSuccessful ? 'SUCCESSFUL' : 'UNSUCCESSFUL';
            showMessage(`‚úÖ ${oldSignal} signal exited after ${duration}s (${successText})`, 'success');
        }
        
        // Start cooldown timer
        function startCooldownTimer() {
            const cooldownEnd = new Date().getTime() + TRADING_RULES.COOLDOWN_MS;
            
            if (cooldownInterval) {
                clearInterval(cooldownInterval);
            }
            
            document.getElementById('cooldownInfo').style.display = 'block';
            
            cooldownInterval = setInterval(() => {
                const now = new Date().getTime();
                const remaining = Math.max(0, cooldownEnd - now);
                const seconds = Math.ceil(remaining / 1000);
                
                document.getElementById('cooldownTime').textContent = seconds;
                document.getElementById('cooldownTimer').textContent = `${seconds}s`;
                
                if (remaining <= 0) {
                    clearInterval(cooldownInterval);
                    tradingState.isInCooldown = false;
                    document.getElementById('cooldownInfo').style.display = 'none';
                    showMessage('‚úÖ Cooldown ended. Ready for next signal.', 'success');
                }
            }, 100);
        }
        
        // ============================================
        // DISPLAY UPDATES
        // ============================================
        
        // Update all trading displays
        function updateTradingDisplays() {
            updateSignalDisplay();
            updateTradeLog();
            updatePositionDisplay();
            updateConditionsDisplay();
            updateLastUpdate();
            updateCooldownDisplay();
        }
        
        // Update signal display
        function updateSignalDisplay() {
            const badge = document.getElementById('signalBadge');
            const activeSignalEl = document.getElementById('activeSignal');
            const signalStateEl = document.getElementById('signalState');
            const signalDetails = document.getElementById('signalDetails');
            const signalRule = document.getElementById('signalRule');
            
            badge.classList.remove('signal-buy', 'signal-sell', 'signal-neutral', 'price-alert');
            
            if (tradingState.activeSignal === 'BUY') {
                badge.textContent = 'BUY ACTIVE';
                badge.classList.add('signal-buy', 'price-alert');
                activeSignalEl.textContent = 'BUY';
                activeSignalEl.style.color = '#00b894';
                signalStateEl.textContent = 'ACTIVE';
                signalStateEl.style.color = '#00b894';
                signalDetails.innerHTML = `REAL DATA BUY signal active<br>Exit when RSI crosses above 50`;
                signalRule.innerHTML = '‚úÖ Real Market Data ‚Ä¢ No Simulation ‚Ä¢ Active Trade';
            }
            else if (tradingState.activeSignal === 'SELL') {
                badge.textContent = 'SELL ACTIVE';
                badge.classList.add('signal-sell', 'price-alert');
                activeSignalEl.textContent = 'SELL';
                activeSignalEl.style.color = '#d63031';
                signalStateEl.textContent = 'ACTIVE';
                signalStateEl.style.color = '#d63031';
                signalDetails.innerHTML = `REAL DATA SELL signal active<br>Exit when RSI crosses below 50`;
                signalRule.innerHTML = '‚úÖ Real Market Data ‚Ä¢ No Simulation ‚Ä¢ Active Trade';
            }
            else {
                badge.textContent = 'WAITING';
                badge.classList.add('signal-neutral');
                activeSignalEl.textContent = 'NONE';
                activeSignalEl.style.color = '#888';
                signalStateEl.textContent = tradingState.isInCooldown ? 'COOLDOWN' : 'WAITING';
                signalStateEl.style.color = tradingState.isInCooldown ? '#ffa500' : '#888';
                if (tradingState.isInCooldown) {
                    signalDetails.innerHTML = 'Cooldown active after exit<br>No new signals for 3 seconds';
                    signalRule.innerHTML = '‚è≥ Cooldown active ‚Ä¢ Real Data ‚Ä¢ Ready shortly';
                } else {
                    signalDetails.innerHTML = 'Waiting for REAL market signal<br>Monitoring RSI for extremes';
                    signalRule.innerHTML = '‚úÖ Real Market Data System Ready ‚Ä¢ No Simulation';
                }
            }
        }
        
        // Update RSI displays
        function updateRSIDisplays(currentRSI, previousRSI) {
            document.getElementById('rsiDisplay').textContent = currentRSI.toFixed(2);
            document.getElementById('prevRsiDisplay').textContent = previousRSI.toFixed(2);
            
            // Color code RSI
            const rsiDisplay = document.getElementById('rsiDisplay');
            if (currentRSI <= 30) {
                rsiDisplay.style.color = '#00b894';
            } else if (currentRSI >= 70) {
                rsiDisplay.style.color = '#d63031';
            } else if (currentRSI >= 50) {
                rsiDisplay.style.color = '#ffa500';
            } else {
                rsiDisplay.style.color = '#ffd700';
            }
            
            // Update position display if active
            if (tradingState.activeSignal !== 'NONE') {
                document.getElementById('currentRsi').textContent = currentRSI.toFixed(2);
            }
        }
        
        // Update price display
        function updatePriceDisplay(priceData) {
            const price = priceData.price;
            document.getElementById('currentPrice').textContent = `$${price.toFixed(2)}`;
            
            const streamDiv = document.getElementById('priceStream');
            const timestamp = priceData.timestamp.toLocaleTimeString();
            const source = priceData.source === 'realtime' ? 'LIVE' : 'HIST';
            const streamEntry = `[${timestamp}] $${price.toFixed(2)} (${source})`;
            
            let currentStream = streamDiv.innerHTML;
            let entries = currentStream.split('<br>').filter(e => e);
            entries.unshift(streamEntry);
            if (entries.length > 5) entries = entries.slice(0, 5);
            streamDiv.innerHTML = entries.join('<br>');
        }
        
        // Update trade log
        function updateTradeLog() {
            const tradeLog = document.getElementById('tradeLog');
            
            if (tradingState.signalHistory.length === 0) {
                tradeLog.innerHTML = `
                    <div class="trade-entry" style="color: #888; font-style: italic;">
                        No REAL market signals yet. Start live trading.
                    </div>
                `;
                return;
            }
            
            tradeLog.innerHTML = tradingState.signalHistory.map(signal => `
                <div class="trade-entry ${signal.type === 'BUY' ? 'trade-long' : 'trade-short'}">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: ${signal.type === 'BUY' ? '#00b894' : '#d63031'}; font-weight: bold;">
                            ${signal.type} ${signal.action} ${signal.successful !== undefined ? (signal.successful ? '‚úÖ' : '‚ùå') : ''}
                        </span>
                        <span style="color: #888; font-size: 0.8em;">
                            ${signal.timestamp.toLocaleTimeString()}
                        </span>
                    </div>
                    <div style="font-size: 0.85em; margin-top: 3px;">
                        RSI: ${signal.rsi.toFixed(2)} | Price: $${signal.price.toFixed(2)}
                    </div>
                    <div style="font-size: 0.8em; color: #888;">
                        ${signal.rule}${signal.duration ? ` | Duration: ${signal.duration}s` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Update position display
        function updatePositionDisplay() {
            const positionContainer = document.getElementById('positionContainer');
            
            if (tradingState.activeSignal !== 'NONE') {
                positionContainer.style.display = 'block';
                document.getElementById('positionType').textContent = tradingState.activeSignal;
                document.getElementById('positionType').style.color = tradingState.activeSignal === 'BUY' ? '#00b894' : '#d63031';
                document.getElementById('entryRsi').textContent = tradingState.entryRSI ? tradingState.entryRSI.toFixed(2) : '--';
                document.getElementById('currentRsi').textContent = tradingState.currentRSI ? tradingState.currentRSI.toFixed(2) : '--';
            } else {
                positionContainer.style.display = 'none';
            }
        }
        
        // Update position duration
        function updatePositionDuration() {
            if (!tradingState.signalStartTime) return;
            
            const duration = Math.floor((new Date() - tradingState.signalStartTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            document.getElementById('positionDuration').textContent = 
                `${minutes > 0 ? minutes + 'm ' : ''}${seconds}s`;
        }
        
        // Update conditions display
        function updateConditionsDisplay() {
            const conditionsList = document.getElementById('conditionsList');
            
            let conditions = [];
            if (tradingState.activeSignal === 'BUY') {
                conditions = [
                    '‚úÖ REAL DATA BUY SIGNAL ACTIVE',
                    `üìä Entry RSI: ${tradingState.entryRSI ? tradingState.entryRSI.toFixed(2) : '--'}`,
                    `üìä Current RSI: ${tradingState.currentRSI ? tradingState.currentRSI.toFixed(2) : '--'}`,
                    `‚è≥ Waiting for RSI to cross ABOVE 50`,
                    `üõë NO conflicting signals allowed`,
                    `‚úÖ Real market data system active`
                ];
            } else if (tradingState.activeSignal === 'SELL') {
                conditions = [
                    '‚úÖ REAL DATA SELL SIGNAL ACTIVE',
                    `üìä Entry RSI: ${tradingState.entryRSI ? tradingState.entryRSI.toFixed(2) : '--'}`,
                    `üìä Current RSI: ${tradingState.currentRSI ? tradingState.currentRSI.toFixed(2) : '--'}`,
                    `‚è≥ Waiting for RSI to cross BELOW 50`,
                    `üõë NO conflicting signals allowed`,
                    `‚úÖ Real market data system active`
                ];
            } else if (tradingState.isInCooldown) {
                conditions = [
                    '‚è≥ REAL DATA COOLDOWN ACTIVE',
                    'üõë No new signals allowed',
                    `‚è∞ 3-second cooldown after exit`,
                    '‚úÖ Prevents conflicting signals',
                    '‚úÖ Real data system monitoring'
                ];
            } else {
                conditions = [
                    'üìä Real market data system READY',
                    `‚èπÔ∏è No active position`,
                    `‚úÖ NO conflicting signals policy`,
                    `üëÄ Real RSI monitoring:`,
                    `   ‚Ä¢ BELOW 30 for BUY`,
                    `   ‚Ä¢ ABOVE 70 for SELL`,
                    `‚è∞ Only one signal at a time`
                ];
            }
            
            conditionsList.innerHTML = `
                <h3>Real Data Signal Logic</h3>
                ${conditions.map(cond => `
                    <div class="condition-item">
                        <span class="condition-icon">${cond.includes('‚úÖ') ? '‚úÖ' : cond.includes('üìä') ? 'üìä' : cond.includes('‚è≥') ? '‚è≥' : cond.includes('üõë') ? 'üõë' : cond.includes('‚è∞') ? '‚è∞' : 'üëÄ'}</span>
                        <span class="${cond.includes('‚úÖ') ? 'condition-met' : cond.includes('üõë') ? 'condition-not-met' : cond.includes('‚è≥') ? 'condition-not-met' : 'condition-not-met'}">${cond}</span>
                    </div>
                `).join('')}
            `;
        }
        
        // Update last update timestamp
        function updateLastUpdate() {
            const now = new Date();
            let statusText = 'Real Data System: Ready';
            
            if (tradingState.activeSignal !== 'NONE') {
                const duration = tradingState.signalStartTime ? 
                    Math.floor((new Date() - tradingState.signalStartTime) / 1000) : 0;
                statusText = `Real Data ${tradingState.activeSignal} active for ${duration}s`;
            } else if (tradingState.isInCooldown) {
                statusText = `Real Data cooldown active`;
            }
            
            document.getElementById('lastUpdate').innerHTML = 
                `<span style="color: ${tradingState.isInCooldown ? '#ffa500' : '#00b894'};">${statusText}</span>`;
        }
        
        // Update cooldown display
        function updateCooldownDisplay() {
            const cooldownInfo = document.getElementById('cooldownInfo');
            const now = new Date();
            const lastExitTime = tradingState.lastExitTime;
            
            if (lastExitTime && tradingState.isInCooldown) {
                const elapsed = now - lastExitTime;
                const remaining = Math.max(0, TRADING_RULES.COOLDOWN_MS - elapsed);
                
                if (remaining > 0) {
                    cooldownInfo.style.display = 'block';
                } else {
                    cooldownInfo.style.display = 'none';
                    tradingState.isInCooldown = false;
                }
            } else {
                cooldownInfo.style.display = 'none';
            }
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        // Fetch with timeout
        async function fetchWithTimeout(url, options = {}) {
            const { timeout = 5000 } = options;
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }
        
        // Change timeframe
        function changeTimeframe(timeframe, btn) {
            currentTimeframe = timeframe;
            
            document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            showMessage(`Timeframe changed to ${timeframe}`, 'success');
            
            // Update chart time unit
            if (rsiChart) {
                const unit = timeframe === 'live' ? 'minute' : 
                           timeframe.includes('m') ? 'minute' : 'hour';
                rsiChart.options.scales.x.time.unit = unit;
                rsiChart.update();
            }
        }
        
        // Change data source
        function changeDataSource(source, btn) {
            if (isConnected) {
                showMessage('Please stop trading before changing data source', 'error');
                return;
            }
            
            currentDataSource = source;
            
            document.querySelectorAll('.data-source-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            showMessage(`Data source changed to ${DATA_SOURCES[source].name}`, 'success');
        }
        
        // Show message
        function showMessage(message, type = 'success') {
            const errorContainer = document.getElementById('errorContainer');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            messageDiv.style.animation = 'fadeIn 0.3s';
            
            errorContainer.innerHTML = '';
            errorContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                if (errorContainer.contains(messageDiv)) {
                    messageDiv.style.animation = 'fadeOut 0.3s';
                    setTimeout(() => {
                        if (errorContainer.contains(messageDiv)) {
                            errorContainer.removeChild(messageDiv);
                        }
                    }, 300);
                }
            }, 5000);
        }
        
        // Reset connection
        function resetConnection() {
            const btn = document.getElementById('connectBtn');
            btn.innerHTML = 'üîó Start Live Trading';
            btn.disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            document.getElementById('initialStateCheck').style.display = 'none';
            updateConnectionStatus('disconnected');
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Real Market Data Trading Dashboard Initializing...');
            
            // Set initial displays
            document.getElementById('currentPrice').textContent = '--';
            document.getElementById('rsiDisplay').textContent = '--';
            document.getElementById('prevRsiDisplay').textContent = '--';
            document.getElementById('signalState').textContent = 'IDLE';
            document.getElementById('activeSignal').textContent = 'NONE';
            
            // Initialize chart
            setTimeout(() => {
                initializeChart();
            }, 1000);
            
            // Show welcome message
            showMessage('Click "Start Live Trading" to begin with REAL market data', 'success');
            
            console.log('‚úÖ Real Market Data Trading Dashboard ready');
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopRealTimeData();
        });
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(-10px); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
