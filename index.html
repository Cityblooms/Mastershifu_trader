<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Gold RSI Trading Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d3a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .header h1 {
            font-size: 2.2em;
            color: #ffd700;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .header p {
            color: #b8b8b8;
            font-size: 0.95em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .signal-panel {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeframe-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
        }

        .timeframe-btn {
            padding: 10px 18px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #b8b8b8;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9em;
        }

        .timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 215, 0, 0.5);
        }

        .timeframe-btn.active {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #0a0e27;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .market-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .status-item {
            display: flex;
            flex-direction: column;
        }

        .status-label {
            color: #888;
            font-size: 0.8em;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffd700;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0, 184, 148, 0.2);
            border-radius: 20px;
            border: 1px solid #00b894;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #00b894;
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .signal-display {
            text-align: center;
            margin-bottom: 25px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }

        .signal-badge {
            display: inline-block;
            padding: 18px 45px;
            border-radius: 50px;
            font-size: 1.8em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            animation: pulse 2s infinite;
        }

        .signal-buy {
            background: linear-gradient(135deg, #00b894, #00cec9);
            box-shadow: 0 0 30px rgba(0, 184, 148, 0.6);
        }

        .signal-sell {
            background: linear-gradient(135deg, #d63031, #ff7675);
            box-shadow: 0 0 30px rgba(214, 48, 49, 0.6);
        }

        .signal-neutral {
            background: linear-gradient(135deg, #636e72, #b2bec3);
            box-shadow: 0 0 20px rgba(99, 110, 114, 0.4);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .metric-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric-label {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 6px;
        }

        .metric-value {
            font-size: 1.6em;
            font-weight: bold;
            color: #ffd700;
        }

        .conditions-list {
            background: rgba(0, 0, 0, 0.3);
            padding: 18px;
            border-radius: 12px;
        }

        .conditions-list h3 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .condition-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-size: 0.9em;
        }

        .condition-icon {
            width: 20px;
            margin-right: 10px;
            font-size: 1.1em;
        }

        .condition-met { color: #00b894; }
        .condition-not-met { color: #636e72; }

        .session-info {
            background: rgba(255, 215, 0, 0.05);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .session-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .session-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .session-active {
            background: rgba(0, 184, 148, 0.3);
            border: 1px solid #00b894;
            color: #00b894;
        }

        .session-inactive {
            background: rgba(99, 110, 114, 0.2);
            border: 1px solid #636e72;
            color: #888;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #0a0e27;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(214, 48, 49, 0.8);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(214, 48, 49, 1);
        }

        .disclaimer {
            text-align: center;
            color: #636e72;
            font-size: 0.85em;
            padding: 15px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 0, 0, 0.2);
            margin-top: 15px;
        }

        .error-message {
            background: rgba(214, 48, 49, 0.2);
            border: 1px solid rgba(214, 48, 49, 0.4);
            padding: 12px;
            border-radius: 8px;
            color: #ff7675;
            margin-bottom: 15px;
            text-align: center;
        }

        .success-message {
            background: rgba(0, 184, 148, 0.2);
            border: 1px solid rgba(0, 184, 148, 0.4);
            padding: 12px;
            border-radius: 8px;
            color: #00b894;
            margin-bottom: 15px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #888;
        }

        .control-panel {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        .data-source-info {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.8em;
            color: #b8b8b8;
        }

        .trade-log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .trade-log h3 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .trade-entry {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            font-size: 0.85em;
            border-left: 3px solid;
        }

        .trade-long {
            border-left-color: #00b894;
        }

        .trade-short {
            border-left-color: #d63031;
        }

        .price-alert {
            animation: flash 1s infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .ws-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .ws-connected {
            background: rgba(0, 184, 148, 0.2);
            border: 1px solid #00b894;
            color: #00b894;
        }

        .ws-disconnected {
            background: rgba(214, 48, 49, 0.2);
            border: 1px solid #d63031;
            color: #ff7675;
        }

        .ws-connecting {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
            color: #ffd700;
        }

        .price-stream {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 100px;
            overflow-y: auto;
        }

        .chart-container {
            height: 400px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-top: 15px;
            padding: 15px;
            position: relative;
        }
        
        .current-position {
            background: rgba(255, 215, 0, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .position-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }
        
        .position-label {
            color: #888;
            font-size: 0.85em;
        }
        
        .position-value {
            color: #ffd700;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Clean Signal Gold RSI Trading Dashboard</h1>
            <p>No Confusing Signals ‚Ä¢ Clear BUY/SELL Signals ‚Ä¢ One Signal at a Time</p>
            <div class="data-source-info">
                üü¢ One Active Signal ‚Ä¢ üî¥ No Conflicting Signals ‚Ä¢ ‚ö° Clear Trading Rules
            </div>
        </div>

        <div class="main-grid">
            <!-- Left: Chart Section -->
            <div class="chart-section">
                <div class="control-panel">
                    <button class="btn btn-primary" onclick="connectWebSocket()" id="connectBtn">üîó Start Trading</button>
                    <button class="btn btn-secondary" onclick="resetTrading()">üîÑ Reset All</button>
                    <div class="ws-status ws-disconnected" id="wsStatus">STOPPED</div>
                </div>
                
                <div class="timeframe-selector">
                    <button class="timeframe-btn active" onclick="changeTimeframe('live', this)">Live</button>
                    <button class="timeframe-btn" onclick="changeTimeframe('1', this)">1M</button>
                    <button class="timeframe-btn" onclick="changeTimeframe('5', this)">5M</button>
                    <button class="timeframe-btn" onclick="changeTimeframe('15', this)">15M</button>
                    <button class="timeframe-btn" onclick="changeTimeframe('60', this)">1H</button>
                </div>

                <!-- Current Position Display -->
                <div class="current-position" id="positionContainer" style="display: none;">
                    <div style="color: #ffd700; font-weight: bold; margin-bottom: 5px;">üìä ACTIVE POSITION:</div>
                    <div class="position-info">
                        <div class="position-label">Type:</div>
                        <div class="position-value" id="positionType">--</div>
                    </div>
                    <div class="position-info">
                        <div class="position-label">Entry RSI:</div>
                        <div class="position-value" id="entryRsi">--</div>
                    </div>
                    <div class="position-info">
                        <div class="position-label">Current RSI:</div>
                        <div class="position-value" id="currentRsi">--</div>
                    </div>
                    <div class="position-info">
                        <div class="position-label">Duration:</div>
                        <div class="position-value" id="positionDuration">--</div>
                    </div>
                </div>

                <!-- Price Stream Display -->
                <div class="price-stream">
                    <div style="color: #ffd700; margin-bottom: 5px;">üìà Live Price Stream:</div>
                    <div id="priceStream">Waiting for price data...</div>
                </div>

                <!-- RSI Chart Container -->
                <div class="chart-container">
                    <div style="color: #ffd700; margin-bottom: 10px;">üìä RSI Chart (14-period):</div>
                    <canvas id="rsiChart"></canvas>
                </div>
            </div>

            <!-- Right: Signal Panel -->
            <div class="signal-panel">
                <div class="market-status">
                    <div class="status-item">
                        <span class="status-label">Trading Status</span>
                        <div id="marketStatus">
                            <div class="live-indicator">
                                <div class="live-dot"></div>
                                <span style="color: #00b894; font-weight: bold; font-size: 0.9em;">READY</span>
                            </div>
                        </div>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Active Signal</span>
                        <span class="status-value" id="activeSignal">NONE</span>
                    </div>
                </div>

                <div class="session-info">
                    <div style="color: #ffd700; font-weight: bold; font-size: 0.9em; margin-bottom: 6px;">üìä CLEAN TRADING RULES</div>
                    <div style="font-size: 0.85em; color: #b8b8b8;">
                        <div>‚Ä¢ <span style="color: #00b894;">BUY SIGNAL</span>: RSI crosses BELOW 30 ‚Üí Signal stays ACTIVE</div>
                        <div>‚Ä¢ <span style="color: #d63031;">SELL SIGNAL</span>: RSI crosses ABOVE 70 ‚Üí Signal stays ACTIVE</div>
                        <div>‚Ä¢ <span style="color: #ffd700;">EXIT ONLY</span>: When RSI crosses back through 50</div>
                        <div>‚Ä¢ <span style="color: #00b894;">NO CONFLICT</span>: Only one signal at a time</div>
                    </div>
                </div>

                <div id="errorContainer"></div>

                <div class="signal-display">
                    <div class="signal-badge signal-neutral" id="signalBadge">WAITING</div>
                    <div style="margin-top: 12px; color: #888; font-size: 0.9em;" id="signalDetails">
                        Start trading to see clear signals
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8em; color: #00b894;" id="signalRule">
                        One signal at a time ‚Ä¢ No confusion
                    </div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-box">
                        <div class="metric-label">Current Price</div>
                        <div class="metric-value" id="currentPrice">--</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">RSI (14)</div>
                        <div class="metric-value" id="rsiDisplay">--</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Previous RSI</div>
                        <div class="metric-value" id="prevRsiDisplay">--</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Signal State</div>
                        <div class="metric-value" id="signalState" style="font-size: 1.3em;">IDLE</div>
                    </div>
                </div>

                <div class="conditions-list" id="conditionsList">
                    <h3>Signal Logic</h3>
                    <div class="loading">
                        <div>‚úÖ BUY: RSI crosses below 30</div>
                        <div>‚úÖ SELL: RSI crosses above 70</div>
                        <div>‚úÖ EXIT: RSI crosses 50</div>
                        <div>‚úÖ ONE SIGNAL at a time</div>
                    </div>
                </div>

                <div class="trade-log">
                    <h3>üìù Signal History (Clean)</h3>
                    <div id="tradeLog">
                        <div class="trade-entry" style="color: #888; font-style: italic;">
                            No signals yet. Each signal will stay active until exit.
                        </div>
                    </div>
                </div>

                <div style="text-align: center; color: #888; font-size: 0.85em; margin-top: 15px;" id="lastUpdate">
                    System: Ready for clean signals
                </div>
            </div>
        </div>

        <div class="disclaimer">
            ‚ö†Ô∏è <strong>Clean Signal System:</strong> This dashboard generates ONE clear signal at a time. 
            BUY signal stays active until RSI crosses 50. SELL signal stays active until RSI crosses 50. 
            No conflicting signals. Perfect for clear trading decisions.
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION & GLOBAL VARIABLES
        // ============================================
        let ws = null;
        let priceHistory = [];
        let rsiHistory = [];
        const RSI_PERIOD = 14;
        let currentTimeframe = 'live';
        let isConnected = false;
        let priceUpdateInterval = null;
        
        // TRADING STATE - CLEAN SIGNAL LOGIC
        let tradingState = {
            activeSignal: 'NONE',           // 'NONE', 'BUY', 'SELL'
            signalStartTime: null,
            entryRSI: null,
            currentRSI: null,
            previousRSI: null,
            signalHistory: [],
            lastAction: null,
            isInTrade: false
        };
        
        // Trading rules - CLEAN AND SIMPLE
        const TRADING_RULES = {
            BUY_ENTRY: 30,     // RSI crosses BELOW this = BUY signal
            SELL_ENTRY: 70,    // RSI crosses ABOVE this = SELL signal
            EXIT_LEVEL: 50     // RSI crosses this = Exit signal
        };
        
        // ============================================
        // WEBSOCKET CONNECTION
        // ============================================
        
        // Connect to WebSocket for live price data
        function connectWebSocket() {
            if (isConnected) {
                showMessage('Already connected and trading', 'success');
                return;
            }
            
            const btn = document.getElementById('connectBtn');
            btn.innerHTML = '‚è≥ Starting...';
            btn.disabled = true;
            
            updateWSStatus('connecting');
            
            try {
                simulateWebSocketConnection();
                
            } catch (error) {
                console.error('Connection error:', error);
                showMessage(`Connection failed: ${error.message}`, 'error');
                updateWSStatus('disconnected');
                btn.innerHTML = 'üîó Start Trading';
                btn.disabled = false;
            }
        }
        
        // Simulate WebSocket connection
        function simulateWebSocketConnection() {
            updateWSStatus('connecting');
            showMessage('Starting clean trading system...', 'success');
            
            setTimeout(() => {
                isConnected = true;
                updateWSStatus('connected');
                
                const btn = document.getElementById('connectBtn');
                btn.innerHTML = '‚úÖ Trading';
                btn.disabled = true;
                
                showMessage('‚úÖ Clean trading system started', 'success');
                
                // Start receiving price data
                startPriceDataStream();
                
                // Initialize displays
                updateTradingDisplays();
                
            }, 1000);
        }
        
        // Start receiving price data
        function startPriceDataStream() {
            if (!isConnected) return;
            
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
            }
            
            // Realistic starting price
            let currentPrice = 2350.00;
            let priceTrend = 0; // -1 for down, 0 for neutral, 1 for up
            
            priceUpdateInterval = setInterval(() => {
                if (!isConnected) return;
                
                // Generate realistic price movement with trends
                let change;
                if (priceTrend === 0) {
                    change = (Math.random() - 0.5) * 4;
                    if (Math.random() > 0.7) priceTrend = Math.sign(change);
                } else {
                    // Continue trend with some randomness
                    change = (priceTrend * 2) + (Math.random() - 0.5) * 2;
                    if (Math.random() > 0.85) priceTrend = 0; // End trend
                }
                
                currentPrice += change;
                
                // Keep price in realistic range
                currentPrice = Math.max(2300, Math.min(2400, currentPrice));
                
                // Add price to history
                const timestamp = new Date();
                const priceData = {
                    price: parseFloat(currentPrice.toFixed(2)),
                    timestamp: timestamp,
                    volume: Math.random() * 100 + 50
                };
                
                priceHistory.push(priceData);
                
                // Keep history manageable
                if (priceHistory.length > 200) {
                    priceHistory = priceHistory.slice(-200);
                }
                
                // Update displays
                updatePriceDisplay(priceData);
                calculateAndUpdateRSI();
                
            }, 2000); // Update every 2 seconds (more realistic)
        }
        
        // Disconnect WebSocket
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
            
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
                priceUpdateInterval = null;
            }
            
            isConnected = false;
            updateWSStatus('disconnected');
            
            const btn = document.getElementById('connectBtn');
            btn.innerHTML = 'üîó Start Trading';
            btn.disabled = false;
            
            showMessage('Trading stopped', 'error');
        }
        
        // Reset all trading
        function resetTrading() {
            tradingState = {
                activeSignal: 'NONE',
                signalStartTime: null,
                entryRSI: null,
                currentRSI: null,
                previousRSI: null,
                signalHistory: [],
                lastAction: null,
                isInTrade: false
            };
            
            priceHistory = [];
            rsiHistory = [];
            
            updateTradingDisplays();
            showMessage('All trading reset. Ready for clean signals.', 'success');
        }
        
        // Update WebSocket status
        function updateWSStatus(status) {
            const statusDiv = document.getElementById('wsStatus');
            statusDiv.className = 'ws-status';
            
            switch(status) {
                case 'connected':
                    statusDiv.classList.add('ws-connected');
                    statusDiv.innerHTML = '‚úÖ TRADING';
                    break;
                case 'connecting':
                    statusDiv.classList.add('ws-connecting');
                    statusDiv.innerHTML = 'üîÑ STARTING';
                    break;
                case 'disconnected':
                    statusDiv.classList.add('ws-disconnected');
                    statusDiv.innerHTML = '‚ùå STOPPED';
                    break;
            }
        }
        
        // ============================================
        // CLEAN SIGNAL LOGIC - NO CONFLICTING SIGNALS
        // ============================================
        
        // Calculate RSI from price history
        function calculateRSI(prices, period = RSI_PERIOD) {
            if (prices.length < period + 1) {
                return 50;
            }
            
            const priceValues = prices.map(p => p.price);
            let gains = [];
            let losses = [];
            
            for (let i = 1; i < priceValues.length; i++) {
                const change = priceValues[i] - priceValues[i - 1];
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? Math.abs(change) : 0);
            }
            
            let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
            
            for (let i = period; i < gains.length; i++) {
                avgGain = ((avgGain * (period - 1)) + gains[i]) / period;
                avgLoss = ((avgLoss * (period - 1)) + losses[i]) / period;
            }
            
            if (avgLoss === 0) return 100;
            
            const rs = avgGain / avgLoss;
            const rsi = 100 - (100 / (1 + rs));
            
            return parseFloat(rsi.toFixed(2));
        }
        
        // Calculate and update RSI with CLEAN SIGNAL LOGIC
        function calculateAndUpdateRSI() {
            if (priceHistory.length < RSI_PERIOD + 1) {
                document.getElementById('rsiDisplay').textContent = '--';
                document.getElementById('prevRsiDisplay').textContent = '--';
                return;
            }
            
            // Get RSI values
            const currentRSI = calculateRSI(priceHistory);
            const previousRSI = tradingState.currentRSI || currentRSI;
            
            // Update trading state
            tradingState.previousRSI = tradingState.currentRSI;
            tradingState.currentRSI = currentRSI;
            
            // Update RSI history for chart
            rsiHistory.push(currentRSI);
            if (rsiHistory.length > 50) {
                rsiHistory = rsiHistory.slice(-50);
            }
            
            // Update displays
            updateRSIDisplays(currentRSI, previousRSI);
            
            // CHECK FOR CLEAN SIGNALS (No conflicting signals)
            checkCleanSignals(currentRSI, previousRSI);
            
            // Update position duration if active
            if (tradingState.activeSignal !== 'NONE' && tradingState.signalStartTime) {
                updatePositionDuration();
            }
        }
        
        // CLEAN SIGNAL CHECKING - One signal at a time
        function checkCleanSignals(currentRSI, previousRSI) {
            // If no active signal, check for new entry
            if (tradingState.activeSignal === 'NONE') {
                checkForNewEntry(currentRSI, previousRSI);
            }
            // If we have an active signal, check for exit only
            else {
                checkForExit(currentRSI, previousRSI);
            }
        }
        
        // Check for new entry (only when no active signal)
        function checkForNewEntry(currentRSI, previousRSI) {
            // BUY SIGNAL: RSI crosses BELOW 30
            if (previousRSI > TRADING_RULES.BUY_ENTRY && currentRSI <= TRADING_RULES.BUY_ENTRY) {
                activateSignal('BUY', currentRSI, previousRSI);
            }
            // SELL SIGNAL: RSI crosses ABOVE 70
            else if (previousRSI < TRADING_RULES.SELL_ENTRY && currentRSI >= TRADING_RULES.SELL_ENTRY) {
                activateSignal('SELL', currentRSI, previousRSI);
            }
        }
        
        // Check for exit (only when we have active signal)
        function checkForExit(currentRSI, previousRSI) {
            // EXIT CONDITION: RSI crosses through 50
            if ((tradingState.activeSignal === 'BUY' && previousRSI < 50 && currentRSI >= 50) ||
                (tradingState.activeSignal === 'SELL' && previousRSI > 50 && currentRSI <= 50)) {
                
                deactivateSignal(currentRSI);
            }
        }
        
        // Activate a clean signal
        function activateSignal(type, currentRSI, previousRSI) {
            tradingState.activeSignal = type;
            tradingState.signalStartTime = new Date();
            tradingState.entryRSI = currentRSI;
            tradingState.isInTrade = true;
            tradingState.lastAction = 'ENTRY';
            
            // Add to history
            const signalEntry = {
                type: type,
                action: 'ENTRY',
                rsi: currentRSI,
                previousRsi: previousRSI,
                price: priceHistory[priceHistory.length - 1].price,
                timestamp: new Date(),
                rule: `RSI crossed ${type === 'BUY' ? 'below 30' : 'above 70'}`
            };
            
            tradingState.signalHistory.unshift(signalEntry);
            if (tradingState.signalHistory.length > 10) {
                tradingState.signalHistory = tradingState.signalHistory.slice(0, 10);
            }
            
            // Update displays
            updateSignalDisplay();
            updateTradeLog();
            showMessage(`${type} signal activated. Will stay active until RSI crosses 50.`, 'success');
        }
        
        // Deactivate current signal
        function deactivateSignal(currentRSI) {
            const oldSignal = tradingState.activeSignal;
            const duration = Math.floor((new Date() - tradingState.signalStartTime) / 1000);
            
            // Add exit to history
            const exitEntry = {
                type: oldSignal,
                action: 'EXIT',
                rsi: currentRSI,
                entryRsi: tradingState.entryRSI,
                price: priceHistory[priceHistory.length - 1].price,
                timestamp: new Date(),
                duration: duration,
                rule: 'RSI crossed 50'
            };
            
            tradingState.signalHistory.unshift(exitEntry);
            if (tradingState.signalHistory.length > 10) {
                tradingState.signalHistory = tradingState.signalHistory.slice(0, 10);
            }
            
            // Reset trading state
            tradingState.activeSignal = 'NONE';
            tradingState.signalStartTime = null;
            tradingState.entryRSI = null;
            tradingState.isInTrade = false;
            tradingState.lastAction = 'EXIT';
            
            // Update displays
            updateSignalDisplay();
            updateTradeLog();
            showMessage(`${oldSignal} signal exited after ${duration}s. RSI crossed 50.`, 'success');
        }
        
        // ============================================
        // DISPLAY UPDATES
        // ============================================
        
        // Update all trading displays
        function updateTradingDisplays() {
            updateSignalDisplay();
            updateTradeLog();
            updatePositionDisplay();
            updateLastUpdate();
        }
        
        // Update signal display
        function updateSignalDisplay() {
            const badge = document.getElementById('signalBadge');
            const activeSignalEl = document.getElementById('activeSignal');
            const signalStateEl = document.getElementById('signalState');
            const signalDetails = document.getElementById('signalDetails');
            const signalRule = document.getElementById('signalRule');
            
            // Remove all classes
            badge.classList.remove('signal-buy', 'signal-sell', 'signal-neutral', 'price-alert');
            
            if (tradingState.activeSignal === 'BUY') {
                badge.textContent = 'BUY ACTIVE';
                badge.classList.add('signal-buy');
                badge.classList.add('price-alert');
                activeSignalEl.textContent = 'BUY';
                activeSignalEl.style.color = '#00b894';
                signalStateEl.textContent = 'ACTIVE';
                signalStateEl.style.color = '#00b894';
                signalDetails.innerHTML = `RSI crossed below 30<br>Will exit when RSI crosses 50`;
                signalRule.innerHTML = '‚úÖ BUY active ‚Ä¢ Waiting for exit at RSI 50';
            }
            else if (tradingState.activeSignal === 'SELL') {
                badge.textContent = 'SELL ACTIVE';
                badge.classList.add('signal-sell');
                badge.classList.add('price-alert');
                activeSignalEl.textContent = 'SELL';
                activeSignalEl.style.color = '#d63031';
                signalStateEl.textContent = 'ACTIVE';
                signalStateEl.style.color = '#d63031';
                signalDetails.innerHTML = `RSI crossed above 70<br>Will exit when RSI crosses 50`;
                signalRule.innerHTML = '‚úÖ SELL active ‚Ä¢ Waiting for exit at RSI 50';
            }
            else {
                badge.textContent = 'WAITING';
                badge.classList.add('signal-neutral');
                activeSignalEl.textContent = 'NONE';
                activeSignalEl.style.color = '#888';
                signalStateEl.textContent = 'WAITING';
                signalStateEl.style.color = '#888';
                signalDetails.innerHTML = 'Waiting for RSI to cross 30 (BUY) or 70 (SELL)';
                signalRule.innerHTML = '‚úÖ No active signal ‚Ä¢ Ready for clean entry';
            }
        }
        
        // Update RSI displays
        function updateRSIDisplays(currentRSI, previousRSI) {
            document.getElementById('rsiDisplay').textContent = currentRSI.toFixed(2);
            document.getElementById('prevRsiDisplay').textContent = previousRSI.toFixed(2);
            
            // Update position display if active
            if (tradingState.activeSignal !== 'NONE') {
                document.getElementById('currentRsi').textContent = currentRSI.toFixed(2);
            }
        }
        
        // Update price display
        function updatePriceDisplay(priceData) {
            document.getElementById('currentPrice').textContent = `$${priceData.price.toFixed(2)}`;
            
            const streamDiv = document.getElementById('priceStream');
            const timestamp = priceData.timestamp.toLocaleTimeString();
            const streamEntry = `[${timestamp}] $${priceData.price.toFixed(2)}`;
            
            let currentStream = streamDiv.innerHTML;
            let entries = currentStream.split('<br>').filter(e => e);
            entries.unshift(streamEntry);
            if (entries.length > 5) entries = entries.slice(0, 5);
            streamDiv.innerHTML = entries.join('<br>');
        }
        
        // Update trade log
        function updateTradeLog() {
            const tradeLog = document.getElementById('tradeLog');
            
            if (tradingState.signalHistory.length === 0) {
                tradeLog.innerHTML = `
                    <div class="trade-entry" style="color: #888; font-style: italic;">
                        No signals yet. Each signal will stay active until exit.
                    </div>
                `;
                return;
            }
            
            tradeLog.innerHTML = tradingState.signalHistory.map(signal => `
                <div class="trade-entry ${signal.type === 'BUY' ? 'trade-long' : 'trade-short'}">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: ${signal.type === 'BUY' ? '#00b894' : '#d63031'}; font-weight: bold;">
                            ${signal.type} ${signal.action}
                        </span>
                        <span style="color: #888; font-size: 0.8em;">
                            ${signal.timestamp.toLocaleTimeString()}
                        </span>
                    </div>
                    <div style="font-size: 0.85em; margin-top: 3px;">
                        RSI: ${signal.rsi.toFixed(2)} | Price: $${signal.price.toFixed(2)}
                    </div>
                    <div style="font-size: 0.8em; color: #888;">
                        ${signal.rule}${signal.duration ? ` | Duration: ${signal.duration}s` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Update position display
        function updatePositionDisplay() {
            const positionContainer = document.getElementById('positionContainer');
            
            if (tradingState.activeSignal !== 'NONE') {
                positionContainer.style.display = 'block';
                document.getElementById('positionType').textContent = tradingState.activeSignal;
                document.getElementById('positionType').style.color = tradingState.activeSignal === 'BUY' ? '#00b894' : '#d63031';
                document.getElementById('entryRsi').textContent = tradingState.entryRSI ? tradingState.entryRSI.toFixed(2) : '--';
                document.getElementById('currentRsi').textContent = tradingState.currentRSI ? tradingState.currentRSI.toFixed(2) : '--';
            } else {
                positionContainer.style.display = 'none';
            }
        }
        
        // Update position duration
        function updatePositionDuration() {
            if (!tradingState.signalStartTime) return;
            
            const duration = Math.floor((new Date() - tradingState.signalStartTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            document.getElementById('positionDuration').textContent = 
                `${minutes > 0 ? minutes + 'm ' : ''}${seconds}s`;
        }
        
        // Update conditions display
        function updateConditionsDisplay() {
            const conditionsList = document.getElementById('conditionsList');
            
            let conditions = [];
            if (tradingState.activeSignal === 'BUY') {
                conditions = [
                    '‚úÖ BUY signal ACTIVE',
                    `üìä Entry RSI: ${tradingState.entryRSI ? tradingState.entryRSI.toFixed(2) : '--'}`,
                    `üìä Current RSI: ${tradingState.currentRSI ? tradingState.currentRSI.toFixed(2) : '--'}`,
                    `‚è≥ Waiting for RSI to cross ABOVE 50 to exit`,
                    `üí∞ Current signal will stay active`
                ];
            } else if (tradingState.activeSignal === 'SELL') {
                conditions = [
                    '‚úÖ SELL signal ACTIVE',
                    `üìä Entry RSI: ${tradingState.entryRSI ? tradingState.entryRSI.toFixed(2) : '--'}`,
                    `üìä Current RSI: ${tradingState.currentRSI ? tradingState.currentRSI.toFixed(2) : '--'}`,
                    `‚è≥ Waiting for RSI to cross BELOW 50 to exit`,
                    `üí∞ Current signal will stay active`
                ];
            } else {
                conditions = [
                    'üìä Waiting for entry signal',
                    `‚èπÔ∏è No active position`,
                    `üëÄ Monitoring RSI for crosses:`,
                    `   ‚Ä¢ BELOW 30 for BUY`,
                    `   ‚Ä¢ ABOVE 70 for SELL`,
                    `üí∞ Only one signal at a time`
                ];
            }
            
            conditionsList.innerHTML = `
                <h3>Signal Logic</h3>
                ${conditions.map(cond => `
                    <div class="condition-item">
                        <span class="condition-icon">${cond.includes('‚úÖ') ? '‚úÖ' : cond.includes('üìä') ? 'üìä' : cond.includes('‚è≥') ? '‚è≥' : cond.includes('üí∞') ? 'üí∞' : 'üëÄ'}</span>
                        <span class="${cond.includes('‚úÖ') ? 'condition-met' : 'condition-not-met'}">${cond}</span>
                    </div>
                `).join('')}
            `;
        }
        
        // Update last update timestamp
        function updateLastUpdate() {
            const now = new Date();
            let statusText = 'System: Ready';
            
            if (tradingState.activeSignal !== 'NONE') {
                const duration = tradingState.signalStartTime ? 
                    Math.floor((new Date() - tradingState.signalStartTime) / 1000) : 0;
                statusText = `${tradingState.activeSignal} active for ${duration}s`;
            }
            
            document.getElementById('lastUpdate').innerHTML = 
                `<span style="color: #00b894;">${statusText}</span>`;
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        // Change timeframe
        function changeTimeframe(timeframe, btn) {
            currentTimeframe = timeframe;
            
            document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            showMessage(`Timeframe: ${timeframe}`, 'success');
        }
        
        // Show message
        function showMessage(message, type = 'success') {
            const errorContainer = document.getElementById('errorContainer');
            
            if (type === 'success') {
                errorContainer.innerHTML = `
                    <div class="success-message">
                        ${message}
                    </div>
                `;
            } else {
                errorContainer.innerHTML = `
                    <div class="error-message">
                        ${message}
                    </div>
                `;
            }
            
            setTimeout(() => {
                if (errorContainer.innerHTML.includes(message)) {
                    errorContainer.innerHTML = '';
                }
            }, 5000);
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Clean Signal Dashboard Initializing...');
            
            // Set initial displays
            document.getElementById('currentPrice').textContent = '--';
            document.getElementById('rsiDisplay').textContent = '--';
            document.getElementById('prevRsiDisplay').textContent = '--';
            document.getElementById('signalState').textContent = 'IDLE';
            document.getElementById('activeSignal').textContent = 'NONE';
            
            // Show welcome message
            showMessage('Click "Start Trading" for clean, non-conflicting signals', 'success');
            
            console.log('‚úÖ Clean Signal Dashboard ready');
        });
    </script>
</body>
</html>
