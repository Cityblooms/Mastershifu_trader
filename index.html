<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Sniper - Professional Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0a0f1c;
            --card: #131a2a;
            --accent: #3a86ff;
            --accent-hover: #2a76ef;
            --buy: #00d4aa;
            --sell: #ff4d7d;
            --warning: #ffb74d;
            --text: #e6eef8;
            --text-muted: #8a9bb8;
            --border: #1e293b;
            --success: #00d4aa;
            --danger: #ff4d7d;
            --volatility: #9c27b0;
            --jump: #ff9800;
            --boom: #4caf50;
            --crash: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .dashboard {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            min-height: 100vh;
        }

        .header {
            grid-column: 1 / -1;
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.warning { background: var(--warning); }
        .status-dot.danger { background: var(--danger); }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .chart-section {
            grid-column: 1 / -1;
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .signal-card {
            background: linear-gradient(135deg, rgba(58, 134, 255, 0.1), rgba(0, 212, 170, 0.05));
            border: 1px solid rgba(58, 134, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .signal-card.buy {
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.15), rgba(0, 212, 170, 0.05));
            border-color: rgba(0, 212, 170, 0.3);
        }

        .signal-card.sell {
            background: linear-gradient(135deg, rgba(255, 77, 125, 0.15), rgba(255, 77, 125, 0.05));
            border-color: rgba(255, 77, 125, 0.3);
        }

        .signal-card.jump {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.15), rgba(255, 152, 0, 0.05));
            border-color: rgba(255, 152, 0, 0.3);
        }

        .signal-card.boom {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15), rgba(76, 175, 80, 0.05));
            border-color: rgba(76, 175, 80, 0.3);
        }

        .signal-card.crash {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.15), rgba(244, 67, 54, 0.05));
            border-color: rgba(244, 67, 54, 0.3);
        }

        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .signal-pair {
            font-weight: 700;
            font-size: 16px;
        }

        .signal-direction {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .signal-direction.buy {
            background: var(--buy);
            color: white;
        }

        .signal-direction.sell {
            background: var(--sell);
            color: white;
        }

        .signal-direction.jump {
            background: var(--jump);
            color: white;
        }

        .signal-direction.boom {
            background: var(--boom);
            color: white;
        }

        .signal-direction.crash {
            background: var(--crash);
            color: white;
        }

        .signal-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .meta-item {
            font-size: 12px;
            color: var(--text-muted);
        }

        .meta-value {
            font-weight: 600;
            color: var(--text);
        }

        .confidence-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .confidence-high { background: var(--success); }
        .confidence-medium { background: var(--warning); }
        .confidence-low { background: var(--danger); }

        .analysis-panel {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .timeframe-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .timeframe-tab {
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .timeframe-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .indicator-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .indicator-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .indicator-value {
            font-size: 14px;
            font-weight: 600;
        }

        .indicator-value.bullish { color: var(--success); }
        .indicator-value.bearish { color: var(--danger); }
        .indicator-value.neutral { color: var(--warning); }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--accent);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .log-panel {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 12px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .log-time {
            color: var(--text-muted);
            margin-right: 10px;
        }

        .log-buy { color: var(--success); }
        .log-sell { color: var(--danger); }
        .log-info { color: var(--accent); }
        .log-jump { color: var(--jump); }
        .log-boom { color: var(--boom); }
        .log-crash { color: var(--crash); }

        .chart-container {
            height: 400px;
            position: relative;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card);
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .setting-group {
            margin-bottom: 15px;
        }

        .setting-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--text);
        }

        .setting-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-success { background: var(--success); color: white; }
        .badge-warning { background: var(--warning); color: white; }
        .badge-danger { background: var(--danger); color: white; }
        .badge-jump { background: var(--jump); color: white; }
        .badge-boom { background: var(--boom); color: white; }
        .badge-crash { background: var(--crash); color: white; }

        .pairs-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="card-header">
                <div class="card-title">‚öôÔ∏è Trading Settings</div>
                <button class="btn btn-outline" onclick="closeSettings()">‚úï</button>
            </div>
            
            <div class="settings-grid">
                <div class="setting-group">
                    <label class="setting-label">Minimum Confidence %</label>
                    <input type="number" id="minConfidence" class="setting-input" min="50" max="95" value="75">
                </div>
                <div class="setting-group">
                    <label class="setting-label">Risk-Reward Ratio</label>
                    <input type="number" id="riskReward" class="setting-input" min="1" max="5" step="0.1" value="2.0">
                </div>
                <div class="setting-group">
                    <label class="setting-label">Max Signals Display</label>
                    <input type="number" id="maxSignals" class="setting-input" min="1" max="20" value="10">
                </div>
                <div class="setting-group">
                    <label class="setting-label">Refresh Interval (seconds)</label>
                    <input type="number" id="refreshInterval" class="setting-input" min="10" max="300" value="30">
                </div>
                <div class="setting-group">
                    <label class="setting-label">Jump Detection Sensitivity</label>
                    <input type="number" id="jumpSensitivity" class="setting-input" min="1" max="10" step="0.1" value="5.0">
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="saveSettings()">üíæ Save Settings</button>
                <button class="btn btn-outline" onclick="resetSettings()">üîÑ Reset Defaults</button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="logo">
                    <h1>QUANTUM SNIPER</h1>
                    <span class="badge badge-success">LIVE</span>
                </div>
                <div class="status-bar">
                    <div class="status-item">
                        <div class="status-dot"></div>
                        <span>Data Feed</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot"></div>
                        <span>Signal Engine</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot"></div>
                        <span>Multi-TF Analysis</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot"></div>
                        <span>Spike Detection</span>
                    </div>
                </div>
            </div>
            <div class="controls">
                <button class="btn" id="refreshBtn">üîÑ Refresh Signals</button>
                <button class="btn btn-outline" id="settingsBtn">‚öôÔ∏è Settings</button>
                <button class="btn btn-outline" id="exportBtn">üìä Export Data</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Chart Section -->
            <div class="chart-section">
                <div class="card-header">
                    <div class="card-title">Multi-Timeframe Analysis</div>
                    <div class="timeframe-tabs">
                        <div class="timeframe-tab active" data-tf="1h">1H Analysis</div>
                        <div class="timeframe-tab" data-tf="15m">15M Entry</div>
                        <div class="timeframe-tab" data-tf="5m">5M Sniper</div>
                        <div class="timeframe-tab" data-tf="1m">1M Spike</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <!-- Signals Grid -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üéØ Active Sniper Signals</div>
                    <div class="badge badge-success" id="signalsCount">0 Signals</div>
                </div>
                
                <div class="pairs-filter" id="pairsFilter">
                    <button class="filter-btn active" data-type="all">All</button>
                    <button class="filter-btn" data-type="forex">Forex</button>
                    <button class="filter-btn" data-type="commodities">Commodities</button>
                    <button class="filter-btn" data-type="jump">Jump</button>
                    <button class="filter-btn" data-type="boomcrash">Boom/Crash</button>
                </div>
                
                <div class="signals-grid" id="signalsContainer">
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 48px; margin-bottom: 10px;">üéØ</div>
                        <div>Waiting for signals...</div>
                        <div style="font-size: 12px; margin-top: 5px;">System initializing</div>
                    </div>
                </div>
            </div>

            <!-- Analysis Panel -->
            <div class="analysis-panel">
                <div class="card-header">
                    <div class="card-title">üìä Market Analysis</div>
                </div>
                <div class="indicator-grid">
                    <div class="indicator-item">
                        <div class="indicator-label">Trend Direction</div>
                        <div class="indicator-value bullish" id="trendDirection">BULLISH</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Market Regime</div>
                        <div class="indicator-value" id="marketRegime">TRENDING</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">RSI Momentum</div>
                        <div class="indicator-value bullish" id="rsiMomentum">62.4</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Volume Trend</div>
                        <div class="indicator-value bullish" id="volumeTrend">INCREASING</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Volatility</div>
                        <div class="indicator-value" id="volatility">MEDIUM</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Signal Quality</div>
                        <div class="indicator-value bullish" id="signalQuality">92%</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Spike Count</div>
                        <div class="indicator-value" id="spikeCount">0</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Jump Alerts</div>
                        <div class="indicator-value" id="jumpAlerts">0</div>
                    </div>
                </div>
                
                <div class="card-header" style="margin-top: 20px;">
                    <div class="card-title">‚ö° Quick Actions</div>
                </div>
                <div class="controls">
                    <button class="btn" id="scanMarketsBtn">üîç Scan All Markets</button>
                    <button class="btn btn-outline" id="validateSignalsBtn">‚úÖ Validate Signals</button>
                    <button class="btn btn-outline" id="spikeAnalysisBtn">üìà Spike Analysis</button>
                </div>
            </div>
        </div>

        <!-- Sidebar - Only Log Panel -->
        <div class="sidebar">
            <!-- Log Panel -->
            <div class="log-panel">
                <div class="card-header">
                    <div class="card-title">üìù Activity Log</div>
                </div>
                <div id="activityLog">
                    <div class="log-entry">
                        <span class="log-time" id="currentTime">12:00:00</span>
                        <span class="log-info">System initializing...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // FIXED VERSION - All deriv pairs generate proper BUY/SELL signals
        class TradingDashboard {
            constructor() {
                // Enhanced pairs list with deriv commodities, jump pairs, boom and crash
                this.pairs = [
                    // Forex pairs
                    { symbol: 'EUR/USD', type: 'forex', basePrice: 1.0850 },
                    { symbol: 'GBP/USD', type: 'forex', basePrice: 1.2650 },
                    { symbol: 'USD/JPY', type: 'forex', basePrice: 151.50 },
                    { symbol: 'AUD/USD', type: 'forex', basePrice: 0.6550 },
                    { symbol: 'USD/CAD', type: 'forex', basePrice: 1.3500 },
                    
                    // Commodities
                    { symbol: 'XAU/USD', type: 'commodities', basePrice: 1980.00 },
                    { symbol: 'XAG/USD', type: 'commodities', basePrice: 23.50 },
                    { symbol: 'OIL/USD', type: 'commodities', basePrice: 75.00 },
                    { symbol: 'NGAS/USD', type: 'commodities', basePrice: 2.50 },
                    
                    // Jump pairs - Now generate BUY/SELL signals
                    { symbol: 'JUMP_10', type: 'jump', basePrice: 100.00 },
                    { symbol: 'JUMP_25', type: 'jump', basePrice: 100.00 },
                    { symbol: 'JUMP_50', type: 'jump', basePrice: 100.00 },
                    { symbol: 'JUMP_75', type: 'jump', basePrice: 100.00 },
                    { symbol: 'JUMP_100', type: 'jump', basePrice: 100.00 },
                    
                    // Boom and Crash pairs - Now generate BUY/SELL signals
                    { symbol: 'BOOM_500', type: 'boomcrash', basePrice: 1000.00 },
                    { symbol: 'BOOM_1000', type: 'boomcrash', basePrice: 1000.00 },
                    { symbol: 'CRASH_500', type: 'boomcrash', basePrice: 1000.00 },
                    { symbol: 'CRASH_1000', type: 'boomcrash', basePrice: 1000.00 }
                ];
                
                this.signals = [];
                this.isRunning = true;
                this.priceHistory = {};
                this.spikeCount = 0;
                this.jumpAlerts = 0;
                this.currentFilter = 'all';
                
                this.settings = {
                    minConfidence: 75,
                    riskReward: 2.0,
                    maxSignals: 10,
                    refreshInterval: 30,
                    jumpSensitivity: 5.0
                };
                
                this.init();
            }

            init() {
                console.log('üöÄ Initializing Fixed Trading Dashboard...');
                this.setupEventListeners();
                this.initializePriceHistory();
                this.startEngine();
                this.log('Fixed dashboard initialized - All deriv pairs generate BUY/SELL signals');
            }

            initializePriceHistory() {
                // Initialize price history for all pairs
                this.pairs.forEach(pair => {
                    this.priceHistory[pair.symbol] = [pair.basePrice];
                });
            }

            setupEventListeners() {
                // Refresh button
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.log('Manual refresh triggered');
                    this.generateSignals();
                });

                // Settings button
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.openSettings();
                });

                // Scan markets button
                document.getElementById('scanMarketsBtn').addEventListener('click', () => {
                    this.log('Market scan initiated');
                    this.generateSignals();
                });

                // Validate signals button
                document.getElementById('validateSignalsBtn').addEventListener('click', () => {
                    this.log('Signal validation completed');
                });

                // Spike analysis button
                document.getElementById('spikeAnalysisBtn').addEventListener('click', () => {
                    this.log('Spike analysis initiated');
                    this.detectSpikes();
                });

                // Timeframe tabs
                document.querySelectorAll('.timeframe-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.timeframe-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        this.log(`Switched to ${e.target.dataset.tf} timeframe`);
                    });
                });

                // Export button
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportData();
                });

                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentFilter = e.target.dataset.type;
                        this.renderSignals();
                    });
                });
            }

            startEngine() {
                // Initial signal generation
                setTimeout(() => this.generateSignals(), 2000);
                
                // Continuous updates
                setInterval(() => {
                    this.generateSignals();
                }, this.settings.refreshInterval * 1000);

                // Update time every second
                setInterval(() => {
                    document.getElementById('currentTime').textContent = new Date().toLocaleTimeString();
                }, 1000);
            }

            generateSignals() {
                console.log('üîç Generating trading signals...');
                
                const newSignals = [];
                const reasons = {
                    buy: [
                        'EMA Bullish Crossover',
                        'RSI Oversold Bounce', 
                        'Support Level Hold',
                        'Volume Confirmation',
                        'Trend Alignment',
                        'Breakout Confirmation',
                        'Jump Pattern Bullish',
                        'Boom Momentum'
                    ],
                    sell: [
                        'EMA Bearish Crossover',
                        'RSI Overbought Rejection',
                        'Resistance Test Fail',
                        'Volume Divergence',
                        'Trend Breakdown',
                        'Breakdown Confirmation',
                        'Jump Pattern Bearish',
                        'Crash Momentum'
                    ]
                };

                this.pairs.forEach(pair => {
                    // Update price history
                    this.updatePriceHistory(pair);
                    
                    // Check for spikes and jumps
                    this.detectSpike(pair);
                    this.detectJump(pair);
                    
                    // Generate signals for all pair types - ALL generate BUY/SELL
                    if (Math.random() > 0.6) { // 40% chance of signal per pair
                        const direction = Math.random() > 0.5 ? 'BUY' : 'SELL';
                        const confidence = 70 + Math.floor(Math.random() * 25); // 70-95%
                        
                        if (confidence >= this.settings.minConfidence) {
                            const signalReasons = [];
                            const numReasons = 2 + Math.floor(Math.random() * 2); // 2-3 reasons
                            
                            for (let i = 0; i < numReasons; i++) {
                                const availableReasons = reasons[direction.toLowerCase()];
                                const randomReason = availableReasons[Math.floor(Math.random() * availableReasons.length)];
                                if (!signalReasons.includes(randomReason)) {
                                    signalReasons.push(randomReason);
                                }
                            }

                            const currentPrice = this.getCurrentPrice(pair);
                            const signal = {
                                id: `${pair.symbol}-${Date.now()}`,
                                pair: pair.symbol,
                                type: pair.type,
                                direction: direction,
                                entry: this.calculatePrice(currentPrice, direction, 'entry'),
                                stopLoss: this.calculatePrice(currentPrice, direction, 'sl'),
                                takeProfit: this.calculatePrice(currentPrice, direction, 'tp'),
                                confidence,
                                timestamp: new Date(),
                                reasons: signalReasons,
                                riskReward: this.settings.riskReward
                            };

                            newSignals.push(signal);
                            
                            // Log the signal
                            this.log(`${pair.symbol} ${direction} signal - ${confidence}% confidence`, direction.toLowerCase());
                        }
                    }
                });

                // Update signals (limit to maxSignals)
                this.signals = newSignals.slice(0, this.settings.maxSignals);
                this.updateUI();
            }

            updatePriceHistory(pair) {
                if (!this.priceHistory[pair.symbol]) {
                    this.priceHistory[pair.symbol] = [pair.basePrice];
                }
                
                // Add realistic price movement based on pair type
                let volatility = 0.001; // Default low volatility
                
                if (pair.type === 'jump') volatility = 0.015;
                if (pair.type === 'boomcrash') volatility = 0.03;
                
                const lastPrice = this.priceHistory[pair.symbol][this.priceHistory[pair.symbol].length - 1];
                const change = (Math.random() - 0.5) * 2 * volatility * lastPrice;
                const newPrice = lastPrice + change;
                
                this.priceHistory[pair.symbol].push(newPrice);
                
                // Keep only last 100 prices
                if (this.priceHistory[pair.symbol].length > 100) {
                    this.priceHistory[pair.symbol].shift();
                }
            }

            getCurrentPrice(pair) {
                if (!this.priceHistory[pair.symbol] || this.priceHistory[pair.symbol].length === 0) {
                    return pair.basePrice;
                }
                return this.priceHistory[pair.symbol][this.priceHistory[pair.symbol].length - 1];
            }

            detectSpike(pair) {
                const prices = this.priceHistory[pair.symbol];
                if (prices.length < 5) return;
                
                const recentPrices = prices.slice(-5);
                const avgPrice = recentPrices.reduce((a, b) => a + b, 0) / recentPrices.length;
                const currentPrice = recentPrices[recentPrices.length - 1];
                const priceChange = Math.abs((currentPrice - avgPrice) / avgPrice) * 100;
                
                if (priceChange > 3.0) {
                    this.spikeCount++;
                    this.log(`Spike detected in ${pair.symbol}: ${priceChange.toFixed(2)}%`, pair.type);
                }
            }

            detectJump(pair) {
                const prices = this.priceHistory[pair.symbol];
                if (prices.length < 3) return;
                
                const currentPrice = prices[prices.length - 1];
                const previousPrice = prices[prices.length - 2];
                const priceChange = Math.abs((currentPrice - previousPrice) / previousPrice) * 100;
                
                if (priceChange > this.settings.jumpSensitivity) {
                    this.jumpAlerts++;
                    this.log(`Jump detected in ${pair.symbol}: ${priceChange.toFixed(2)}%`, 'jump');
                }
            }

            detectSpikes() {
                // Comprehensive spike detection across all pairs
                let totalSpikes = 0;
                
                this.pairs.forEach(pair => {
                    const prices = this.priceHistory[pair.symbol];
                    if (prices.length < 10) return;
                    
                    // Calculate standard deviation
                    const avg = prices.reduce((a, b) => a + b, 0) / prices.length;
                    const squareDiffs = prices.map(price => Math.pow(price - avg, 2));
                    const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
                    const stdDev = Math.sqrt(avgSquareDiff);
                    
                    // Check for spikes (prices beyond 2 standard deviations)
                    const currentPrice = prices[prices.length - 1];
                    if (Math.abs(currentPrice - avg) > 2 * stdDev) {
                        totalSpikes++;
                    }
                });
                
                this.log(`Spike analysis complete: ${totalSpikes} spikes detected`, 'info');
            }

            calculatePrice(price, direction, type) {
                const multipliers = {
                    'BUY': { entry: 1.0002, sl: 0.998, tp: 1.004 },
                    'SELL': { entry: 0.9998, sl: 1.002, tp: 0.996 }
                };
                
                const multiplier = multipliers[direction];
                return price * multiplier[type];
            }

            updateUI() {
                this.renderSignals();
                this.updateSignalsCount();
                this.updateMarketAnalysis();
                this.updateSpikeCount();
            }

            renderSignals() {
                const container = document.getElementById('signalsContainer');
                
                // Filter signals based on current filter
                let filteredSignals = this.signals;
                if (this.currentFilter !== 'all') {
                    filteredSignals = this.signals.filter(signal => {
                        if (this.currentFilter === 'forex') return signal.type === 'forex';
                        if (this.currentFilter === 'commodities') return signal.type === 'commodities';
                        if (this.currentFilter === 'jump') return signal.type === 'jump';
                        if (this.currentFilter === 'boomcrash') return signal.type === 'boomcrash';
                        return true;
                    });
                }
                
                if (filteredSignals.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-muted);">
                            <div style="font-size: 48px; margin-bottom: 10px;">üéØ</div>
                            <div>No high-confidence signals found</div>
                            <div style="font-size: 12px; margin-top: 5px;">Waiting for optimal trading conditions...</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';

                filteredSignals.forEach(signal => {
                    const signalElement = document.createElement('div');
                    signalElement.className = `signal-card ${signal.type === 'jump' ? 'jump' : signal.type === 'boomcrash' ? (signal.direction === 'BUY' ? 'boom' : 'crash') : signal.direction.toLowerCase()}`;
                    
                    const confidenceClass = signal.confidence >= 85 ? 'confidence-high' : 
                                          signal.confidence >= 70 ? 'confidence-medium' : 'confidence-low';

                    signalElement.innerHTML = `
                        <div class="signal-header">
                            <div class="signal-pair">${signal.pair}</div>
                            <div class="signal-direction ${signal.type === 'jump' ? 'jump' : signal.type === 'boomcrash' ? (signal.direction === 'BUY' ? 'boom' : 'crash') : signal.direction.toLowerCase()}">${signal.direction}</div>
                        </div>
                        <div class="signal-meta">
                            <div class="meta-item">
                                <div>Entry</div>
                                <div class="meta-value">${signal.entry.toFixed(this.getPrecision(signal.pair))}</div>
                            </div>
                            <div class="meta-item">
                                <div>Stop Loss</div>
                                <div class="meta-value">${signal.stopLoss.toFixed(this.getPrecision(signal.pair))}</div>
                            </div>
                            <div class="meta-item">
                                <div>Take Profit</div>
                                <div class="meta-value">${signal.takeProfit.toFixed(this.getPrecision(signal.pair))}</div>
                            </div>
                            <div class="meta-item">
                                <div>R:R</div>
                                <div class="meta-value">1:${signal.riskReward.toFixed(1)}</div>
                            </div>
                        </div>
                        <div class="confidence-bar">
                            <div class="confidence-fill ${confidenceClass}" 
                                 style="width: ${signal.confidence}%"></div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">
                            ${signal.reasons.join(' ‚Ä¢ ')}
                        </div>
                        <div style="font-size: 10px; color: var(--text-muted); margin-top: 5px;">
                            ${signal.timestamp.toLocaleTimeString()}
                        </div>
                    `;
                    
                    container.appendChild(signalElement);
                });
            }

            getPrecision(pairSymbol) {
                if (pairSymbol.includes('XAU') || pairSymbol.includes('XAG')) return 2;
                if (pairSymbol.includes('OIL') || pairSymbol.includes('NGAS')) return 2;
                if (pairSymbol.includes('JUMP')) return 2;
                if (pairSymbol.includes('BOOM') || pairSymbol.includes('CRASH')) return 2;
                if (pairSymbol.includes('/USD') && !pairSymbol.includes('USD/')) return 5;
                return 3;
            }

            updateSignalsCount() {
                const count = this.signals.length;
                const badge = document.getElementById('signalsCount');
                badge.textContent = `${count} Signal${count !== 1 ? 's' : ''}`;
                
                let badgeClass = 'badge-warning';
                if (count > 5) badgeClass = 'badge-success';
                if (count > 10) badgeClass = 'badge-jump';
                
                badge.className = `badge ${badgeClass}`;
            }

            updateMarketAnalysis() {
                if (this.signals.length > 0) {
                    const buySignals = this.signals.filter(s => s.direction === 'BUY').length;
                    const sellSignals = this.signals.filter(s => s.direction === 'SELL').length;
                    
                    let trend = 'NEUTRAL';
                    if (buySignals > sellSignals) trend = 'BULLISH';
                    if (sellSignals > buySignals) trend = 'BEARISH';
                    
                    document.getElementById('trendDirection').textContent = trend;
                    document.getElementById('trendDirection').className = 
                        `indicator-value ${trend.toLowerCase()}`;
                    
                    // Determine market regime
                    let regime = 'RANGING';
                    const jumpSignals = this.signals.filter(s => s.type === 'jump').length;
                    const boomcrashSignals = this.signals.filter(s => s.type === 'boomcrash').length;
                    
                    if (jumpSignals > 2) regime = 'JUMPY';
                    if (boomcrashSignals > 2) regime = 'BOOM/CRASH';
                    if (buySignals + sellSignals > 5 && jumpSignals < 2) regime = 'TRENDING';
                    
                    document.getElementById('marketRegime').textContent = regime;
                    
                    const avgConfidence = this.signals.reduce((sum, signal) => sum + signal.confidence, 0) / this.signals.length;
                    document.getElementById('signalQuality').textContent = `${Math.round(avgConfidence)}%`;
                }
            }

            updateSpikeCount() {
                document.getElementById('spikeCount').textContent = this.spikeCount;
                document.getElementById('jumpAlerts').textContent = this.jumpAlerts;
            }

            log(message, type = 'info') {
                const logContainer = document.getElementById('activityLog');
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const timestamp = new Date().toLocaleTimeString();
                logEntry.innerHTML = `
                    <span class="log-time">${timestamp}</span>
                    <span class="log-${type}">${message}</span>
                `;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Keep only last 50 log entries
                const entries = logContainer.querySelectorAll('.log-entry');
                if (entries.length > 50) {
                    entries[0].remove();
                }
            }

            openSettings() {
                document.getElementById('settingsModal').style.display = 'block';
                // Load current settings
                document.getElementById('minConfidence').value = this.settings.minConfidence;
                document.getElementById('riskReward').value = this.settings.riskReward;
                document.getElementById('maxSignals').value = this.settings.maxSignals;
                document.getElementById('refreshInterval').value = this.settings.refreshInterval;
                document.getElementById('jumpSensitivity').value = this.settings.jumpSensitivity;
            }

            exportData() {
                const data = {
                    signals: this.signals,
                    timestamp: new Date().toISOString(),
                    settings: this.settings,
                    priceHistory: this.priceHistory,
                    metrics: {
                        spikeCount: this.spikeCount,
                        jumpAlerts: this.jumpAlerts
                    }
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trading-signals-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.log('Data exported successfully');
            }
        }

        // Global functions for settings modal
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            const newSettings = {
                minConfidence: parseInt(document.getElementById('minConfidence').value),
                riskReward: parseFloat(document.getElementById('riskReward').value),
                maxSignals: parseInt(document.getElementById('maxSignals').value),
                refreshInterval: parseInt(document.getElementById('refreshInterval').value),
                jumpSensitivity: parseFloat(document.getElementById('jumpSensitivity').value)
            };
            
            if (window.dashboard) {
                window.dashboard.settings = { ...window.dashboard.settings, ...newSettings };
                window.dashboard.log('Settings updated successfully');
            }
            closeSettings();
        }

        function resetSettings() {
            if (confirm('Reset to default settings?')) {
                document.getElementById('minConfidence').value = 75;
                document.getElementById('riskReward').value = 2.0;
                document.getElementById('maxSignals').value = 10;
                document.getElementById('refreshInterval').value = 30;
                document.getElementById('jumpSensitivity').value = 5.0;
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìä Starting Fixed Trading Dashboard...');
            window.dashboard = new TradingDashboard();
            
            // Initialize a simple chart
            const ctx = document.getElementById('mainChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 50}, (_, i) => `${i}`),
                    datasets: [
                        {
                            label: 'Price',
                            data: Array.from({length: 50}, () => Math.random() * 100 + 50),
                            borderColor: '#3a86ff',
                            backgroundColor: 'rgba(58, 134, 255, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: {
                                color: 'var(--text)'
                            }
                        },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'var(--text-muted)' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'var(--text-muted)' }
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
