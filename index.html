<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Killer Zone Signal Engine v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid #00d4ff;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            color: #00d4ff;
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }

        .header .subtitle {
            color: #4db8ff;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(20, 30, 48, 0.85);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 212, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 212, 255, 0.4);
        }

        .panel h2 {
            color: #4db8ff;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #a0d2ff;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(10, 25, 47, 0.7);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
        }

        .btn {
            background: linear-gradient(45deg, #00d4ff, #0088cc);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            background: linear-gradient(45deg, #00e5ff, #0099dd);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .btn.secondary:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
        }

        .btn.danger {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
        }

        .btn.danger:hover {
            background: linear-gradient(45deg, #ff4b2b, #ff416c);
        }

        .signal-display {
            margin-top: 30px;
            padding: 25px;
            background: rgba(20, 30, 48, 0.85);
            border-radius: 15px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
        }

        .signal-type {
            font-size: 1.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .signal-type.BUY {
            color: #00ff88;
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .signal-type.SELL {
            color: #ff416c;
            text-shadow: 0 0 15px rgba(255, 65, 108, 0.5);
        }

        .signal-type.NO_SIGNAL {
            color: #a0a0a0;
        }

        .confidence-meter {
            width: 100%;
            height: 25px;
            background: rgba(10, 25, 47, 0.7);
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff416c, #ff4b2b, #ff9500, #00d4ff, #00ff88);
            transition: width 0.5s ease;
            border-radius: 12px;
        }

        .confidence-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(10, 25, 47, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(0, 212, 255, 0.1);
        }

        .stat-label {
            color: #a0d2ff;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #00d4ff;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .session-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 15px;
            border-radius: 20px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            font-weight: 500;
            margin: 5px;
        }

        .session-indicator.active {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }

        .history-panel {
            grid-column: 1 / -1;
            margin-top: 30px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }

        .history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
        }

        .history-table tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .signal-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .signal-badge.BUY {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .signal-badge.SELL {
            background: rgba(255, 65, 108, 0.2);
            color: #ff416c;
        }

        .outcome-badge.WIN {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            padding: 4px 12px;
            border-radius: 12px;
        }

        .outcome-badge.LOSS {
            background: rgba(255, 65, 108, 0.2);
            color: #ff416c;
            padding: 4px 12px;
            border-radius: 12px;
        }

        .error-message {
            background: rgba(255, 65, 108, 0.1);
            border: 1px solid rgba(255, 65, 108, 0.3);
            color: #ff416c;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .success-message {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: #00ff88;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .session-display {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(10, 25, 47, 0.7);
            border-radius: 10px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: rgba(10, 25, 47, 0.95);
            color: #e0e0e0;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>KILLER ZONE SIGNAL ENGINE v2.0</h1>
            <div class="subtitle">Advanced RSI-based Trading Signal Generator with Performance Tracking</div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard">
            <!-- Input Panel -->
            <div class="panel">
                <h2>Signal Parameters</h2>
                <div class="form-group">
                    <label for="asset">Asset Pair</label>
                    <select id="asset" class="form-control">
                        <option value="EURUSD">EUR/USD</option>
                        <option value="GBPUSD">GBP/USD</option>
                        <option value="USDJPY">USD/JPY</option>
                        <option value="BTCUSD">BTC/USD</option>
                        <option value="ETHUSD">ETH/USD</option>
                        <option value="XAUUSD">XAU/USD (Gold)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="timeframe">Timeframe</label>
                    <select id="timeframe" class="form-control">
                        <option value="5m">5 Minutes</option>
                        <option value="15m">15 Minutes</option>
                        <option value="1h">1 Hour</option>
                        <option value="4h">4 Hours</option>
                        <option value="1d">1 Day</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="rsi">Current RSI <span class="tooltip">?
                        <span class="tooltiptext">Relative Strength Index (0-100). Values below 30 indicate oversold, above 70 overbought.</span>
                    </span></label>
                    <input type="number" id="rsi" class="form-control" min="0" max="100" step="0.1" value="15">
                </div>

                <div class="form-group">
                    <label for="prevRsi">Previous RSI</label>
                    <input type="number" id="prevRsi" class="form-control" min="0" max="100" step="0.1" value="14">
                </div>

                <div class="form-group">
                    <label for="htfRsi">Higher Timeframe RSI <span class="tooltip">?
                        <span class="tooltiptext">RSI from a higher timeframe for trend confirmation</span>
                    </span></label>
                    <input type="number" id="htfRsi" class="form-control" min="0" max="100" step="0.1" value="55">
                </div>

                <div class="form-group">
                    <label for="price">Current Price (Optional)</label>
                    <input type="number" id="price" class="form-control" step="0.00001" value="1.0850">
                </div>

                <div class="form-group">
                    <label for="atr">ATR/Volatility (Optional)</label>
                    <input type="number" id="atr" class="form-control" step="0.00001" value="0.0010">
                </div>

                <div class="form-group">
                    <label for="accountSize">Account Size ($)</label>
                    <input type="number" id="accountSize" class="form-control" value="10000">
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="divergence"> RSI Divergence Detected
                    </label>
                </div>

                <button class="btn" onclick="generateSignal()">Generate Signal</button>
                <button class="btn secondary" onclick="generateRandomSignal()">Random Test</button>
            </div>

            <!-- Performance Panel -->
            <div class="panel">
                <h2>Performance Dashboard</h2>
                <div id="performanceStats">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Signals</div>
                            <div class="stat-value" id="totalSignals">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Win Rate</div>
                            <div class="stat-value" id="winRate">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Pips</div>
                            <div class="stat-value" id="totalPips">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Current Streak</div>
                            <div class="stat-value" id="currentStreak">-</div>
                        </div>
                    </div>

                    <div class="session-display">
                        <div class="session-indicator" id="currentSession">LONDON</div>
                        <div class="session-indicator" id="sessionWeight">Multiplier: 1.0x</div>
                        <div class="session-indicator" id="marketHours">00:00 UTC</div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn secondary" onclick="showPerformanceReport()">View Full Report</button>
                        <button class="btn danger" onclick="clearHistory()" style="margin-top: 10px;">Clear History</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signal Display -->
        <div id="signalDisplay" class="signal-display" style="display: none;">
            <div class="signal-header">
                <div class="signal-type" id="signalType">NO SIGNAL</div>
                <div id="signalTimestamp">-</div>
            </div>

            <div class="confidence-meter">
                <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                <div class="confidence-text" id="confidenceText">0% Confidence</div>
            </div>

            <div id="signalDetails">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Strength</div>
                        <div class="stat-value" id="signalStrength">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Type</div>
                        <div class="stat-value" id="signalTypeDetail">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">RSI Value</div>
                        <div class="stat-value" id="signalRsi">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Session</div>
                        <div class="stat-value" id="signalSession">-</div>
                    </div>
                </div>

                <div style="margin-top: 25px;">
                    <h3 style="color: #4db8ff; margin-bottom: 10px;">Position Sizing</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Risk Percentage</div>
                            <div class="stat-value" id="riskPercent">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Risk Amount</div>
                            <div class="stat-value" id="riskAmount">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Position Size</div>
                            <div class="stat-value" id="positionSize">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Max Leverage</div>
                            <div class="stat-value" id="maxLeverage">-</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 25px;">
                    <h3 style="color: #4db8ff; margin-bottom: 10px;">Signal Reason</h3>
                    <div style="background: rgba(10, 25, 47, 0.7); padding: 15px; border-radius: 10px; border: 1px solid rgba(0, 212, 255, 0.1);">
                        <div id="signalReason">-</div>
                    </div>
                </div>

                <div style="margin-top: 25px; display: flex; gap: 15px;">
                    <button class="btn secondary" onclick="markAsWin()">Mark as WIN</button>
                    <button class="btn danger" onclick="markAsLoss()">Mark as LOSS</button>
                    <button class="btn" onclick="closeSignal()">Close Signal</button>
                </div>
            </div>
        </div>

        <!-- Signal History -->
        <div class="panel history-panel">
            <h2>Recent Signal History</h2>
            <div style="overflow-x: auto;">
                <table class="history-table" id="signalHistory">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Asset</th>
                            <th>Signal</th>
                            <th>Type</th>
                            <th>Confidence</th>
                            <th>Outcome</th>
                            <th>P/L</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorDisplay" class="error-message" style="display: none;"></div>

        <!-- Success Display -->
        <div id="successDisplay" class="success-message" style="display: none;"></div>
    </div>

    <script>
        // ======================================
        // KILLER ZONE SIGNAL ENGINE v2.0
        // ======================================

        // Global state for performance tracking
        const signalHistory = {
            logs: [],
            lastSignalTime: null,
            performance: {
                totalSignals: 0,
                profitable: 0,
                unprofitable: 0,
                totalPips: 0,
                winRate: 0
            },
            currentSignalId: null
        };

        // Session configuration
        const sessionConfig = {
            multipliers: {
                "ASIAN": 0.8,
                "LONDON_OPEN": 1.3,
                "LONDON": 1.2,
                "NEWYORK_OPEN": 1.4,
                "NEWYORK": 1.25,
                "LONDON+NY": 1.5,
                "WEEKEND": 0.3,
                "HOLIDAY": 0.2
            },
            
            getCurrentSession: function(timeUTC) {
                const date = new Date(timeUTC);
                const hour = date.getUTCHours();
                const day = date.getUTCDay();
                
                if (day === 0 || day === 6) return "WEEKEND";
                if (hour >= 1 && hour < 4) return "ASIAN";
                if (hour >= 7 && hour < 9) return "LONDON_OPEN";
                if (hour >= 7 && hour < 15) return "LONDON";
                if (hour >= 12 && hour < 14) return "LONDON+NY";
                if (hour >= 13 && hour < 15) return "NEWYORK_OPEN";
                if (hour >= 13 && hour < 21) return "NEWYORK";
                return "ASIAN";
            }
        };

        // Position sizing calculator
        const positionCalculator = {
            baseRiskPercentage: 1.0,
            
            calculateSize: function(confidence, strength, volatility, accountSize = 10000) {
                let riskPercent = this.baseRiskPercentage * (confidence / 100);
                
                const strengthMultipliers = {
                    "EXTREME": 2.0,
                    "STRONG": 1.5,
                    "MODERATE": 1.0,
                    "WEAK": 0.5
                };
                
                riskPercent *= strengthMultipliers[strength] || 1.0;
                const volatilityMultiplier = Math.min(1.5, 1 / (volatility / 0.01));
                riskPercent *= volatilityMultiplier;
                
                const riskAmount = accountSize * (riskPercent / 100);
                const maxRisk = accountSize * 0.05;
                const finalRisk = Math.min(riskAmount, maxRisk);
                
                return {
                    riskPercentage: riskPercent.toFixed(2),
                    riskAmount: finalRisk.toFixed(2),
                    positionSize: (finalRisk * 100).toFixed(2),
                    maxLeverage: this.calculateMaxLeverage(finalRisk, volatility, accountSize)
                };
            },
            
            calculateMaxLeverage: function(riskAmount, volatility, accountSize) {
                const baseLeverage = 100;
                const volatilityFactor = Math.max(0.5, 1 - (volatility * 10));
                let maxLeverage = baseLeverage * volatilityFactor;
                maxLeverage = Math.min(maxLeverage, accountSize / riskAmount);
                maxLeverage = Math.min(maxLeverage, 500);
                return Math.floor(maxLeverage);
            }
        };

        // Input validation
        function validateInput(data) {
            const errors = [];
            
            const requiredFields = ['rsi', 'prevRsi', 'htfRsi', 'asset', 'timeframe'];
            for (const field of requiredFields) {
                if (data[field] === undefined || data[field] === null || data[field] === '') {
                    errors.push(`Missing required field: ${field}`);
                }
            }
            
            if (data.rsi < 0 || data.rsi > 100) {
                errors.push(`Invalid RSI value: ${data.rsi}. Must be between 0-100`);
            }
            
            if (data.prevRsi < 0 || data.prevRsi > 100) {
                errors.push(`Invalid previous RSI value: ${data.prevRsi}. Must be between 0-100`);
            }
            
            const validTimeframes = ['1m', '5m', '15m', '30m', '1h', '4h', '1d', '1w'];
            if (!validTimeframes.includes(data.timeframe)) {
                errors.push(`Invalid timeframe: ${data.timeframe}`);
            }
            
            return errors;
        }

        // Performance tracking functions
        function logSignal(signalData) {
            const signalId = `SIG_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const logEntry = {
                id: signalId,
                timestamp: new Date().toISOString(),
                asset: signalData.asset,
                timeframe: signalData.timeframe,
                signal: signalData.signal,
                type: signalData.type,
                strength: signalData.strength,
                rsi: signalData.rsi,
                confidence: signalData.confidence,
                price: signalData.price || null,
                positionSize: signalData.positionSize || null,
                session: signalData.session,
                reasons: signalData.reason,
                outcome: null,
                pnl: null,
                pnlPercent: null,
                closeTime: null,
                duration: null
            };
            
            signalHistory.logs.push(logEntry);
            signalHistory.lastSignalTime = Date.now();
            signalHistory.performance.totalSignals++;
            signalHistory.currentSignalId = signalId;
            
            if (signalHistory.logs.length > 1000) {
                signalHistory.logs.shift();
            }
            
            updatePerformanceDisplay();
            updateHistoryTable();
            
            return signalId;
        }

        function updateSignalOutcome(signalId, outcomeData) {
            const signal = signalHistory.logs.find(s => s.id === signalId);
            
            if (signal) {
                signal.outcome = outcomeData.outcome;
                signal.pnl = outcomeData.pnl;
                signal.pnlPercent = outcomeData.pnlPercent;
                signal.closeTime = new Date().toISOString();
                
                const openTime = new Date(signal.timestamp);
                const closeTime = new Date(signal.closeTime);
                signal.duration = Math.round((closeTime - openTime) / (1000 * 60));
                
                if (outcomeData.pnl > 0) {
                    signalHistory.performance.profitable++;
                } else if (outcomeData.pnl < 0) {
                    signalHistory.performance.unprofitable++;
                }
                
                signalHistory.performance.totalPips += outcomeData.pnl || 0;
                const totalTrades = signalHistory.performance.profitable + signalHistory.performance.unprofitable;
                signalHistory.performance.winRate = totalTrades > 0 ? 
                    (signalHistory.performance.profitable / totalTrades) * 100 : 0;
                
                updatePerformanceDisplay();
                updateHistoryTable();
            }
        }

        function updatePerformanceDisplay() {
            document.getElementById('totalSignals').textContent = signalHistory.performance.totalSignals;
            document.getElementById('winRate').textContent = signalHistory.performance.winRate.toFixed(1) + '%';
            document.getElementById('totalPips').textContent = signalHistory.performance.totalPips.toFixed(2);
            
            // Calculate current streak
            const recent = signalHistory.logs.filter(s => s.outcome).slice(-20);
            let streak = 0;
            let currentOutcome = null;
            
            for (let i = recent.length - 1; i >= 0; i--) {
                if (currentOutcome === null) {
                    currentOutcome = recent[i].outcome;
                    streak = 1;
                } else if (recent[i].outcome === currentOutcome) {
                    streak++;
                } else {
                    break;
                }
            }
            
            document.getElementById('currentStreak').textContent = currentOutcome ? 
                `${currentOutcome} x${streak}` : '-';
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            const recentSignals = signalHistory.logs.slice(-10).reverse();
            
            recentSignals.forEach(signal => {
                const row = document.createElement('tr');
                const time = new Date(signal.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                row.innerHTML = `
                    <td>${time}</td>
                    <td>${signal.asset}</td>
                    <td><span class="signal-badge ${signal.signal}">${signal.signal}</span></td>
                    <td>${signal.type || '-'}</td>
                    <td>${signal.confidence}%</td>
                    <td>${signal.outcome ? `<span class="outcome-badge ${signal.outcome}">${signal.outcome}</span>` : '-'}</td>
                    <td>${signal.pnl !== null ? signal.pnl.toFixed(2) + ' pips' : '-'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Main signal engine
        function killerZoneEngineV2(data) {
            const validationErrors = validateInput(data);
            if (validationErrors.length > 0) {
                return {
                    error: true,
                    message: "Input validation failed",
                    errors: validationErrors
                };
            }
            
            const currentTime = Date.now();
            const detectedSession = sessionConfig.getCurrentSession(currentTime);
            const session = detectedSession;
            const sessionWeight = sessionConfig.multipliers[session] || 1.0;
            
            let signal = "NO SIGNAL";
            let type = "";
            let confidence = 0;
            let strength = "";
            let reason = [];

            const { rsi, prevRsi, htfRsi, divergence } = data;
            const baseConfidence = sessionWeight * 10;

            // Extreme reversals
            if (rsi <= 12 && rsi > prevRsi) {
                signal = "BUY";
                type = "EXTREME_BUY";
                confidence = 80 + baseConfidence;
                strength = "EXTREME";
                reason.push(`RSI maximum oversold reversal (${rsi})`);
            }
            else if (rsi >= 88 && rsi < prevRsi) {
                signal = "SELL";
                type = "EXTREME_SELL";
                confidence = 80 + baseConfidence;
                strength = "EXTREME";
                reason.push(`RSI maximum overbought reversal (${rsi})`);
            }
            // Strong reversals
            else if (rsi >= 13 && rsi <= 20 && rsi > prevRsi) {
                signal = "BUY";
                type = "STRONG_BUY";
                confidence = 65 + baseConfidence;
                strength = "STRONG";
                reason.push(`RSI oversold reversal (${rsi})`);
            }
            else if (rsi >= 80 && rsi <= 87 && rsi < prevRsi) {
                signal = "SELL";
                type = "STRONG_SELL";
                confidence = 65 + baseConfidence;
                strength = "STRONG";
                reason.push(`RSI overbought reversal (${rsi})`);
            }
            // Trend start logic
            else {
                if (prevRsi <= 20 && rsi > 55 && rsi > prevRsi && htfRsi >= 50) {
                    signal = "BUY";
                    type = "TREND_BUY";
                    confidence = 45 + baseConfidence;
                    strength = "MODERATE";
                    reason.push("RSI reset from oversold into bullish expansion");
                }
                else if (prevRsi >= 80 && rsi < 45 && rsi < prevRsi && htfRsi <= 50) {
                    signal = "SELL";
                    type = "TREND_SELL";
                    confidence = 45 + baseConfidence;
                    strength = "MODERATE";
                    reason.push("RSI reset from overbought into bearish expansion");
                }
            }

            // Divergence boost
            if (signal !== "NO SIGNAL" && divergence) {
                confidence += 10;
                reason.push("RSI divergence confirmation");
            }

            confidence = Math.min(Math.max(confidence, 0), 100);
            
            // Position sizing
            let positionSize = null;
            if (signal !== "NO SIGNAL") {
                const volatility = data.atr || data.volatility || 0.01;
                const accountSize = data.accountSize || 10000;
                
                positionSize = positionCalculator.calculateSize(
                    confidence, 
                    strength, 
                    volatility, 
                    accountSize
                );
            }

            // Cooldown check
            const timeframeMinutes = {
                '1m': 1, '5m': 5, '15m': 15, '30m': 30,
                '1h': 60, '4h': 240, '1d': 1440, '1w': 10080
            }[data.timeframe] || 60;
            
            const cooldownPeriod = timeframeMinutes * 2 * 60000;
            
            if (signalHistory.lastSignalTime && 
                (Date.now() - signalHistory.lastSignalTime < cooldownPeriod) &&
                signal !== "NO SIGNAL") {
                const lastSignalAsset = signalHistory.logs[signalHistory.logs.length - 1]?.asset;
                
                if (lastSignalAsset === data.asset) {
                    return {
                        asset: data.asset,
                        timeframe: data.timeframe,
                        signal: "NO SIGNAL",
                        reason: `Cooldown active. Last signal was ${Math.round((Date.now() - signalHistory.lastSignalTime) / 60000)} minutes ago`,
                        cooldownRemaining: Math.round((cooldownPeriod - (Date.now() - signalHistory.lastSignalTime)) / 60000),
                        confidence: 0,
                        session: session
                    };
                }
            }

            // Output
            const output = {
                error: false,
                asset: data.asset,
                timeframe: data.timeframe,
                signal,
                type,
                strength,
                rsi,
                confidence: Math.round(confidence),
                session,
                sessionMultiplier: sessionWeight.toFixed(2),
                reason: reason.join(" | "),
                timestamp: new Date().toISOString(),
                positionSize: positionSize,
                price: data.price || null
            };

            if (signal !== "NO SIGNAL") {
                logSignal(output);
            }

            return output;
        }

        // UI Functions
        function generateSignal() {
            hideMessages();
            
            const data = {
                rsi: parseFloat(document.getElementById('rsi').value),
                prevRsi: parseFloat(document.getElementById('prevRsi').value),
                htfRsi: parseFloat(document.getElementById('htfRsi').value),
                asset: document.getElementById('asset').value,
                timeframe: document.getElementById('timeframe').value,
                price: parseFloat(document.getElementById('price').value) || null,
                atr: parseFloat(document.getElementById('atr').value) || 0.01,
                accountSize: parseFloat(document.getElementById('accountSize').value) || 10000,
                divergence: document.getElementById('divergence').checked
            };

            const result = killerZoneEngineV2(data);

            if (result.error) {
                showError(result.errors.join('<br>'));
                return;
            }

            updateSessionDisplay();
            displaySignalResult(result);
        }

        function generateRandomSignal() {
            const assets = ['EURUSD', 'GBPUSD', 'USDJPY', 'BTCUSD', 'XAUUSD'];
            const timeframes = ['5m', '15m', '1h', '4h'];
            
            document.getElementById('asset').value = assets[Math.floor(Math.random() * assets.length)];
            document.getElementById('timeframe').value = timeframes[Math.floor(Math.random() * timeframes.length)];
            document.getElementById('rsi').value = (Math.random() * 100).toFixed(1);
            document.getElementById('prevRsi').value = (parseFloat(document.getElementById('rsi').value) + (Math.random() * 10 - 5)).toFixed(1);
            document.getElementById('htfRsi').value = (Math.random() * 100).toFixed(1);
            document.getElementById('price').value = (Math.random() * 10000).toFixed(5);
            document.getElementById('atr').value = (Math.random() * 0.01).toFixed(5);
            document.getElementById('divergence').checked = Math.random() > 0.7;
            
            generateSignal();
        }

        function updateSessionDisplay() {
            const currentTime = Date.now();
            const session = sessionConfig.getCurrentSession(currentTime);
            const weight = sessionConfig.multipliers[session] || 1.0;
            const timeStr = new Date(currentTime).toUTCString().split(' ')[4];
            
            document.getElementById('currentSession').textContent = session;
            document.getElementById('sessionWeight').textContent = `Multiplier: ${weight.toFixed(1)}x`;
            document.getElementById('marketHours').textContent = timeStr;
            
            // Update session indicator styling
            const indicators = document.querySelectorAll('.session-indicator');
            indicators.forEach(ind => ind.classList.remove('active'));
            if (session.includes('LONDON') || session.includes('NEWYORK')) {
                document.getElementById('currentSession').classList.add('active');
            }
        }

        function displaySignalResult(result) {
            const signalDisplay = document.getElementById('signalDisplay');
            signalDisplay.style.display = 'block';
            
            document.getElementById('signalType').textContent = result.signal;
            document.getElementById('signalType').className = `signal-type ${result.signal.replace(' ', '_')}`;
            document.getElementById('signalTimestamp').textContent = new Date().toLocaleTimeString();
            
            document.getElementById('confidenceFill').style.width = `${result.confidence}%`;
            document.getElementById('confidenceText').textContent = `${result.confidence}% Confidence`;
            
            document.getElementById('signalStrength').textContent = result.strength || '-';
            document.getElementById('signalTypeDetail').textContent = result.type || '-';
            document.getElementById('signalRsi').textContent = result.rsi.toFixed(1);
            document.getElementById('signalSession').textContent = result.session;
            document.getElementById('signalReason').textContent = result.reason || 'No specific reason';
            
            if (result.positionSize) {
                document.getElementById('riskPercent').textContent = `${result.positionSize.riskPercentage}%`;
                document.getElementById('riskAmount').textContent = `$${result.positionSize.riskAmount}`;
                document.getElementById('positionSize').textContent = `$${result.positionSize.positionSize}`;
                document.getElementById('maxLeverage').textContent = `${result.positionSize.maxLeverage}:1`;
            } else {
                document.getElementById('riskPercent').textContent = '-';
                document.getElementById('riskAmount').textContent = '-';
                document.getElementById('positionSize').textContent = '-';
                document.getElementById('maxLeverage').textContent = '-';
            }
            
            if (result.signal === 'NO SIGNAL') {
                showMessage(`No signal generated: ${result.reason}`, 'info');
                signalDisplay.style.display = 'none';
            } else {
                showMessage(`Signal generated successfully!`, 'success');
                // Scroll to signal display
                signalDisplay.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function markAsWin() {
            if (!signalHistory.currentSignalId) {
                showError('No active signal to mark');
                return;
            }
            
            const pnl = Math.random() * 50 + 10; // Random P&L between 10-60 pips
            updateSignalOutcome(signalHistory.currentSignalId, {
                outcome: 'WIN',
                pnl: pnl,
                pnlPercent: (pnl / 100).toFixed(2)
            });
            
            showMessage(`Signal marked as WIN! +${pnl.toFixed(2)} pips`, 'success');
        }

        function markAsLoss() {
            if (!signalHistory.currentSignalId) {
                showError('No active signal to mark');
                return;
            }
            
            const pnl = -(Math.random() * 30 + 10); // Random loss between -10 to -40 pips
            updateSignalOutcome(signalHistory.currentSignalId, {
                outcome: 'LOSS',
                pnl: pnl,
                pnlPercent: (pnl / 100).toFixed(2)
            });
            
            showMessage(`Signal marked as LOSS. ${pnl.toFixed(2)} pips`, 'info');
        }

        function closeSignal() {
            document.getElementById('signalDisplay').style.display = 'none';
            signalHistory.currentSignalId = null;
            showMessage('Signal closed', 'info');
        }

        function showPerformanceReport() {
            const report = {
                totalSignals: signalHistory.performance.totalSignals,
                profitable: signalHistory.performance.profitable,
                unprofitable: signalHistory.performance.unprofitable,
                winRate: signalHistory.performance.winRate.toFixed(2),
                totalPips: signalHistory.performance.totalPips.toFixed(2)
            };
            
            const reportText = `
                PERFORMANCE REPORT:
                Total Signals: ${report.totalSignals}
                Profitable: ${report.profitable}
                Unprofitable: ${report.unprofitable}
                Win Rate: ${report.winRate}%
                Total Pips: ${report.totalPips}
            `;
            
            alert(reportText);
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all history?')) {
                signalHistory.logs = [];
                signalHistory.performance = {
                    totalSignals: 0,
                    profitable: 0,
                    unprofitable: 0,
                    totalPips: 0,
                    winRate: 0
                };
                
                updatePerformanceDisplay();
                updateHistoryTable();
                showMessage('History cleared successfully', 'success');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorDisplay');
            errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showMessage(message, type = 'success') {
            hideMessages();
            
            if (type === 'success') {
                const successDiv = document.getElementById('successDisplay');
                successDiv.innerHTML = `<strong>Success:</strong> ${message}`;
                successDiv.style.display = 'block';
                
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            }
        }

        function hideMessages() {
            document.getElementById('errorDisplay').style.display = 'none';
            document.getElementById('successDisplay').style.display = 'none';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateSessionDisplay();
            updatePerformanceDisplay();
            
            // Update session every minute
            setInterval(updateSessionDisplay, 60000);
            
            // Add some sample data for demonstration
            if (signalHistory.logs.length === 0) {
                for (let i = 0; i < 5; i++) {
                    const sampleSignal = {
                        id: `SAMPLE_${i}`,
                        timestamp: new Date(Date.now() - (i * 3600000)).toISOString(),
                        asset: ['EURUSD', 'GBPUSD', 'BTCUSD'][i % 3],
                        timeframe: ['1h', '4h', '15m'][i % 3],
                        signal: ['BUY', 'SELL'][i % 2],
                        type: ['EXTREME_BUY', 'STRONG_SELL', 'TREND_BUY'][i % 3],
                        strength: ['EXTREME', 'STRONG', 'MODERATE'][i % 3],
                        rsi: [15, 85, 30][i % 3],
                        confidence: [85, 75, 60][i % 3],
                        outcome: ['WIN', 'LOSS', 'WIN'][i % 3],
                        pnl: [25.5, -15.2, 32.1][i % 3]
                    };
                    signalHistory.logs.push(sampleSignal);
                }
                signalHistory.performance.totalSignals = 5;
                signalHistory.performance.profitable = 3;
                signalHistory.performance.unprofitable = 2;
                signalHistory.performance.totalPips = 42.4;
                signalHistory.performance.winRate = 60;
                
                updatePerformanceDisplay();
                updateHistoryTable();
            }
        });
    </script>
</body>
</html>
