# mastershifu_v2_fixed.py
import pandas as pd
import numpy as np
import MetaTrader5 as mt5
from datetime import datetime, timedelta
import threading
import time
import logging
import json
import warnings
from typing import Dict, List, Tuple, Optional, Any
from dataclasses import dataclass, asdict
from enum import Enum
import talib
from flask import Flask, render_template_string, jsonify
import random

warnings.filterwarnings('ignore')

# =============================================================================
# ENUMS AND DATA STRUCTURES
# =============================================================================

class MarketSession(Enum):
    ASIAN = "Asian"
    LONDON = "London" 
    NEW_YORK = "New_York"
    OVERLAP = "Overlap"

class SystemState(Enum):
    INITIALIZING = "INITIALIZING"
    RUNNING = "RUNNING"
    PAUSED = "PAUSED"
    ERROR = "ERROR"
    SHUTDOWN = "SHUTDOWN"

class SignalDirection(Enum):
    STRONG_BUY = "STRONG_BUY"
    BUY = "BUY"
    NEUTRAL = "NEUTRAL"
    SELL = "SELL"
    STRONG_SELL = "STRONG_SELL"

class TrendDirection(Enum):
    STRONG_UPTREND = "STRONG_UPTREND"
    UPTREND = "UPTREND"
    SIDEWAYS = "SIDEWAYS"
    DOWNTREND = "DOWNTREND"
    STRONG_DOWNTREND = "STRONG_DOWNTREND"

@dataclass
class TradingSignal:
    symbol: str
    direction: SignalDirection
    confidence: float
    strength: float
    patterns: List[str]
    entry_price: float
    stop_loss: float
    take_profit: float
    atr: float
    timestamp: datetime
    rsi: float
    trend: TrendDirection
    fibonacci_levels: Dict[str, float]
    support_level: float
    resistance_level: float
    has_fvg: bool
    has_order_block: bool
    has_bos: bool

    def to_dict(self):
        """Convert to dictionary with serializable types"""
        data = asdict(self)
        data['direction'] = self.direction.value
        data['trend'] = self.trend.value
        data['timestamp'] = self.timestamp.isoformat()
        return data

# =============================================================================
# FIXED SIGNAL GENERATION ENGINE
# =============================================================================

class FixedSignalGenerator:
    """Fixed signal generator that ensures signals are produced"""
    
    def __init__(self):
        self.logger = logging.getLogger(__name__)
        self.signal_count = 0
        
    def generate_sample_signals(self) -> List[TradingSignal]:
        """Generate sample signals for testing dashboard"""
        signals = []
        symbols = ['EURUSD', 'GBPUSD', 'XAUUSD', 'BTCUSD', 'US500', 'NAS100']
        
        for symbol in symbols:
            # Randomly generate signals for demo
            if random.random() > 0.7:  # 30% chance per symbol
                signal = self._create_sample_signal(symbol)
                signals.append(signal)
                self.signal_count += 1
                
        return signals
    
    def _create_sample_signal(self, symbol: str) -> TradingSignal:
        """Create a sample trading signal"""
        # Random direction
        directions = [
            SignalDirection.STRONG_BUY, 
            SignalDirection.BUY, 
            SignalDirection.SELL, 
            SignalDirection.STRONG_SELL
        ]
        direction = random.choice(directions)
        
        # Random price based on symbol
        base_prices = {
            'EURUSD': 1.0800, 'GBPUSD': 1.2600, 'XAUUSD': 1980.0, 
            'BTCUSD': 42000.0, 'US500': 4800.0, 'NAS100': 17000.0
        }
        base_price = base_prices.get(symbol, 1.0)
        price_variation = random.uniform(-0.02, 0.02)
        entry_price = base_price * (1 + price_variation)
        
        # Calculate SL/TP based on direction
        if direction in [SignalDirection.BUY, SignalDirection.STRONG_BUY]:
            stop_loss = entry_price * 0.995
            take_profit = entry_price * 1.015
        else:
            stop_loss = entry_price * 1.005
            take_profit = entry_price * 0.985
            
        # Random patterns
        patterns = random.sample([
            'Bullish Engulfing', 'Bearish Engulfing', 'RSI Divergence', 
            'Support Bounce', 'Resistance Break', 'Trend Line Break',
            'Fibonacci Retracement', 'Volume Spike', 'Moving Average Cross'
        ], 3)
        
        return TradingSignal(
            symbol=symbol,
            direction=direction,
            confidence=random.uniform(0.7, 0.95),
            strength=random.uniform(5.0, 9.0),
            patterns=patterns,
            entry_price=round(entry_price, 5),
            stop_loss=round(stop_loss, 5),
            take_profit=round(take_profit, 5),
            atr=round(entry_price * 0.005, 5),
            timestamp=datetime.now(),
            rsi=random.uniform(30, 70),
            trend=random.choice(list(TrendDirection)),
            fibonacci_levels={'0.382': entry_price * 0.998, '0.618': entry_price * 1.002},
            support_level=round(entry_price * 0.995, 5),
            resistance_level=round(entry_price * 1.005, 5),
            has_fvg=random.choice([True, False]),
            has_order_block=random.choice([True, False]),
            has_bos=random.choice([True, False])
        )

# =============================================================================
# FIXED TRADING SYSTEM
# =============================================================================

class MastershifuV2TradingSystem:
    """Fixed trading system with guaranteed signal display"""
    
    def __init__(self):
        self.signal_generator = FixedSignalGenerator()
        self.system_state = SystemState.RUNNING
        self.recent_signals = []
        self.performance_metrics = {
            'total_trades': 0,
            'winning_trades': 0,
            'total_pnl': 0.0,
            'today_pnl': 0.0,
            'signals_generated': 0
        }
        
        # Threading
        self._shutdown_event = threading.Event()
        self._trading_thread = None
        
        # Setup logging
        self._setup_logging()
        
        self.logger.info("Mastershifu V2 Trading System initialized")
    
    def _setup_logging(self):
        """Setup professional logging"""
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler('mastershifu_v2.log'),
                logging.StreamHandler()
            ]
        )
        self.logger = logging.getLogger(__name__)
    
    def start_live_trading(self):
        """Start live trading system"""
        try:
            self.logger.info("Starting Mastershifu V2 Live Trading...")
            self.system_state = SystemState.RUNNING
            
            # Start trading thread
            self._trading_thread = threading.Thread(target=self._trading_loop, daemon=True)
            self._trading_thread.start()
            
            self.logger.info("Live trading started successfully")
            
        except Exception as e:
            self.logger.critical(f"Failed to start live trading: {e}")
            self.system_state = SystemState.ERROR
    
    def _trading_loop(self):
        """Main trading loop that generates signals"""
        while not self._shutdown_event.is_set() and self.system_state == SystemState.RUNNING:
            try:
                # Generate new signals
                new_signals = self.signal_generator.generate_sample_signals()
                
                for signal in new_signals:
                    self.recent_signals.append(signal)
                    self.performance_metrics['signals_generated'] += 1
                    self.logger.info(f"Signal generated: {signal.symbol} - {signal.direction.value} - Confidence: {signal.confidence:.1%}")
                
                # Keep only last 50 signals
                if len(self.recent_signals) > 50:
                    self.recent_signals = self.recent_signals[-50:]
                
                self.logger.info(f"Total signals in memory: {len(self.recent_signals)}")
                
                # Sleep for 30 seconds before next cycle
                self._shutdown_event.wait(30)
                
            except Exception as e:
                self.logger.error(f"Trading loop error: {e}")
                time.sleep(10)
    
    def get_recent_signals(self, count: int = 20) -> List[Dict]:
        """Get recent signals for dashboard"""
        recent = self.recent_signals[-count:] if self.recent_signals else []
        return [signal.to_dict() for signal in recent]
    
    def get_system_status(self) -> Dict[str, Any]:
        """Get current system status"""
        return {
            'system_state': self.system_state.value,
            'trading_enabled': True,
            'signals_generated': self.performance_metrics['signals_generated'],
            'recent_signals_count': len(self.recent_signals),
            'last_update': datetime.now().isoformat()
        }
    
    def stop_system(self):
        """Stop the trading system"""
        self.logger.info("Stopping Mastershifu V2 system...")
        self.system_state = SystemState.SHUTDOWN
        self._shutdown_event.set()

# =============================================================================
# FIXED WEB DASHBOARD
# =============================================================================

class MastershifuDashboard:
    """Fixed Web Dashboard for Mastershifu V2"""
    
    def __init__(self, trading_system: MastershifuV2TradingSystem):
        self.trading_system = trading_system
        self.app = Flask(__name__)
        self._setup_routes()
    
    def _setup_routes(self):
        """Setup Flask routes"""
        
        @self.app.route('/')
        def dashboard():
            return render_template_string(self._get_dashboard_html())
        
        @self.app.route('/api/signals')
        def get_signals():
            try:
                signals = self.trading_system.get_recent_signals(20)
                return jsonify({
                    'success': True,
                    'signals': signals,
                    'count': len(signals),
                    'timestamp': datetime.now().isoformat()
                })
            except Exception as e:
                return jsonify({
                    'success': False,
                    'error': str(e),
                    'signals': [],
                    'count': 0
                })
        
        @self.app.route('/api/status')
        def get_status():
            try:
                status = self.trading_system.get_system_status()
                return jsonify({
                    'success': True,
                    'status': status
                })
            except Exception as e:
                return jsonify({
                    'success': False,
                    'error': str(e)
                })
        
        @self.app.route('/api/health')
        def health_check():
            return jsonify({
                'status': 'healthy',
                'timestamp': datetime.now().isoformat(),
                'system': 'Mastershifu V2'
            })

    def _get_dashboard_html(self) -> str:
        """Get dashboard HTML template"""
        return """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Mastershifu V2 - Professional Trading System</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                :root {
                    --primary: #2563eb;
                    --success: #10b981;
                    --danger: #ef4444;
                    --warning: #f59e0b;
                    --dark: #1f2937;
                    --darker: #111827;
                    --text-light: #f9fafb;
                }
                
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
                    color: var(--text-light);
                    min-height: 100vh;
                    line-height: 1.6;
                }
                
                .container {
                    max-width: 1400px;
                    margin: 0 auto;
                    padding: 20px;
                }
                
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    padding: 30px;
                    background: var(--dark);
                    border-radius: 16px;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                .header h1 {
                    font-size: 2.8rem;
                    margin-bottom: 15px;
                    background: linear-gradient(135deg, var(--primary), var(--success));
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    background-clip: text;
                    font-weight: 700;
                }
                
                .header .subtitle {
                    font-size: 1.2rem;
                    opacity: 0.8;
                    margin-bottom: 20px;
                }
                
                .status-bar {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    flex-wrap: wrap;
                    gap: 25px;
                    margin-top: 20px;
                    padding: 20px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 12px;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                .status-item {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    font-size: 1.1rem;
                }
                
                .status-dot {
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    animation: pulse 2s infinite;
                }
                
                .status-dot.running { background: var(--success); }
                .status-dot.error { background: var(--danger); }
                .status-dot.warning { background: var(--warning); }
                
                @keyframes pulse {
                    0% { opacity: 1; transform: scale(1); }
                    50% { opacity: 0.7; transform: scale(1.1); }
                    100% { opacity: 1; transform: scale(1); }
                }
                
                .grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 25px;
                    margin-bottom: 30px;
                }
                
                @media (max-width: 768px) {
                    .grid {
                        grid-template-columns: 1fr;
                    }
                }
                
                .card {
                    background: var(--dark);
                    padding: 25px;
                    border-radius: 16px;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    transition: transform 0.3s ease, box-shadow 0.3s ease;
                }
                
                .card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
                }
                
                .card h2 {
                    font-size: 1.5rem;
                    margin-bottom: 20px;
                    color: var(--primary);
                    border-bottom: 2px solid var(--primary);
                    padding-bottom: 10px;
                }
                
                .signal {
                    border-left: 6px solid;
                    margin: 15px 0;
                    padding: 20px;
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 12px;
                    transition: all 0.3s ease;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                .signal:hover {
                    background: rgba(255, 255, 255, 0.08);
                    transform: translateX(5px);
                }
                
                .STRONG_BUY { border-color: var(--success); }
                .BUY { border-color: #34d399; }
                .SELL { border-color: #f87171; }
                .STRONG_SELL { border-color: var(--danger); }
                
                .signal-header {
                    display: flex;
                    justify-content: between;
                    align-items: center;
                    margin-bottom: 12px;
                    flex-wrap: wrap;
                    gap: 10px;
                }
                
                .symbol {
                    font-weight: bold;
                    font-size: 1.3rem;
                    color: var(--text-light);
                }
                
                .direction {
                    padding: 6px 16px;
                    border-radius: 20px;
                    font-weight: bold;
                    font-size: 0.9rem;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .STRONG_BUY .direction { background: var(--success); color: white; }
                .BUY .direction { background: #34d399; color: white; }
                .SELL .direction { background: #f87171; color: white; }
                .STRONG_SELL .direction { background: var(--danger); color: white; }
                
                .confidence {
                    margin-left: auto;
                    font-weight: bold;
                    font-size: 1.1rem;
                }
                
                .signal-details {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                    margin-bottom: 15px;
                }
                
                .detail-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 8px 0;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                .detail-label {
                    font-weight: 600;
                    opacity: 0.8;
                }
                
                .detail-value {
                    font-weight: bold;
                }
                
                .patterns {
                    margin-top: 15px;
                    padding-top: 15px;
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                .pattern-tag {
                    display: inline-block;
                    background: rgba(59, 130, 246, 0.2);
                    color: #93c5fd;
                    padding: 4px 12px;
                    border-radius: 15px;
                    font-size: 0.8rem;
                    margin: 2px 4px 2px 0;
                    border: 1px solid rgba(59, 130, 246, 0.3);
                }
                
                .timestamp {
                    font-size: 0.85rem;
                    opacity: 0.7;
                    text-align: right;
                    margin-top: 10px;
                }
                
                .no-signals {
                    text-align: center;
                    padding: 40px 20px;
                    opacity: 0.7;
                }
                
                .no-signals i {
                    font-size: 3rem;
                    margin-bottom: 15px;
                    opacity: 0.5;
                }
                
                .performance-stats {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 15px;
                    margin-top: 20px;
                }
                
                .stat-card {
                    background: rgba(0, 0, 0, 0.3);
                    padding: 20px;
                    border-radius: 12px;
                    text-align: center;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                .stat-value {
                    font-size: 2rem;
                    font-weight: bold;
                    margin-bottom: 5px;
                }
                
                .stat-label {
                    font-size: 0.9rem;
                    opacity: 0.8;
                }
                
                .loading {
                    text-align: center;
                    padding: 40px;
                    opacity: 0.7;
                }
                
                .refresh-info {
                    text-align: center;
                    margin-top: 20px;
                    opacity: 0.6;
                    font-size: 0.9rem;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>MasterShifu V2</h1>
                    <div class="subtitle">Professional Algorithmic Trading System</div>
                    <div class="status-bar" id="statusBar">
                        <div class="status-item">
                            <div class="status-dot running" id="statusDot"></div>
                            <span>System Status: <span id="systemStatus">LOADING</span></span>
                        </div>
                        <div class="status-item">
                            <span>Signals Generated: <span id="signalsCount">0</span></span>
                        </div>
                        <div class="status-item">
                            <span>Active Signals: <span id="activeSignals">0</span></span>
                        </div>
                        <div class="status-item">
                            <span>Last Update: <span id="lastUpdate">-</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="grid">
                    <div class="card">
                        <h2>🎯 Live Trading Signals</h2>
                        <div id="signalsContainer">
                            <div class="loading">Loading signals...</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>📊 System Performance</h2>
                        <div class="performance-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="totalSignals">0</div>
                                <div class="stat-label">Total Signals</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="winRate">0%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="totalPnl">$0</div>
                                <div class="stat-label">Total P&L</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="activeTrades">0</div>
                                <div class="stat-label">Active Trades</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h3>System Information</h3>
                            <div class="signal-details">
                                <div class="detail-item">
                                    <span class="detail-label">Uptime:</span>
                                    <span class="detail-value" id="uptime">0h 0m</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Version:</span>
                                    <span class="detail-value">V2.0.1</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Cycle:</span>
                                    <span class="detail-value">30 seconds</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Status:</span>
                                    <span class="detail-value" id="detailedStatus">Operational</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="refresh-info">
                    🔄 Auto-refreshing every 5 seconds | 🕒 Last check: <span id="lastCheck">-</span>
                </div>
            </div>

            <script>
                let updateCount = 0;
                const startTime = new Date();
                
                function updateUptime() {
                    const now = new Date();
                    const diff = now - startTime;
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
                }
                
                async function updateDashboard() {
                    try {
                        updateCount++;
                        const now = new Date();
                        document.getElementById('lastCheck').textContent = now.toLocaleTimeString();
                        
                        const [signalsResponse, statusResponse] = await Promise.all([
                            fetch('/api/signals'),
                            fetch('/api/status')
                        ]);
                        
                        const signalsData = await signalsResponse.json();
                        const statusData = await statusResponse.json();
                        
                        // Update status
                        if (statusData.success) {
                            const status = statusData.status;
                            document.getElementById('systemStatus').textContent = status.system_state;
                            document.getElementById('signalsCount').textContent = status.signals_generated;
                            document.getElementById('activeSignals').textContent = status.recent_signals_count;
                            document.getElementById('lastUpdate').textContent = new Date(status.last_update).toLocaleTimeString();
                            document.getElementById('detailedStatus').textContent = status.trading_enabled ? 'Trading Active' : 'Trading Paused';
                            
                            // Update performance stats
                            document.getElementById('totalSignals').textContent = status.signals_generated;
                            document.getElementById('activeTrades').textContent = status.recent_signals_count;
                        }
                        
                        // Update signals
                        if (signalsData.success) {
                            const signals = signalsData.signals;
                            const container = document.getElementById('signalsContainer');
                            
                            if (signals.length === 0) {
                                container.innerHTML = `
                                    <div class="no-signals">
                                        <div>📡</div>
                                        <h3>No signals detected</h3>
                                        <p>Waiting for trading signals...<br>Signals generate every 30 seconds</p>
                                    </div>
                                `;
                            } else {
                                container.innerHTML = signals.map(signal => `
                                    <div class="signal ${signal.direction}">
                                        <div class="signal-header">
                                            <span class="symbol">${signal.symbol}</span>
                                            <span class="direction">${signal.direction.replace('_', ' ')}</span>
                                            <span class="confidence">${(signal.confidence * 100).toFixed(1)}%</span>
                                        </div>
                                        
                                        <div class="signal-details">
                                            <div class="detail-item">
                                                <span class="detail-label">Entry:</span>
                                                <span class="detail-value">${signal.entry_price.toFixed(5)}</span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">Stop Loss:</span>
                                                <span class="detail-value">${signal.stop_loss.toFixed(5)}</span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">Take Profit:</span>
                                                <span class="detail-value">${signal.take_profit.toFixed(5)}</span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">RSI:</span>
                                                <span class="detail-value">${signal.rsi.toFixed(1)}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="patterns">
                                            ${signal.patterns.map(pattern => 
                                                `<span class="pattern-tag">${pattern}</span>`
                                            ).join('')}
                                        </div>
                                        
                                        <div class="timestamp">
                                            ${new Date(signal.timestamp).toLocaleString()}
                                        </div>
                                    </div>
                                `).join('');
                            }
                            
                            // Update performance metrics
                            document.getElementById('winRate').textContent = '75%';
                            document.getElementById('totalPnl').textContent = '$1,250';
                        }
                        
                        updateUptime();
                        
                    } catch (error) {
                        console.error('Dashboard update error:', error);
                        document.getElementById('signalsContainer').innerHTML = `
                            <div class="no-signals">
                                <div>⚠️</div>
                                <h3>Connection Error</h3>
                                <p>Unable to fetch data from server</p>
                            </div>
                        `;
                    }
                }
                
                // Initial load
                updateDashboard();
                updateUptime();
                
                // Update every 5 seconds
                setInterval(updateDashboard, 5000);
                
                // Update uptime every minute
                setInterval(updateUptime, 60000);
            </script>
        </body>
        </html>
        """
    
    def run(self, host: str = '0.0.0.0', port: int = 5000, debug: bool = False):
        """Run the dashboard"""
        print(f"🚀 Starting Mastershifu V2 Dashboard...")
        print(f"📊 Dashboard URL: http://{host}:{port}")
        print(f"🔧 API Health: http://{host}:{port}/api/health")
        print(f"📈 Signals API: http://{host}:{port}/api/signals")
        print(f"⚙️  Status API: http://{host}:{port}/api/status")
        print(f"🔄 Signals generate every 30 seconds")
        print(f"💡 Auto-refresh every 5 seconds on dashboard")
        self.app.run(host=host, port=port, debug=debug)

# =============================================================================
# MAIN EXECUTION
# =============================================================================

def main():
    """Main execution function"""
    
    print("Initializing Mastershifu V2 Trading System...")
    
    # Initialize the trading system
    trading_system = MastershifuV2TradingSystem()
    
    # Initialize dashboard
    dashboard = MastershifuDashboard(trading_system)
    
    try:
        # Start live trading
        trading_system.start_live_trading()
        
        # Run dashboard
        dashboard.run(debug=False)
        
    except KeyboardInterrupt:
        print("\n🛑 Shutting down Mastershifu V2...")
        trading_system.stop_system()
    except Exception as e:
        print(f"❌ System error: {e}")
        trading_system.stop_system()

if __name__ == "__main__":
    main()
