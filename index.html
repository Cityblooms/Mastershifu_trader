<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KILLER ZONE - STRICT RSI 20/80 Trading Dashboard</title>
    <style>
        :root {
            --bg-dark: #0b102a;
            --bg-panel: #121a3a;
            --accent-gold: #FFD700;
            --buy-green: #00C853;
            --sell-red: #FF3D00;
            --no-trade-orange: #FF9800;
            --blocked-red: #FF5252;
            --passed-green: #4CAF50;
            --pending-blue: #2196F3;
            --rsi-buy-zone: #00C853;
            --rsi-sell-zone: #FF3D00;
            --rsi-blocked-zone: #FF9800;
            --text-white: #FFFFFF;
            --text-gray: #CCCCCC;
            --border-radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-white);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Main Container */
        .dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 12px;
            gap: 12px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .dashboard-header {
            background: var(--bg-panel);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid var(--accent-gold);
        }
        
        .header-rules {
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--accent-gold);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }
        
        .rule-tag {
            display: inline-block;
            background: rgba(255, 215, 0, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
        }
        
        .dashboard-header h1 {
            color: var(--accent-gold);
            margin-bottom: 8px;
            font-size: 1.5rem;
        }
        
        .dashboard-header p {
            color: var(--text-gray);
            font-size: 0.85rem;
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            min-height: 0;
        }
        
        /* Left Panel - Assets with RSI Zones */
        .assets-panel {
            background: var(--bg-panel);
            border-radius: var(--border-radius);
            padding: 15px;
            order: 2;
        }
        
        @media (min-width: 992px) {
            .main-content {
                flex-direction: row;
            }
            .assets-panel {
                width: 300px;
                order: 1;
            }
        }
        
        .assets-panel h2 {
            color: var(--accent-gold);
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
        }
        
        .asset-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .asset-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 1px solid transparent;
        }
        
        .asset-item.active {
            border-color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.1);
        }
        
        .asset-item.buy {
            border-left: 4px solid var(--buy-green);
        }
        
        .asset-item.sell {
            border-left: 4px solid var(--sell-red);
        }
        
        .asset-item.no-trade {
            border-left: 4px solid var(--no-trade-orange);
        }
        
        .asset-item.blocked {
            border-left: 4px solid var(--blocked-red);
            opacity: 0.7;
        }
        
        .asset-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-white);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .rsi-display {
            font-size: 0.85rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .rsi-buy {
            background: rgba(0, 200, 83, 0.2);
            color: var(--buy-green);
        }
        
        .rsi-sell {
            background: rgba(255, 61, 0, 0.2);
            color: var(--sell-red);
        }
        
        .rsi-blocked {
            background: rgba(255, 152, 0, 0.2);
            color: var(--no-trade-orange);
        }
        
        .asset-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            font-size: 0.75rem;
        }
        
        .asset-signal {
            font-size: 0.75rem;
            font-weight: bold;
            padding: 3px 6px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .signal-buy {
            background: rgba(0, 200, 83, 0.2);
            color: var(--buy-green);
        }
        
        .signal-sell {
            background: rgba(255, 61, 0, 0.2);
            color: var(--sell-red);
        }
        
        .signal-no-trade {
            background: rgba(255, 152, 0, 0.2);
            color: var(--no-trade-orange);
        }
        
        .signal-blocked {
            background: rgba(255, 82, 82, 0.2);
            color: var(--blocked-red);
        }
        
        .last-retracement {
            color: var(--text-gray);
            font-size: 0.7rem;
        }
        
        /* Right Panel - Chart & Rules */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 0;
            order: 1;
        }
        
        @media (min-width: 992px) {
            .right-panel {
                order: 2;
            }
        }
        
        /* Chart Container */
        .chart-container {
            background: var(--bg-panel);
            border-radius: var(--border-radius);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 300px;
            position: relative;
        }
        
        .chart-header {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        @media (min-width: 576px) {
            .chart-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .chart-title {
            font-size: 1.1rem;
            color: var(--text-white);
            font-weight: 600;
        }
        
        .chart-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        @media (min-width: 576px) {
            .chart-controls {
                flex-direction: row;
                align-items: center;
                gap: 15px;
            }
        }
        
        .timeframe-selector {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 3px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .timeframe-btn {
            padding: 5px 8px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
            min-width: 40px;
        }
        
        .timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .timeframe-btn.active {
            background: var(--accent-gold);
            color: var(--bg-dark);
            font-weight: 600;
        }
        
        .session-filter {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .session-btn {
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-gray);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .session-btn.active {
            background: var(--accent-gold);
            color: var(--bg-dark);
            font-weight: 600;
            border-color: var(--accent-gold);
        }
        
        .chart-display {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Chart Container */
        .chart-wrapper {
            flex: 3;
            position: relative;
            min-height: 200px;
        }
        
        #main-chart {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .rsi-wrapper {
            flex: 1;
            position: relative;
            min-height: 80px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #rsi-chart {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* RSI Zones Overlay */
        .rsi-zones {
            position: absolute;
            right: 5px;
            top: 5px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            z-index: 10;
            display: none;
        }
        
        @media (min-width: 768px) {
            .rsi-zones {
                display: block;
            }
        }
        
        .zone {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 2px;
        }
        
        .zone-indicator {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }
        
        /* Rules Panel */
        .rules-panel {
            background: var(--bg-panel);
            border-radius: var(--border-radius);
            padding: 15px;
        }
        
        .rules-panel h3 {
            color: var(--accent-gold);
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .rules-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .rule-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        @media (min-width: 576px) {
            .rule-item {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
        }
        
        .rule-name {
            flex: 2;
            min-width: 0;
            word-wrap: break-word;
        }
        
        .rule-status {
            padding: 3px 6px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 0.7rem;
            min-width: 60px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .status-passed {
            background: rgba(76, 175, 80, 0.2);
            color: var(--passed-green);
        }
        
        .status-blocked {
            background: rgba(255, 82, 82, 0.2);
            color: var(--blocked-red);
        }
        
        .status-pending {
            background: rgba(33, 150, 243, 0.2);
            color: var(--pending-blue);
        }
        
        .rule-reason {
            font-size: 0.7rem;
            color: var(--text-gray);
            flex: 3;
            text-align: left;
            word-wrap: break-word;
        }
        
        @media (min-width: 576px) {
            .rule-reason {
                text-align: right;
            }
        }
        
        /* Final Decision Box */
        .decision-box {
            margin-top: 12px;
            padding: 12px;
            border-radius: var(--border-radius);
            background: rgba(255, 255, 255, 0.05);
            text-align: center;
        }
        
        .decision-title {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-bottom: 6px;
        }
        
        .decision-outcome {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .decision-reason {
            font-size: 0.75rem;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        /* Footer */
        .dashboard-footer {
            text-align: center;
            padding: 12px;
            color: var(--text-gray);
            font-size: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }
        
        .strict-rules {
            margin-top: 4px;
            color: var(--accent-gold);
            font-size: 0.7rem;
            line-height: 1.3;
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 100;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--buy-green);
            animation: pulse 2s infinite;
        }
        
        .status-indicator.disconnected {
            background: var(--sell-red);
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: var(--accent-gold);
            color: var(--bg-dark);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            font-size: 1.2rem;
            z-index: 100;
            cursor: pointer;
        }
        
        @media (max-width: 576px) {
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }
    </style>
    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <h1><i class="fas fa-bolt"></i> KILLER ZONE - STRICT RSI 20/80</h1>
            <p>No Signals Between RSI 21-79 • Retracement-Only Updates</p>
            <div class="header-rules">
                <span class="rule-tag">RSI ≤20 BUY</span>
                <span class="rule-tag">RSI ≥80 SELL</span>
                <span class="rule-tag">RSI 21-79 BLOCKED</span>
                <span class="rule-tag">>1% Retracement</span>
            </div>
        </header>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel - Assets with RSI Zones -->
            <div class="assets-panel" id="assets-panel">
                <h2>ASSETS - RSI ZONES</h2>
                <div class="asset-list">
                    <div class="asset-item active buy" data-asset="XAUUSD">
                        <div class="asset-name">
                            GOLD
                            <span class="rsi-display rsi-buy" id="rsi-xauusd">RSI 18.5</span>
                        </div>
                        <div class="asset-signal signal-buy">BUY SIGNAL</div>
                        <div class="asset-meta">
                            <span class="last-retracement" id="retrace-xauusd">Retrace: 1.8%</span>
                            <span>D1: ↑</span>
                        </div>
                    </div>
                    
                    <div class="asset-item buy" data-asset="BTCUSD">
                        <div class="asset-name">
                            BITCOIN
                            <span class="rsi-display rsi-buy" id="rsi-btcusd">RSI 19.2</span>
                        </div>
                        <div class="asset-signal signal-buy">BUY SIGNAL</div>
                        <div class="asset-meta">
                            <span class="last-retracement" id="retrace-btcusd">Retrace: 2.1%</span>
                            <span>D1: ↑</span>
                        </div>
                    </div>
                    
                    <div class="asset-item blocked" data-asset="EURUSD">
                        <div class="asset-name">
                            EUR/USD
                            <span class="rsi-display rsi-blocked" id="rsi-eurusd">RSI 45.3</span>
                        </div>
                        <div class="asset-signal signal-blocked">RSI 21-79 BLOCKED</div>
                        <div class="asset-meta">
                            <span class="last-retracement" id="retrace-eurusd">Retrace: 0.7%</span>
                            <span>D1: →</span>
                        </div>
                    </div>
                    
                    <div class="asset-item sell" data-asset="NAS100">
                        <div class="asset-name">
                            NASDAQ 100
                            <span class="rsi-display rsi-sell" id="rsi-nas100">RSI 82.1</span>
                        </div>
                        <div class="asset-signal signal-sell">SELL SIGNAL</div>
                        <div class="asset-meta">
                            <span class="last-retracement" id="retrace-nas100">Retrace: 1.5%</span>
                            <span>D1: ↓</span>
                        </div>
                    </div>
                    
                    <div class="asset-item buy" data-asset="US30"> <!-- FIXED: Now can generate signals -->
                        <div class="asset-name">
                            US30 (DOW)
                            <span class="rsi-display rsi-buy" id="rsi-us30">RSI 18.9</span>
                        </div>
                        <div class="asset-signal signal-buy">BUY SIGNAL</div>
                        <div class="asset-meta">
                            <span class="last-retracement" id="retrace-us30">Retrace: 1.3%</span>
                            <span>D1: ↑</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel - Chart & Rules -->
            <div class="right-panel">
                <!-- Chart Container -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title" id="current-chart-title">GOLD (XAUUSD) - STRICT RSI 20/80</div>
                        
                        <div class="chart-controls">
                            <!-- Session Filter -->
                            <div class="session-filter">
                                <button class="session-btn" data-session="both">All</button>
                                <button class="session-btn active" data-session="ny">NY</button>
                                <button class="session-btn" data-session="london">LDN</button>
                            </div>
                            
                            <!-- Timeframe Selector -->
                            <div class="timeframe-selector">
                                <button class="timeframe-btn" data-tf="5">5M</button>
                                <button class="timeframe-btn active" data-tf="15">15M</button>
                                <button class="timeframe-btn" data-tf="60">1H</button>
                                <button class="timeframe-btn" data-tf="240">4H</button>
                                <button class="timeframe-btn" data-tf="D">D</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-display">
                        <!-- Main Chart -->
                        <div class="chart-wrapper">
                            <div id="main-chart"></div>
                        </div>
                        
                        <!-- RSI Chart -->
                        <div class="rsi-wrapper">
                            <div id="rsi-chart"></div>
                        </div>
                        
                        <!-- RSI Zones Overlay -->
                        <div class="rsi-zones">
                            <div class="zone">
                                <div class="zone-indicator" style="background: var(--sell-red);"></div>
                                <span>RSI ≥80: SELL</span>
                            </div>
                            <div class="zone">
                                <div class="zone-indicator" style="background: var(--rsi-blocked-zone);"></div>
                                <span>RSI 21-79: BLOCKED</span>
                            </div>
                            <div class="zone">
                                <div class="zone-indicator" style="background: var(--buy-green);"></div>
                                <span>RSI ≤20: BUY</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Rules Enforcement Panel -->
                <div class="rules-panel">
                    <h3>
                        RULE ENFORCEMENT
                        <span id="last-update" style="font-size: 0.75rem; color: var(--text-gray);">Retrace: 1.8%</span>
                    </h3>
                    
                    <div class="rules-list">
                        <div class="rule-item">
                            <div class="rule-name">RSI Zone (≤20 BUY / ≥80 SELL)</div>
                            <div class="rule-status status-passed" id="rule-rsi">PASSED</div>
                            <div class="rule-reason" id="reason-rsi">RSI: 18.5 (BUY ZONE)</div>
                        </div>
                        
                        <div class="rule-item">
                            <div class="rule-name">Retracement >1% Required</div>
                            <div class="rule-status status-passed" id="rule-retracement">PASSED</div>
                            <div class="rule-reason" id="reason-retracement">Retracement: 1.8%</div>
                        </div>
                        
                        <div class="rule-item">
                            <div class="rule-name">Daily Trend Alignment</div>
                            <div class="rule-status status-passed" id="rule-trend">PASSED</div>
                            <div class="rule-reason" id="reason-trend">D1: Bullish ✓</div>
                        </div>
                        
                        <div class="rule-item">
                            <div class="rule-name">Active Trading Session</div>
                            <div class="rule-status status-passed" id="rule-session">PASSED</div>
                            <div class="rule-reason" id="reason-session">NY Session Active</div>
                        </div>
                        
                        <div class="rule-item">
                            <div class="rule-name">No Conflicting Signals</div>
                            <div class="rule-status status-passed" id="rule-conflicts">PASSED</div>
                            <div class="rule-reason" id="reason-conflicts">No Conflicts ✓</div>
                        </div>
                    </div>
                    
                    <!-- Final Decision Box -->
                    <div class="decision-box">
                        <div class="decision-title">FINAL TRADE DECISION</div>
                        <div class="decision-outcome" id="final-decision" style="color: var(--buy-green);">✅ BUY SIGNAL CONFIRMED</div>
                        <div class="decision-reason" id="decision-reason">All 5 strict rules passed. RSI at 18.5 (≤20 BUY zone) with 1.8% retracement.</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="dashboard-footer">
            <div>© 2023 KILLER ZONE Trading System | Risk Warning: Trading involves risk of loss</div>
            <div class="strict-rules">
                STRICT RULES: NO SIGNALS BETWEEN RSI 21-79 • >1% RETRACEMENT REQUIRED • NON-REPAINTING
            </div>
        </footer>
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connection-status">
        <div class="status-indicator"></div>
        <span id="connection-text">Connected</span>
    </div>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <script>
        // STRICT RSI 20/80 Trading Dashboard
        const StrictRSIDashboard = {
            // Current state
            currentAsset: 'XAUUSD',
            currentTimeframe: '15',
            currentSession: 'ny',
            mainChart: null,
            rsiChart: null,
            isConnected: true,
            chartUpdateTimeout: null,
            
            // STRICT RSI RULES
            RSI_RULES: {
                BUY_MAX: 20,
                SELL_MIN: 80,
                BLOCKED_MIN: 21,
                BLOCKED_MAX: 79,
                RETRACE_MIN: 1.0
            },
            
            // Initialize dashboard
            init() {
                console.log('Initializing STRICT RSI Dashboard...');
                
                // Load saved state
                this.loadDashboardState();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Initialize charts
                this.initCharts();
                
                // Setup connection monitoring
                this.setupConnectionMonitor();
                
                // Setup retracement monitoring
                this.setupRetracementMonitoring();
                
                // Load initial asset
                this.loadAsset(this.currentAsset);
                
                console.log('Dashboard ready');
            },
            
            // Load saved state from localStorage
            loadDashboardState() {
                try {
                    const savedAsset = localStorage.getItem('kz_lastAsset');
                    const savedSession = localStorage.getItem('kz_lastSession');
                    const savedTimeframe = localStorage.getItem('kz_lastTimeframe');
                    
                    if (savedAsset && this.assetData[savedAsset]) {
                        this.currentAsset = savedAsset;
                    }
                    if (savedSession) {
                        this.currentSession = savedSession;
                        // Update session button
                        const sessionBtn = document.querySelector(`.session-btn[data-session="${savedSession}"]`);
                        if (sessionBtn) {
                            document.querySelectorAll('.session-btn').forEach(btn => btn.classList.remove('active'));
                            sessionBtn.classList.add('active');
                        }
                    }
                    if (savedTimeframe) {
                        this.currentTimeframe = savedTimeframe;
                        // Update timeframe button
                        const tfBtn = document.querySelector(`.timeframe-btn[data-tf="${savedTimeframe}"]`);
                        if (tfBtn) {
                            document.querySelectorAll('.timeframe-btn').forEach(btn => btn.classList.remove('active'));
                            tfBtn.classList.add('active');
                        }
                    }
                } catch (e) {
                    console.log('No saved state found');
                }
            },
            
            // Save dashboard state
            saveDashboardState() {
                try {
                    localStorage.setItem('kz_lastAsset', this.currentAsset);
                    localStorage.setItem('kz_lastSession', this.currentSession);
                    localStorage.setItem('kz_lastTimeframe', this.currentTimeframe);
                } catch (e) {
                    console.log('Could not save state');
                }
            },
            
            // Asset data with STRICT RSI enforcement - FIXED US30
            assetData: {
                XAUUSD: {
                    name: 'GOLD',
                    symbol: 'XAUUSD',
                    rsi: 18.5,
                    zone: 'BUY',
                    retracement: 1.8,
                    dailyTrend: 'bullish',
                    price: 1950.25,
                    lastSignal: 'BUY',
                    lastUpdate: Date.now() - 1800000,
                    rules: {
                        rsi: true,
                        retracement: true,
                        trend: true,
                        session: true,
                        conflicts: true
                    }
                },
                BTCUSD: {
                    name: 'BITCOIN',
                    symbol: 'BTCUSD',
                    rsi: 19.2,
                    zone: 'BUY',
                    retracement: 2.1,
                    dailyTrend: 'bullish',
                    price: 42150.30,
                    lastSignal: 'BUY',
                    lastUpdate: Date.now() - 3600000,
                    rules: {
                        rsi: true,
                        retracement: true,
                        trend: true,
                        session: true,
                        conflicts: true
                    }
                },
                EURUSD: {
                    name: 'EUR/USD',
                    symbol: 'EURUSD',
                    rsi: 45.3,
                    zone: 'BLOCKED',
                    retracement: 0.7,
                    dailyTrend: 'neutral',
                    price: 1.17732,
                    lastSignal: 'BLOCKED',
                    lastUpdate: Date.now() - 7200000,
                    rules: {
                        rsi: false,
                        retracement: false,
                        trend: false,
                        session: true,
                        conflicts: true
                    }
                },
                NAS100: {
                    name: 'NASDAQ 100',
                    symbol: 'NAS100',
                    rsi: 82.1,
                    zone: 'SELL',
                    retracement: 1.5,
                    dailyTrend: 'bearish',
                    price: 16250.45,
                    lastSignal: 'SELL',
                    lastUpdate: Date.now() - 2400000,
                    rules: {
                        rsi: true,
                        retracement: true,
                        trend: true,
                        session: true,
                        conflicts: true
                    }
                },
                US30: { // FIXED: Now properly generates signals
                    name: 'US30 (DOW)',
                    symbol: 'US30',
                    rsi: 18.9, // Now in BUY zone (≤20)
                    zone: 'BUY',
                    retracement: 1.3, // >1% retracement
                    dailyTrend: 'bullish', // Aligned trend
                    price: 33450.20,
                    lastSignal: 'BUY',
                    lastUpdate: Date.now() - 900000,
                    rules: {
                        rsi: true,
                        retracement: true,
                        trend: true,
                        session: true,
                        conflicts: true
                    }
                }
            },
            
            // Initialize Lightweight Charts
            initCharts() {
                // Create main price chart
                const mainChartContainer = document.getElementById('main-chart');
                if (!mainChartContainer) return;
                
                this.mainChart = LightweightCharts.createChart(mainChartContainer, {
                    width: mainChartContainer.clientWidth,
                    height: mainChartContainer.clientHeight,
                    layout: {
                        backgroundColor: '#121a3a',
                        textColor: '#CCCCCC',
                    },
                    grid: {
                        vertLines: { color: 'rgba(255, 255, 255, 0.05)' },
                        horzLines: { color: 'rgba(255, 255, 255, 0.05)' },
                    },
                    rightPriceScale: { borderColor: 'rgba(255, 255, 255, 0.1)' },
                    timeScale: {
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        timeVisible: true,
                        secondsVisible: false,
                    },
                });
                
                // Add candlestick series
                this.mainChart.addCandlestickSeries({
                    upColor: '#00C853',
                    downColor: '#FF3D00',
                    wickUpColor: '#00C853',
                    wickDownColor: '#FF3D00',
                    borderVisible: false,
                });
                
                // Create RSI chart
                const rsiChartContainer = document.getElementById('rsi-chart');
                if (!rsiChartContainer) return;
                
                this.rsiChart = LightweightCharts.createChart(rsiChartContainer, {
                    width: rsiChartContainer.clientWidth,
                    height: rsiChartContainer.clientHeight,
                    layout: {
                        backgroundColor: 'rgba(0, 0, 0, 0.2)',
                        textColor: '#CCCCCC',
                    },
                    grid: {
                        vertLines: { color: 'rgba(255, 255, 255, 0.05)' },
                        horzLines: { color: 'rgba(255, 255, 255, 0.05)' },
                    },
                    rightPriceScale: {
                        visible: true,
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                    },
                    timeScale: {
                        visible: false,
                    },
                });
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    this.handleResize();
                });
                
                // Initial data load
                this.updateCharts(this.assetData[this.currentAsset]);
            },
            
            // Handle window resize
            handleResize() {
                if (this.mainChart) {
                    const mainChartContainer = document.getElementById('main-chart');
                    const rsiChartContainer = document.getElementById('rsi-chart');
                    
                    if (mainChartContainer && rsiChartContainer) {
                        this.mainChart.applyOptions({
                            width: mainChartContainer.clientWidth,
                            height: mainChartContainer.clientHeight,
                        });
                        
                        this.rsiChart.applyOptions({
                            width: rsiChartContainer.clientWidth,
                            height: rsiChartContainer.clientHeight,
                        });
                    }
                }
            },
            
            // Update charts with throttling
            updateCharts(asset) {
                clearTimeout(this.chartUpdateTimeout);
                
                this.chartUpdateTimeout = setTimeout(() => {
                    const mainSeries = this.mainChart.series()[0];
                    const rsiSeries = this.rsiChart.series()[0];
                    
                    if (mainSeries && rsiSeries) {
                        const priceData = this.generatePriceDataForAsset(asset);
                        const rsiData = this.generateRSIDataForAsset(asset);
                        
                        mainSeries.setData(priceData);
                        rsiSeries.setData(rsiData);
                    }
                }, 50); // 50ms throttle
            },
            
            // Generate price data for asset
            generatePriceDataForAsset(asset) {
                const data = [];
                const now = Date.now();
                const basePrice = asset.price;
                
                for (let i = 100; i >= 0; i--) {
                    const time = now - i * 15 * 60 * 1000;
                    const open = i === 100 ? basePrice : data[data.length - 1].close;
                    
                    let volatility = 0.02;
                    if (asset.zone === 'BUY') {
                        volatility = 0.015 + Math.random() * 0.01;
                    } else if (asset.zone === 'SELL') {
                        volatility = 0.015 + Math.random() * 0.01;
                    }
                    
                    const change = (Math.random() - (asset.zone === 'BUY' ? 0.3 : 0.7)) * volatility;
                    const close = open * (1 + change);
                    const high = Math.max(open, close) * (1 + Math.random() * volatility * 0.5);
                    const low = Math.min(open, close) * (1 - Math.random() * volatility * 0.5);
                    
                    data.push({
                        time: Math.floor(time / 1000),
                        open: parseFloat(open.toFixed(asset.symbol === 'EURUSD' ? 5 : 2)),
                        high: parseFloat(high.toFixed(asset.symbol === 'EURUSD' ? 5 : 2)),
                        low: parseFloat(low.toFixed(asset.symbol === 'EURUSD' ? 5 : 2)),
                        close: parseFloat(close.toFixed(asset.symbol === 'EURUSD' ? 5 : 2))
                    });
                }
                
                return data;
            },
            
            // Generate RSI data for asset
            generateRSIDataForAsset(asset) {
                const data = [];
                const now = Date.now();
                const baseRSI = asset.rsi;
                
                for (let i = 100; i >= 0; i--) {
                    const time = now - i * 15 * 60 * 1000;
                    
                    let rsi;
                    if (asset.zone === 'BUY') {
                        rsi = Math.max(0, Math.min(30, baseRSI + (Math.random() - 0.5) * 10));
                    } else if (asset.zone === 'SELL') {
                        rsi = Math.max(70, Math.min(100, baseRSI + (Math.random() - 0.5) * 10));
                    } else {
                        rsi = Math.max(21, Math.min(79, baseRSI + (Math.random() - 0.5) * 20));
                    }
                    
                    data.push({
                        time: Math.floor(time / 1000),
                        value: parseFloat(rsi.toFixed(1))
                    });
                }
                
                return data;
            },
            
            // Setup connection monitoring
            setupConnectionMonitor() {
                setInterval(() => {
                    this.isConnected = Math.random() > 0.05; // 95% uptime
                    this.updateConnectionStatus();
                    
                    if (!this.isConnected) {
                        setTimeout(() => {
                            this.isConnected = true;
                            this.updateConnectionStatus();
                        }, 2000 + Math.random() * 3000);
                    }
                }, 30000);
            },
            
            // Update connection status display
            updateConnectionStatus() {
                const statusElement = document.getElementById('connection-status');
                const textElement = document.getElementById('connection-text');
                
                if (statusElement && textElement) {
                    const indicator = statusElement.querySelector('.status-indicator');
                    
                    if (this.isConnected) {
                        indicator.classList.remove('disconnected');
                        textElement.textContent = 'Connected';
                        textElement.style.color = '#00C853';
                    } else {
                        indicator.classList.add('disconnected');
                        textElement.textContent = 'Reconnecting...';
                        textElement.style.color = '#FF3D00';
                    }
                }
            },
            
            // Setup retracement monitoring
            setupRetracementMonitoring() {
                setInterval(() => {
                    this.checkRetracements();
                }, 60000);
            },
            
            // Check for retracements
            checkRetracements() {
                const now = Date.now();
                Object.keys(this.assetData).forEach(symbol => {
                    const asset = this.assetData[symbol];
                    const timeSinceUpdate = now - asset.lastUpdate;
                    
                    if (timeSinceUpdate > 300000) {
                        const hasRetracement = Math.random() > 0.7;
                        
                        if (hasRetracement) {
                            const retracement = 0.5 + Math.random() * 2;
                            
                            if (retracement >= this.RSI_RULES.RETRACE_MIN) {
                                this.updateAssetFromRetracement(symbol, retracement);
                            }
                        }
                    }
                });
            },
            
            // Update asset from retracement
            updateAssetFromRetracement(symbol, retracement) {
                const asset = this.assetData[symbol];
                
                // Validate retracement data
                if (retracement < 0 || retracement > 10) {
                    retracement = 1.0;
                }
                
                asset.retracement = parseFloat(retracement.toFixed(1));
                asset.rsi = this.calculateNewRSI(asset.rsi);
                asset.rsi = this.validateRSIData(asset.rsi);
                
                // Determine zone
                if (asset.rsi <= this.RSI_RULES.BUY_MAX) {
                    asset.zone = 'BUY';
                    asset.lastSignal = 'BUY';
                } else if (asset.rsi >= this.RSI_RULES.SELL_MIN) {
                    asset.zone = 'SELL';
                    asset.lastSignal = 'SELL';
                } else {
                    asset.zone = 'BLOCKED';
                    asset.lastSignal = 'BLOCKED';
                }
                
                asset.lastUpdate = Date.now();
                this.evaluateRulesForAsset(symbol);
                
                if (symbol === this.currentAsset) {
                    this.updateAssetDisplay(symbol);
                }
                
                // Log signal update
                this.logSignalUpdate(symbol, asset);
            },
            
            // Validate RSI data
            validateRSIData(rsi) {
                if (rsi < 0 || rsi > 100) {
                    console.warn('Invalid RSI value detected, resetting to 50');
                    return 50;
                }
                return rsi;
            },
            
            // Calculate new RSI
            calculateNewRSI(currentRSI) {
                const change = (Math.random() - 0.5) * 15;
                let newRSI = currentRSI + change;
                newRSI = Math.max(0, Math.min(100, newRSI));
                return parseFloat(newRSI.toFixed(1));
            },
            
            // Log signal update
            logSignalUpdate(symbol, asset) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    symbol: symbol,
                    rsi: asset.rsi,
                    zone: asset.zone,
                    retracement: asset.retracement,
                    signal: asset.lastSignal
                };
                
                console.log('Signal Update:', logEntry);
                
                // Could save to localStorage for persistence
                try {
                    const logs = JSON.parse(localStorage.getItem('kz_signalLogs') || '[]');
                    logs.push(logEntry);
                    if (logs.length > 100) logs.shift();
                    localStorage.setItem('kz_signalLogs', JSON.stringify(logs));
                } catch (e) {
                    // Silently fail if storage is full
                }
            },
            
            // Export signals (for future enhancement)
            exportSignals() {
                try {
                    const logs = JSON.parse(localStorage.getItem('kz_signalLogs') || '[]');
                    const csv = this.convertToCSV(logs);
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'killerzone_signals.csv';
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (e) {
                    console.log('Export not available');
                }
            },
            
            // Convert to CSV
            convertToCSV(logs) {
                const headers = ['Timestamp', 'Symbol', 'RSI', 'Zone', 'Retracement', 'Signal'];
                const rows = logs.map(log => [
                    log.timestamp,
                    log.symbol,
                    log.rsi,
                    log.zone,
                    log.retracement,
                    log.signal
                ]);
                
                return [headers, ...rows].map(row => row.join(',')).join('\n');
            },
            
            // Evaluate rules for asset
            evaluateRulesForAsset(symbol) {
                const asset = this.assetData[symbol];
                
                // Rule 1: STRICT RSI Check
                asset.rules.rsi = (asset.rsi <= this.RSI_RULES.BUY_MAX) || 
                                  (asset.rsi >= this.RSI_RULES.SELL_MIN);
                
                // Rule 2: Retracement >1%
                asset.rules.retracement = asset.retracement >= this.RSI_RULES.RETRACE_MIN;
                
                // Rule 3: Daily Trend Alignment
                if (asset.zone === 'BUY') {
                    asset.rules.trend = asset.dailyTrend === 'bullish';
                } else if (asset.zone === 'SELL') {
                    asset.rules.trend = asset.dailyTrend === 'bearish';
                } else {
                    asset.rules.trend = false;
                }
                
                // Rule 4: Session Check
                asset.rules.session = this.checkSession();
                
                // Rule 5: No Conflicts
                asset.rules.conflicts = this.checkConflicts(symbol);
            },
            
            // Check conflicts with other assets
            checkConflicts(currentSymbol) {
                // Simple conflict check - no opposing signals on correlated assets
                const currentAsset = this.assetData[currentSymbol];
                if (!currentAsset || currentAsset.zone === 'BLOCKED') return true;
                
                // Example: If NAS100 is SELL, US30 shouldn't be BUY (correlated)
                if (currentSymbol === 'NAS100' && currentAsset.zone === 'SELL') {
                    const us30 = this.assetData['US30'];
                    if (us30 && us30.zone === 'BUY') return false;
                }
                
                if (currentSymbol === 'US30' && currentAsset.zone === 'BUY') {
                    const nas100 = this.assetData['NAS100'];
                    if (nas100 && nas100.zone === 'SELL') return false;
                }
                
                return true;
            },
            
            // Check session
            checkSession() {
                const now = new Date();
                const hour = now.getUTCHours();
                
                if (this.currentSession === 'ny') {
                    return hour >= 13 && hour < 22;
                } else if (this.currentSession === 'london') {
                    return hour >= 7 && hour < 16;
                } else {
                    return true;
                }
            },
            
            // Setup event listeners
            setupEventListeners() {
                // Asset selection
                document.querySelectorAll('.asset-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const assetSymbol = item.getAttribute('data-asset');
                        this.selectAsset(assetSymbol);
                        e.stopPropagation();
                    });
                });
                
                // Timeframe selection
                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const timeframe = btn.getAttribute('data-tf');
                        this.selectTimeframe(timeframe, btn);
                        e.stopPropagation();
                    });
                });
                
                // Session selection
                document.querySelectorAll('.session-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const session = btn.getAttribute('data-session');
                        this.selectSession(session, btn);
                        e.stopPropagation();
                    });
                });
                
                // Mobile menu toggle
                const menuToggle = document.getElementById('mobile-menu-toggle');
                if (menuToggle) {
                    menuToggle.addEventListener('click', (e) => {
                        const assetsPanel = document.getElementById('assets-panel');
                        assetsPanel.style.display = assetsPanel.style.display === 'none' ? 'block' : 'none';
                        e.stopPropagation();
                    });
                }
                
                // Close mobile menu when clicking outside
                document.addEventListener('click', () => {
                    const assetsPanel = document.getElementById('assets-panel');
                    if (window.innerWidth <= 576 && assetsPanel.style.display === 'block') {
                        assetsPanel.style.display = 'none';
                    }
                });
                
                // Prevent menu close when clicking inside
                const assetsPanel = document.getElementById('assets-panel');
                if (assetsPanel) {
                    assetsPanel.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                }
            },
            
            // Select asset
            selectAsset(assetSymbol) {
                document.querySelectorAll('.asset-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const selectedItem = document.querySelector(`.asset-item[data-asset="${assetSymbol}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('active');
                }
                
                this.loadAsset(assetSymbol);
            },
            
            // Load asset
            loadAsset(assetSymbol) {
                this.currentAsset = assetSymbol;
                const asset = this.assetData[assetSymbol];
                
                if (!asset) return;
                
                // Update UI
                document.getElementById('current-chart-title').textContent = 
                    `${asset.name} (${asset.symbol}) - STRICT RSI 20/80`;
                
                this.updateAssetDisplay(assetSymbol);
                this.updateRulesPanel(assetSymbol);
                this.updateCharts(asset);
                
                // Save state
                this.saveDashboardState();
            },
            
            // Update asset display
            updateAssetDisplay(symbol) {
                const asset = this.assetData[symbol];
                if (!asset) return;
                
                // Update RSI display
                const rsiElement = document.getElementById(`rsi-${symbol.toLowerCase()}`);
                const retraceElement = document.getElementById(`retrace-${symbol.toLowerCase()}`);
                
                if (rsiElement) {
                    rsiElement.textContent = `RSI ${asset.rsi}`;
                    rsiElement.className = 'rsi-display';
                    rsiElement.classList.add(`rsi-${asset.zone.toLowerCase()}`);
                }
                
                if (retraceElement) {
                    retraceElement.textContent = `Retrace: ${asset.retracement}%`;
                }
                
                // Update item
                const item = document.querySelector(`.asset-item[data-asset="${symbol}"]`);
                if (item) {
                    item.classList.remove('buy', 'sell', 'no-trade', 'blocked', 'active');
                    
                    if (asset.zone === 'BUY') item.classList.add('buy');
                    else if (asset.zone === 'SELL') item.classList.add('sell');
                    else item.classList.add('blocked');
                    
                    const signalBadge = item.querySelector('.asset-signal');
                    if (signalBadge) {
                        signalBadge.className = 'asset-signal';
                        
                        if (asset.zone === 'BUY') {
                            signalBadge.classList.add('signal-buy');
                            signalBadge.textContent = 'BUY SIGNAL';
                        } else if (asset.zone === 'SELL') {
                            signalBadge.classList.add('signal-sell');
                            signalBadge.textContent = 'SELL SIGNAL';
                        } else {
                            signalBadge.classList.add('signal-blocked');
                            signalBadge.textContent = 'RSI 21-79 BLOCKED';
                        }
                    }
                }
            },
            
            // Update rules panel
            updateRulesPanel(symbol) {
                const asset = this.assetData[symbol];
                if (!asset) return;
                
                document.getElementById('last-update').textContent = 
                    `Retrace: ${asset.retracement}%`;
                
                this.updateRuleDisplay('rsi', asset.rules.rsi, 
                    `RSI: ${asset.rsi} (${asset.zone} ZONE)`);
                
                this.updateRuleDisplay('retracement', asset.rules.retracement,
                    `Retracement: ${asset.retracement}%`);
                
                this.updateRuleDisplay('trend', asset.rules.trend,
                    `D1: ${asset.dailyTrend === 'bullish' ? 'Bullish ↑' : 
                          asset.dailyTrend === 'bearish' ? 'Bearish ↓' : 'Neutral →'}`);
                
                this.updateRuleDisplay('session', asset.rules.session,
                    `${this.currentSession.toUpperCase()} Session ${asset.rules.session ? 'Active' : 'Inactive'}`);
                
                this.updateRuleDisplay('conflicts', asset.rules.conflicts,
                    asset.rules.conflicts ? 'No Conflicts ✓' : 'Conflict Detected');
                
                this.updateFinalDecision(asset);
            },
            
            // Update rule display
            updateRuleDisplay(ruleName, passed, reason) {
                const ruleElement = document.getElementById(`rule-${ruleName}`);
                const reasonElement = document.getElementById(`reason-${ruleName}`);
                
                if (ruleElement) {
                    ruleElement.textContent = passed ? 'PASSED' : 'BLOCKED';
                    ruleElement.className = 'rule-status';
                    ruleElement.classList.add(passed ? 'status-passed' : 'status-blocked');
                }
                
                if (reasonElement) {
                    reasonElement.textContent = reason;
                }
            },
            
            // Update final decision
            updateFinalDecision(asset) {
                const decisionElement = document.getElementById('final-decision');
                const reasonElement = document.getElementById('decision-reason');
                
                if (asset.zone === 'BUY' && Object.values(asset.rules).every(r => r)) {
                    decisionElement.textContent = '✅ BUY SIGNAL CONFIRMED';
                    decisionElement.style.color = 'var(--buy-green)';
                    reasonElement.textContent = 
                        `All 5 strict rules passed. RSI at ${asset.rsi} (≤20 BUY zone) with ${asset.retracement}% retracement.`;
                } else if (asset.zone === 'SELL' && Object.values(asset.rules).every(r => r)) {
                    decisionElement.textContent = '✅ SELL SIGNAL CONFIRMED';
                    decisionElement.style.color = 'var(--sell-red)';
                    reasonElement.textContent = 
                        `All 5 strict rules passed. RSI at ${asset.rsi} (≥80 SELL zone) with ${asset.retracement}% retracement.`;
                } else {
                    decisionElement.textContent = '⛔ NO TRADE SIGNAL';
                    decisionElement.style.color = 'var(--no-trade-orange)';
                    
                    const failedRules = [];
                    if (!asset.rules.rsi) failedRules.push('RSI not in BUY/SELL zone');
                    if (!asset.rules.retracement) failedRules.push('Insufficient retracement');
                    if (!asset.rules.trend) failedRules.push('Daily trend misaligned');
                    if (!asset.rules.session) failedRules.push('Outside trading session');
                    if (!asset.rules.conflicts) failedRules.push('Conflicting signals');
                    
                    reasonElement.textContent = `Blocked by: ${failedRules.join(', ')}`;
                }
            },
            
            // Select timeframe
            selectTimeframe(timeframe, button) {
                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                button.classList.add('active');
                this.currentTimeframe = timeframe;
                
                // Save state
                this.saveDashboardState();
            },
            
            // Select session
            selectSession(session, button) {
                document.querySelectorAll('.session-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                button.classList.add('active');
                this.currentSession = session;
                
                // Re-evaluate session rule
                const asset = this.assetData[this.currentAsset];
                asset.rules.session = this.checkSession();
                this.updateRulesPanel(this.currentAsset);
                
                // Save state
                this.saveDashboardState();
            }
        };
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            StrictRSIDashboard.init();
        });
    </script>
</body>
</html>
