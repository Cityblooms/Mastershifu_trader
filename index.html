<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KILLER ZONE - Smart Candle-Based Trading</title>
    <style>
        :root {
            --bg-dark: #0b102a;
            --bg-panel: #121a3a;
            --accent-gold: #FFD700;
            --buy-green: #00C853;
            --sell-red: #FF3D00;
            --no-trade-orange: #FF9800;
            --pending-blue: #2196F3;
            --text-white: #FFFFFF;
            --text-gray: #CCCCCC;
            --border-radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-white);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Candle Timer */
        .candle-timer {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--accent-gold);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 0.8rem;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .timer-progress {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .timer-fill {
            height: 100%;
            background: var(--accent-gold);
            width: 0%;
            transition: width 1s linear;
        }
        
        /* Main Container */
        .dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 10px;
            gap: 10px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .dashboard-header {
            background: var(--bg-panel);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid var(--accent-gold);
        }
        
        .dashboard-header h1 {
            color: var(--accent-gold);
            margin-bottom: 5px;
            font-size: 1.5rem;
        }
        
        .dashboard-header p {
            color: var(--text-gray);
            font-size: 0.85rem;
        }
        
        .signal-persistence {
            display: inline-block;
            background: rgba(255, 215, 0, 0.1);
            color: var(--accent-gold);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 8px;
            font-weight: bold;
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            min-height: 0;
        }
        
        @media (min-width: 992px) {
            .main-content {
                flex-direction: row;
            }
        }
        
        /* Assets Panel */
        .assets-panel {
            background: var(--bg-panel);
            border-radius: var(--border-radius);
            padding: 15px;
            order: 2;
            min-width: 0;
        }
        
        @media (min-width: 992px) {
            .assets-panel {
                width: 320px;
                order: 1;
            }
        }
        
        .assets-panel h2 {
            color: var(--accent-gold);
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
        }
        
        .asset-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .asset-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            position: relative;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        
        .asset-item.active {
            border-color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.1);
        }
        
        .asset-item.buy {
            border-left: 4px solid var(--buy-green);
        }
        
        .asset-item.sell {
            border-left: 4px solid var(--sell-red);
        }
        
        .asset-item.pending {
            border-left: 4px solid var(--pending-blue);
        }
        
        .asset-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-white);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .rsi-display {
            font-size: 0.85rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .rsi-buy {
            background: rgba(0, 200, 83, 0.2);
            color: var(--buy-green);
        }
        
        .rsi-sell {
            background: rgba(255, 61, 0, 0.2);
            color: var(--sell-red);
        }
        
        .rsi-neutral {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-gray);
        }
        
        .asset-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            font-size: 0.75rem;
        }
        
        .asset-signal {
            font-size: 0.75rem;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .signal-buy {
            background: rgba(0, 200, 83, 0.2);
            color: var(--buy-green);
        }
        
        .signal-sell {
            background: rgba(255, 61, 0, 0.2);
            color: var(--sell-red);
        }
        
        .signal-pending {
            background: rgba(33, 150, 243, 0.2);
            color: var(--pending-blue);
        }
        
        .candle-info {
            font-size: 0.7rem;
            color: var(--text-gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Right Panel */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 0;
            order: 1;
        }
        
        @media (min-width: 992px) {
            .right-panel {
                order: 2;
            }
        }
        
        /* Chart Container */
        .chart-container {
            background: var(--bg-panel);
            border-radius: var(--border-radius);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 300px;
            position: relative;
        }
        
        .chart-header {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        @media (min-width: 576px) {
            .chart-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .chart-title {
            font-size: 1.1rem;
            color: var(--text-white);
            font-weight: 600;
        }
        
        .chart-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .timeframe-selector {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 3px;
        }
        
        .timeframe-btn {
            padding: 5px 10px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
            min-width: 40px;
        }
        
        .timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .timeframe-btn.active {
            background: var(--accent-gold);
            color: var(--bg-dark);
            font-weight: 600;
        }
        
        .chart-display {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 250px;
        }
        
        #tradingview_chart {
            width: 100%;
            height: 100%;
        }
        
        /* Signal Panel */
        .signal-panel {
            background: var(--bg-panel);
            border-radius: var(--border-radius);
            padding: 15px;
        }
        
        .signal-panel h3 {
            color: var(--accent-gold);
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .signal-display {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .signal-main {
            text-align: center;
            padding: 15px;
            border-radius: var(--border-radius);
            background: rgba(255, 255, 255, 0.05);
            position: relative;
        }
        
        .signal-type {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .signal-type.buy { color: var(--buy-green); }
        .signal-type.sell { color: var(--sell-red); }
        .signal-type.pending { color: var(--pending-blue); }
        
        .signal-asset {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .signal-meta {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 8px;
            font-size: 0.8rem;
        }
        
        .signal-confidence {
            color: var(--accent-gold);
            font-weight: bold;
        }
        
        .signal-details {
            font-size: 0.85rem;
            color: var(--text-gray);
            line-height: 1.4;
        }
        
        /* Next Candle Prediction */
        .prediction-panel {
            background: var(--bg-panel);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 10px;
        }
        
        .prediction-panel h4 {
            color: var(--accent-gold);
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }
        
        .prediction-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 4px;
        }
        
        .prediction-label {
            font-size: 0.7rem;
            color: var(--text-gray);
            margin-bottom: 3px;
        }
        
        .prediction-value {
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .prediction-buy {
            color: var(--buy-green);
        }
        
        .prediction-sell {
            color: var(--sell-red);
        }
        
        /* Footer */
        .dashboard-footer {
            text-align: center;
            padding: 12px;
            color: var(--text-gray);
            font-size: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 576px) {
            .dashboard-container {
                padding: 8px;
            }
            
            .chart-header {
                padding: 10px;
            }
            
            .timeframe-selector {
                flex-wrap: nowrap;
                overflow-x: auto;
                padding: 2px;
            }
            
            .timeframe-btn {
                padding: 4px 8px;
                font-size: 0.75rem;
                min-width: 35px;
            }
            
            .prediction-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    <!-- TradingView Charting Library -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Candle Timer -->
    <div class="candle-timer" id="candle-timer">
        <i class="fas fa-clock"></i>
        <div>
            <div style="font-size: 0.7rem; color: var(--text-gray);">Next Candle</div>
            <div id="timer-text">00:45</div>
        </div>
        <div class="timer-progress">
            <div class="timer-fill" id="timer-fill"></div>
        </div>
    </div>
    
    <!-- Main Dashboard -->
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <h1><i class="fas fa-bolt"></i> KILLER ZONE - SMART CANDLE UPDATES</h1>
            <p>Signals Update on Candle Close • Signal Persistence • Next Candle Prediction</p>
            <div class="signal-persistence">SIGNALS PERSIST UNTIL INVALIDATED</div>
        </header>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel - Assets -->
            <div class="assets-panel">
                <h2>ASSETS - CANDLE BASED</h2>
                <div class="asset-list">
                    <div class="asset-item active buy" data-asset="XAUUSD">
                        <div class="asset-name">
                            GOLD
                            <span class="rsi-display rsi-buy">RSI 19.2</span>
                        </div>
                        <div class="asset-signal signal-buy">STRONG BUY</div>
                        <div class="asset-meta">
                            <span class="candle-info">
                                <i class="fas fa-candle"></i>
                                <span id="candle-xauusd">15M: 4/5</span>
                            </span>
                            <span style="color: var(--buy-green);">Active: 3 candles</span>
                        </div>
                    </div>
                    
                    <div class="asset-item buy" data-asset="BTCUSD">
                        <div class="asset-name">
                            BITCOIN
                            <span class="rsi-display rsi-buy">RSI 18.7</span>
                        </div>
                        <div class="asset-signal signal-buy">STRONG BUY</div>
                        <div class="asset-meta">
                            <span class="candle-info">
                                <i class="fas fa-candle"></i>
                                <span id="candle-btcusd">15M: 2/5</span>
                            </span>
                            <span style="color: var(--buy-green);">Active: 2 candles</span>
                        </div>
                    </div>
                    
                    <div class="asset-item sell" data-asset="EURUSD">
                        <div class="asset-name">
                            EUR/USD
                            <span class="rsi-display rsi-sell">RSI 81.5</span>
                        </div>
                        <div class="asset-signal signal-sell">STRONG SELL</div>
                        <div class="asset-meta">
                            <span class="candle-info">
                                <i class="fas fa-candle"></i>
                                <span id="candle-eurusd">15M: 3/5</span>
                            </span>
                            <span style="color: var(--sell-red);">Active: 3 candles</span>
                        </div>
                    </div>
                    
                    <div class="asset-item sell" data-asset="NAS100">
                        <div class="asset-name">
                            NASDAQ 100
                            <span class="rsi-display rsi-sell">RSI 83.2</span>
                        </div>
                        <div class="asset-signal signal-sell">STRONG SELL</div>
                        <div class="asset-meta">
                            <span class="candle-info">
                                <i class="fas fa-candle"></i>
                                <span id="candle-nas100">15M: 1/5</span>
                            </span>
                            <span style="color: var(--sell-red);">Active: 1 candle</span>
                        </div>
                    </div>
                    
                    <div class="asset-item buy" data-asset="US30">
                        <div class="asset-name">
                            US30 (DOW)
                            <span class="rsi-display rsi-buy">RSI 17.8</span>
                        </div>
                        <div class="asset-signal signal-buy">STRONG BUY</div>
                        <div class="asset-meta">
                            <span class="candle-info">
                                <i class="fas fa-candle"></i>
                                <span id="candle-us30">15M: 5/5</span>
                            </span>
                            <span style="color: var(--buy-green);">Active: 5 candles</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel - Chart & Analysis -->
            <div class="right-panel">
                <!-- Chart Container -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title" id="current-chart-title">GOLD (XAUUSD) - 15M Chart</div>
                        <div class="chart-controls">
                            <div class="timeframe-selector">
                                <button class="timeframe-btn" data-tf="1">1M</button>
                                <button class="timeframe-btn" data-tf="5">5M</button>
                                <button class="timeframe-btn active" data-tf="15">15M</button>
                                <button class="timeframe-btn" data-tf="60">1H</button>
                                <button class="timeframe-btn" data-tf="240">4H</button>
                                <button class="timeframe-btn" data-tf="D">D</button>
                            </div>
                        </div>
                    </div>
                    <div class="chart-display">
                        <div id="tradingview_chart"></div>
                    </div>
                </div>
                
                <!-- Signal Panel -->
                <div class="signal-panel">
                    <h3>
                        ACTIVE SIGNAL
                        <span style="font-size: 0.8rem; color: var(--text-gray);" id="signal-age">Active for 45 min</span>
                    </h3>
                    <div class="signal-display">
                        <div class="signal-main">
                            <div class="signal-type buy" id="signal-type">STRONG BUY</div>
                            <div class="signal-asset" id="signal-asset">GOLD (XAUUSD) - 15M</div>
                            <div class="signal-meta">
                                <span class="signal-confidence" id="signal-confidence">92% Confidence</span>
                                <span style="color: var(--text-gray);" id="signal-candles">Candles: 3/5</span>
                            </div>
                        </div>
                        <div class="signal-details" id="signal-details">
                            Signal active for 3 consecutive candles. RSI holding below 20, maintaining extreme oversold conditions. Bullish divergence forming. Signal persists until RSI crosses above 30.
                        </div>
                    </div>
                </div>
                
                <!-- Next Candle Prediction -->
                <div class="prediction-panel">
                    <h4><i class="fas fa-crystal-ball"></i> NEXT CANDLE PREDICTION</h4>
                    <div class="prediction-grid">
                        <div class="prediction-item">
                            <div class="prediction-label">Direction</div>
                            <div class="prediction-value prediction-buy" id="pred-direction">BULLISH</div>
                        </div>
                        <div class="prediction-item">
                            <div class="prediction-label">Probability</div>
                            <div class="prediction-value" id="pred-probability">78%</div>
                        </div>
                        <div class="prediction-item">
                            <div class="prediction-label">Target RSI</div>
                            <div class="prediction-value" id="pred-target-rsi">21-25</div>
                        </div>
                        <div class="prediction-item">
                            <div class="prediction-label">Invalidation</div>
                            <div class="prediction-value" id="pred-invalidation">RSI > 30</div>
                        </div>
                        <div class="prediction-item">
                            <div class="prediction-label">Next Update</div>
                            <div class="prediction-value" id="pred-next-update">00:45</div>
                        </div>
                        <div class="prediction-item">
                            <div class="prediction-label">Status</div>
                            <div class="prediction-value" id="pred-status">WAITING CANDLE</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="dashboard-footer">
            <div>© 2023 KILLER ZONE Trading System | Signals persist until invalidation</div>
            <div style="margin-top: 4px; font-size: 0.7rem; color: var(--accent-gold);">
                Updates on candle close only • No conflicting signals • Next candle prediction
            </div>
        </footer>
    </div>

    <script>
        // Smart Candle-Based Trading Dashboard
        const SmartCandleDashboard = {
            // Current state
            currentAsset: 'XAUUSD',
            currentTimeframe: '15',
            tvWidget: null,
            candleTimer: null,
            activeSignals: {},
            
            // Timeframe durations in milliseconds
            timeframeDurations: {
                '1': 60000,     // 1 minute
                '5': 300000,    // 5 minutes
                '15': 900000,   // 15 minutes
                '60': 3600000,  // 1 hour
                '240': 14400000,// 4 hours
                'D': 86400000   // 1 day
            },
            
            // Assets with initial states
            assets: {
                XAUUSD: {
                    name: 'GOLD',
                    symbol: 'XAUUSD',
                    tradingViewSymbol: 'FX_IDC:XAUUSD',
                    currentRSI: 19.2,
                    currentSignal: 'STRONG_BUY',
                    signalStart: Date.now() - (900000 * 3), // 3 candles ago
                    activeCandles: 3,
                    confidence: 92,
                    invalidated: false,
                    invalidationLevel: 30, // RSI > 30 invalidates BUY
                    analysis: 'Signal active for 3 consecutive candles. RSI holding below 20, maintaining extreme oversold conditions. Bullish divergence forming. Signal persists until RSI crosses above 30.'
                },
                BTCUSD: {
                    name: 'BITCOIN',
                    symbol: 'BTCUSD',
                    tradingViewSymbol: 'BITSTAMP:BTCUSD',
                    currentRSI: 18.7,
                    currentSignal: 'STRONG_BUY',
                    signalStart: Date.now() - (900000 * 2),
                    activeCandles: 2,
                    confidence: 89,
                    invalidated: false,
                    invalidationLevel: 30,
                    analysis: 'RSI holding below 20 for 2 candles. Strong support at 42,000. Signal active until RSI crosses 30.'
                },
                EURUSD: {
                    name: 'EUR/USD',
                    symbol: 'EURUSD',
                    tradingViewSymbol: 'FX:EURUSD',
                    currentRSI: 81.5,
                    currentSignal: 'STRONG_SELL',
                    signalStart: Date.now() - (900000 * 3),
                    activeCandles: 3,
                    confidence: 91,
                    invalidated: false,
                    invalidationLevel: 70, // RSI < 70 invalidates SELL
                    analysis: 'RSI above 80 for 3 candles. Bearish pressure maintaining. Signal active until RSI drops below 70.'
                },
                NAS100: {
                    name: 'NASDAQ 100',
                    symbol: 'NAS100',
                    tradingViewSymbol: 'NASDAQ:NDX',
                    currentRSI: 83.2,
                    currentSignal: 'STRONG_SELL',
                    signalStart: Date.now() - 900000,
                    activeCandles: 1,
                    confidence: 88,
                    invalidated: false,
                    invalidationLevel: 70,
                    analysis: 'RSI just crossed above 80. First candle of SELL signal. Watching for confirmation.'
                },
                US30: {
                    name: 'US30 (DOW)',
                    symbol: 'US30',
                    tradingViewSymbol: 'DOWI:DJI',
                    currentRSI: 17.8,
                    currentSignal: 'STRONG_BUY',
                    signalStart: Date.now() - (900000 * 5),
                    activeCandles: 5,
                    confidence: 94,
                    invalidated: false,
                    invalidationLevel: 30,
                    analysis: 'Strong BUY signal active for 5 consecutive candles. Extreme oversold conditions. Signal very strong.'
                }
            },
            
            // Initialize dashboard
            async init() {
                console.log('Initializing Smart Candle Dashboard...');
                
                // Setup candle timer
                this.setupCandleTimer();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Load TradingView chart
                await this.loadTradingViewChart();
                
                // Initialize displays
                this.updateAllDisplays();
                this.updatePredictions();
                
                // Start candle-based updates
                this.startCandleUpdates();
                
                console.log('Smart Candle Dashboard ready');
            },
            
            // Setup candle timer
            setupCandleTimer() {
                this.updateTimer();
                setInterval(() => this.updateTimer(), 1000);
            },
            
            // Update candle timer display
            updateTimer() {
                const now = new Date();
                const timeframeMs = this.timeframeDurations[this.currentTimeframe];
                
                // Calculate time until next candle
                let nextCandleTime;
                if (this.currentTimeframe === 'D') {
                    // For daily candles, next candle at 00:00 UTC
                    const tomorrow = new Date(now);
                    tomorrow.setUTCHours(0, 0, 0, 0);
                    tomorrow.setUTCDate(tomorrow.getUTCDate() + 1);
                    nextCandleTime = tomorrow.getTime();
                } else {
                    // For intraday candles
                    const timeframeMinutes = parseInt(this.currentTimeframe);
                    const currentMinute = now.getUTCMinutes();
                    const minutesPast = currentMinute % timeframeMinutes;
                    const minutesToNext = timeframeMinutes - minutesPast;
                    
                    nextCandleTime = now.getTime() + (minutesToNext * 60000);
                    nextCandleTime = Math.floor(nextCandleTime / 1000) * 1000; // Round to second
                }
                
                const timeRemaining = nextCandleTime - now.getTime();
                const secondsRemaining = Math.floor(timeRemaining / 1000);
                const minutes = Math.floor(secondsRemaining / 60);
                const seconds = secondsRemaining % 60;
                
                // Update timer display
                document.getElementById('timer-text').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Update progress bar
                const progress = 100 - ((timeRemaining / timeframeMs) * 100);
                document.getElementById('timer-fill').style.width = `${Math.min(100, Math.max(0, progress))}%`;
            },
            
            // Start candle-based updates
            startCandleUpdates() {
                const timeframeMs = this.timeframeDurations[this.currentTimeframe];
                
                // Schedule updates for each candle close
                this.candleTimer = setInterval(() => {
                    this.onCandleClose();
                }, timeframeMs);
                
                // Align with actual candle close times
                setTimeout(() => {
                    clearInterval(this.candleTimer);
                    this.startCandleUpdates();
                }, this.getTimeToNextCandle());
            },
            
            // Get time to next candle in milliseconds
            getTimeToNextCandle() {
                const now = new Date();
                const timeframeMinutes = parseInt(this.currentTimeframe);
                
                if (this.currentTimeframe === 'D') {
                    const tomorrow = new Date(now);
                    tomorrow.setUTCHours(0, 0, 0, 0);
                    tomorrow.setUTCDate(tomorrow.getUTCDate() + 1);
                    return tomorrow.getTime() - now.getTime();
                }
                
                const currentMinute = now.getUTCMinutes();
                const minutesPast = currentMinute % timeframeMinutes;
                const minutesToNext = timeframeMinutes - minutesPast;
                
                return minutesToNext * 60000;
            },
            
            // Handle candle close event
            onCandleClose() {
                console.log(`Candle closed on ${this.currentTimeframe}M timeframe`);
                
                // Update all assets
                this.updateAllAssetsOnCandleClose();
                
                // Update displays
                this.updateAllDisplays();
                this.updatePredictions();
                
                // Update chart if needed
                this.updateChartData();
            },
            
            // Update all assets on candle close
            updateAllAssetsOnCandleClose() {
                Object.keys(this.assets).forEach(symbol => {
                    const asset = this.assets[symbol];
                    
                    if (asset.invalidated) {
                        // Generate new signal if invalidated
                        this.generateNewSignal(asset);
                    } else {
                        // Update existing signal
                        this.updateExistingSignal(asset);
                    }
                });
            },
            
            // Update existing signal (check for invalidation)
            updateExistingSignal(asset) {
                // Increment candle count
                asset.activeCandles++;
                
                // Simulate RSI movement (realistic, not random)
                const movement = this.calculateRSIMovement(asset);
                asset.currentRSI += movement;
                asset.currentRSI = parseFloat(asset.currentRSI.toFixed(1));
                
                // Check for invalidation
                if (asset.currentSignal.includes('BUY') && asset.currentRSI > asset.invalidationLevel) {
                    asset.invalidated = true;
                    console.log(`${asset.symbol} BUY signal invalidated (RSI: ${asset.currentRSI})`);
                } else if (asset.currentSignal.includes('SELL') && asset.currentRSI < asset.invalidationLevel) {
                    asset.invalidated = true;
                    console.log(`${asset.symbol} SELL signal invalidated (RSI: ${asset.currentRSI})`);
                } else {
                    // Signal still valid, update confidence
                    asset.confidence = this.calculateConfidence(asset);
                }
                
                // Update analysis
                asset.analysis = this.generateAnalysis(asset);
            },
            
            // Generate new signal when invalidated
            generateNewSignal(asset) {
                // Generate new RSI based on previous trend
                let newRSI;
                if (asset.currentSignal.includes('BUY')) {
                    // Was BUY, now might go to SELL or neutral
                    newRSI = 40 + (Math.random() * 40); // 40-80
                } else {
                    // Was SELL, now might go to BUY or neutral
                    newRSI = 20 + (Math.random() * 40); // 20-60
                }
                
                asset.currentRSI = parseFloat(newRSI.toFixed(1));
                
                // Generate new signal
                if (asset.currentRSI <= 20) {
                    asset.currentSignal = 'STRONG_BUY';
                    asset.invalidationLevel = 30;
                } else if (asset.currentRSI <= 30) {
                    asset.currentSignal = 'BUY';
                    asset.invalidationLevel = 35;
                } else if (asset.currentRSI >= 80) {
                    asset.currentSignal = 'STRONG_SELL';
                    asset.invalidationLevel = 70;
                } else if (asset.currentRSI >= 70) {
                    asset.currentSignal = 'SELL';
                    asset.invalidationLevel = 65;
                } else {
                    // No clear signal
                    asset.currentSignal = Math.random() > 0.5 ? 'WATCH_BUY' : 'WATCH_SELL';
                    asset.invalidationLevel = asset.currentRSI > 50 ? 55 : 45;
                }
                
                // Reset signal tracking
                asset.signalStart = Date.now();
                asset.activeCandles = 1;
                asset.invalidated = false;
                asset.confidence = this.calculateConfidence(asset);
                asset.analysis = this.generateAnalysis(asset);
                
                console.log(`${asset.symbol} new signal: ${asset.currentSignal} (RSI: ${asset.currentRSI})`);
            },
            
            // Calculate realistic RSI movement
            calculateRSIMovement(asset) {
                let movement = 0;
                
                if (asset.currentSignal.includes('STRONG_BUY')) {
                    // Strong BUY: RSI likely to rise slowly from oversold
                    movement = (Math.random() * 3) - 1; // -1 to +2
                } else if (asset.currentSignal.includes('STRONG_SELL')) {
                    // Strong SELL: RSI likely to fall slowly from overbought
                    movement = (Math.random() * -3) + 1; // -2 to +1
                } else if (asset.currentSignal.includes('BUY')) {
                    // Moderate BUY: RSI rising
                    movement = Math.random() * 2; // 0 to +2
                } else if (asset.currentSignal.includes('SELL')) {
                    // Moderate SELL: RSI falling
                    movement = Math.random() * -2; // -2 to 0
                } else {
                    // Neutral: random small movement
                    movement = (Math.random() * 4) - 2; // -2 to +2
                }
                
                // Add some randomness but keep trend
                return parseFloat(movement.toFixed(1));
            },
            
            // Calculate confidence based on signal strength and duration
            calculateConfidence(asset) {
                let baseConfidence = 50;
                
                if (asset.currentSignal.includes('STRONG')) {
                    baseConfidence = 85;
                    // Longer duration increases confidence
                    baseConfidence += Math.min(10, asset.activeCandles * 2);
                } else if (asset.currentSignal.includes('BUY') || asset.currentSignal.includes('SELL')) {
                    baseConfidence = 75;
                    baseConfidence += Math.min(15, asset.activeCandles * 3);
                }
                
                // Extreme RSI values get extra confidence
                if (asset.currentRSI <= 15 || asset.currentRSI >= 85) {
                    baseConfidence += 5;
                }
                
                return Math.min(99, Math.max(60, Math.round(baseConfidence)));
            },
            
            // Generate analysis text
            generateAnalysis(asset) {
                const duration = Math.floor((Date.now() - asset.signalStart) / 60000);
                const minutes = duration % 60;
                const hours = Math.floor(duration / 60);
                
                let timeText = '';
                if (hours > 0) {
                    timeText = `${hours}h ${minutes}m`;
                } else {
                    timeText = `${minutes}m`;
                }
                
                if (asset.currentSignal.includes('STRONG_BUY')) {
                    return `STRONG BUY signal active for ${asset.activeCandles} candles (${timeText}). RSI at ${asset.currentRSI} (extreme oversold). Signal persists until RSI crosses above ${asset.invalidationLevel}.`;
                } else if (asset.currentSignal.includes('STRONG_SELL')) {
                    return `STRONG SELL signal active for ${asset.activeCandles} candles (${timeText}). RSI at ${asset.currentRSI} (extreme overbought). Signal persists until RSI drops below ${asset.invalidationLevel}.`;
                } else if (asset.currentSignal.includes('BUY')) {
                    return `BUY signal active for ${asset.activeCandles} candles (${timeText}). RSI at ${asset.currentRSI} (oversold). Watching for continuation.`;
                } else if (asset.currentSignal.includes('SELL')) {
                    return `SELL signal active for ${asset.activeCandles} candles (${timeText}). RSI at ${asset.currentRSI} (overbought). Monitoring for breakdown.`;
                } else {
                    return `Monitoring ${asset.symbol}. RSI at ${asset.currentRSI} (neutral). Waiting for clear signal.`;
                }
            },
            
            // Update all displays
            updateAllDisplays() {
                Object.keys(this.assets).forEach(symbol => {
                    this.updateAssetDisplay(symbol);
                });
                
                // Update current asset display
                this.updateCurrentAssetDisplay();
            },
            
            // Update asset display
            updateAssetDisplay(symbol) {
                const asset = this.assets[symbol];
                const item = document.querySelector(`.asset-item[data-asset="${symbol}"]`);
                
                if (!item) return;
                
                // Update RSI
                const rsiElement = item.querySelector('.rsi-display');
                if (rsiElement) {
                    rsiElement.textContent = `RSI ${asset.currentRSI}`;
                    rsiElement.className = 'rsi-display';
                    
                    if (asset.currentSignal.includes('BUY')) {
                        rsiElement.classList.add('rsi-buy');
                    } else if (asset.currentSignal.includes('SELL')) {
                        rsiElement.classList.add('rsi-sell');
                    } else {
                        rsiElement.classList.add('rsi-neutral');
                    }
                }
                
                // Update signal
                const signalElement = item.querySelector('.asset-signal');
                if (signalElement) {
                    signalElement.textContent = asset.currentSignal.replace('_', ' ');
                    signalElement.className = 'asset-signal';
                    
                    if (asset.currentSignal.includes('BUY')) {
                        signalElement.classList.add('signal-buy');
                        item.classList.remove('sell', 'pending');
                        item.classList.add('buy');
                    } else if (asset.currentSignal.includes('SELL')) {
                        signalElement.classList.add('signal-sell');
                        item.classList.remove('buy', 'pending');
                        item.classList.add('sell');
                    } else {
                        signalElement.classList.add('signal-pending');
                        item.classList.remove('buy', 'sell');
                        item.classList.add('pending');
                    }
                }
                
                // Update candle info
                const candleElement = document.getElementById(`candle-${symbol.toLowerCase()}`);
                if (candleElement) {
                    candleElement.textContent = `${this.currentTimeframe}M: ${asset.activeCandles}/5`;
                }
                
                // Update active candles text
                const activeElement = item.querySelector('.asset-meta span:last-child');
                if (activeElement) {
                    const color = asset.currentSignal.includes('BUY') ? 'var(--buy-green)' : 
                                 asset.currentSignal.includes('SELL') ? 'var(--sell-red)' : 'var(--text-gray)';
                    activeElement.style.color = color;
                    activeElement.textContent = `Active: ${asset.activeCandles} candle${asset.activeCandles !== 1 ? 's' : ''}`;
                }
            },
            
            // Update current asset display
            updateCurrentAssetDisplay() {
                const asset = this.assets[this.currentAsset];
                if (!asset) return;
                
                // Update signal panel
                document.getElementById('signal-type').textContent = asset.currentSignal.replace('_', ' ');
                document.getElementById('signal-type').className = 'signal-type';
                
                if (asset.currentSignal.includes('BUY')) {
                    document.getElementById('signal-type').classList.add('buy');
                } else if (asset.currentSignal.includes('SELL')) {
                    document.getElementById('signal-type').classList.add('sell');
                } else {
                    document.getElementById('signal-type').classList.add('pending');
                }
                
                document.getElementById('signal-asset').textContent = 
                    `${asset.name} (${asset.symbol}) - ${this.currentTimeframe}M`;
                document.getElementById('signal-confidence').textContent = `${asset.confidence}% Confidence`;
                document.getElementById('signal-candles').textContent = `Candles: ${asset.activeCandles}/5`;
                document.getElementById('signal-details').textContent = asset.analysis;
                
                // Calculate signal age
                const ageMinutes = Math.floor((Date.now() - asset.signalStart) / 60000);
                let ageText = '';
                if (ageMinutes < 60) {
                    ageText = `Active for ${ageMinutes} min`;
                } else {
                    const hours = Math.floor(ageMinutes / 60);
                    const minutes = ageMinutes % 60;
                    ageText = `Active for ${hours}h ${minutes}m`;
                }
                document.getElementById('signal-age').textContent = ageText;
            },
            
            // Update predictions for next candle
            updatePredictions() {
                const asset = this.assets[this.currentAsset];
                if (!asset) return;
                
                let direction, probability, targetRSI, invalidation, status;
                
                if (asset.currentSignal.includes('BUY')) {
                    direction = 'BULLISH';
                    probability = Math.min(95, 70 + (asset.activeCandles * 5));
                    targetRSI = `${Math.min(30, asset.currentRSI + 5)}-${Math.min(35, asset.currentRSI + 10)}`;
                    invalidation = `RSI > ${asset.invalidationLevel}`;
                } else if (asset.currentSignal.includes('SELL')) {
                    direction = 'BEARISH';
                    probability = Math.min(95, 70 + (asset.activeCandles * 5));
                    targetRSI = `${Math.max(70, asset.currentRSI - 10)}-${Math.max(65, asset.currentRSI - 5)}`;
                    invalidation = `RSI < ${asset.invalidationLevel}`;
                } else {
                    direction = 'NEUTRAL';
                    probability = 50;
                    targetRSI = `${asset.currentRSI - 2}-${asset.currentRSI + 2}`;
                    invalidation = 'N/A';
                }
                
                // Get time to next update
                const nextUpdate = this.getTimeToNextCandle() / 1000;
                const minutes = Math.floor(nextUpdate / 60);
                const seconds = Math.floor(nextUpdate % 60);
                const nextUpdateText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                status = asset.invalidated ? 'NEW SIGNAL PENDING' : 'WAITING CANDLE';
                
                // Update prediction display
                document.getElementById('pred-direction').textContent = direction;
                document.getElementById('pred-direction').className = 
                    `prediction-value ${direction === 'BULLISH' ? 'prediction-buy' : direction === 'BEARISH' ? 'prediction-sell' : ''}`;
                document.getElementById('pred-probability').textContent = `${probability}%`;
                document.getElementById('pred-target-rsi').textContent = targetRSI;
                document.getElementById('pred-invalidation').textContent = invalidation;
                document.getElementById('pred-next-update').textContent = nextUpdateText;
                document.getElementById('pred-status').textContent = status;
            },
            
            // Update chart data (simulated)
            updateChartData() {
                // In a real implementation, this would update the TradingView chart
                console.log('Chart data updated for new candle');
            },
            
            // Load TradingView Chart
            async loadTradingViewChart() {
                if (typeof TradingView === 'undefined') {
                    console.error('TradingView script not loaded');
                    return;
                }
                
                const asset = this.assets[this.currentAsset];
                
                // Remove existing widget
                if (this.tvWidget) {
                    this.tvWidget.remove();
                    this.tvWidget = null;
                }
                
                // Create new widget
                this.tvWidget = new TradingView.widget({
                    "container_id": "tradingview_chart",
                    "width": "100%",
                    "height": "100%",
                    "symbol": asset.tradingViewSymbol,
                    "interval": this.currentTimeframe,
                    "timezone": "Etc/UTC",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#121a3a",
                    "enable_publishing": false,
                    "hide_legend": false,
                    "hide_volume": false,
                    "save_image": false,
                    "studies": ["RSI@tv-basicstudies"],
                    "show_popup_button": true,
                    "popup_width": "1000",
                    "popup_height": "650"
                });
            },
            
            // Setup event listeners
            setupEventListeners() {
                // Asset selection
                document.querySelectorAll('.asset-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const assetSymbol = item.getAttribute('data-asset');
                        this.selectAsset(assetSymbol);
                    });
                });
                
                // Timeframe selection
                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const timeframe = btn.getAttribute('data-tf');
                        this.selectTimeframe(timeframe, btn);
                    });
                });
            },
            
            // Select asset
            async selectAsset(assetSymbol) {
                this.currentAsset = assetSymbol;
                
                // Update active state
                document.querySelectorAll('.asset-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const selectedItem = document.querySelector(`.asset-item[data-asset="${assetSymbol}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('active');
                }
                
                // Update displays
                this.updateCurrentAssetDisplay();
                this.updatePredictions();
                
                // Reload chart
                await this.loadTradingViewChart();
            },
            
            // Select timeframe
            async selectTimeframe(timeframe, button) {
                // Update active state
                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                button.classList.add('active');
                this.currentTimeframe = timeframe;
                
                // Restart candle timer with new timeframe
                clearInterval(this.candleTimer);
                this.startCandleUpdates();
                
                // Update displays
                this.updateAllDisplays();
                this.updatePredictions();
                
                // Reload chart
                await this.loadTradingViewChart();
            }
        };
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            SmartCandleDashboard.init();
        });
    </script>
</body>
</html>
